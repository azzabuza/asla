<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>Panel Driver</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="mobile-wrapper">
    <main class="main-content" id="main-content">
      <div class="welcome-container">
        <h1 id="driverName">Memuat...</h1>
        <p>Selamat datang di aplikasi driver SLA Trucking.</p>
      </div>
    </main>
    <nav class="bottom-nav">
      <a href="#" class="nav-item active" data-page="home">
        <i class="fas fa-home"></i>
        <span>Beranda</span>
      </a>
      <a href="#" class="nav-item" data-page="driver-task.html">
        <i class="fas fa-tasks"></i>
        <span>Tugas</span>
      </a>
      <a href="#" class="nav-item" data-page="profile">
        <i class="fas fa-user"></i>
        <span>Profil</span>
      </a>
    </nav>
  </div>

  <script type="module">
    import { auth, onAuthStateChanged, signOut, db, ref, get, update, onDisconnect } from './firebase.js';

    const mainContent = document.getElementById('main-content');
    const navItems = document.querySelectorAll('.nav-item');
    
    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = 'index.html';
      currentUser = user;
      const userRef = ref(db, 'users/' + currentUser.uid);
      const snap = await get(userRef);
      if(snap.exists()){
        const userData = snap.val();
         if (userData.locked || userData.role !== 'driver') {
            alert('Akses Anda telah dinonaktifkan sementara. Anda akan dikeluarkan.');
            signOut(auth);
         }
      }
      await update(userRef, { online: true });
      onDisconnect(ref(db, `users/${user.uid}/online`)).set(false);
      
      // Load home page content after user is authenticated
      loadPage('home');
    });

    async function loadPage(pageUrl) {
        mainContent.innerHTML = '<p class="empty-state">Memuat...</p>'; // Loading state
        if (pageUrl === 'home') {
            mainContent.innerHTML = `
            <div class="welcome-container">
                <h1 id="driverName">Memuat...</h1>
                <p>Selamat datang di aplikasi driver SLA Trucking.</p>
            </div>`;
            const userRef = ref(db, 'users/' + currentUser.uid);
            const snap = await get(userRef);
            if(snap.exists()){
               mainContent.querySelector('#driverName').textContent = `Halo, ${snap.val().name || 'Driver'}!`;
            }
        } else if (pageUrl === 'profile') {
             mainContent.innerHTML = `
             <div class="profile-container card">
                <div class="card-body">
                    <h2>Profil Saya</h2>
                    <p id="profileName">Memuat...</p>
                    <small id="profileEmail">Memuat...</small>
                    <button id="logoutBtn" class="logout-button"><i class="fas fa-sign-out-alt"></i> Keluar</button>
                </div>
             </div>
             `;
             const userRef = ref(db, 'users/' + currentUser.uid);
             const snap = await get(userRef);
             if(snap.exists()){
                const userData = snap.val();
                mainContent.querySelector('#profileName').textContent = userData.name;
                mainContent.querySelector('#profileEmail').textContent = currentUser.email;
             }
             mainContent.querySelector('#logoutBtn').addEventListener('click', async () => {
                if (currentUser) {
                    await update(ref(db, 'users/' + currentUser.uid), { online: false });
                }
                signOut(auth);
            });
        }
        else {
            try {
                const response = await fetch(pageUrl);
                if (!response.ok) throw new Error('Halaman tidak ditemukan');
                const pageHTML = await response.text();
                
                // Use DOMParser to prevent full page reload issues
                const parser = new DOMParser();
                const doc = parser.parseFromString(pageHTML, 'text/html');
                const newContent = doc.body.innerHTML;
                mainContent.innerHTML = newContent;

                // Manually handle scripts from the loaded content
                const scripts = doc.head.querySelectorAll('script'), bodyScripts = doc.body.querySelectorAll('script');
                
                const loadScript = (script) => {
                  return new Promise((resolve, reject) => {
                    const newScript = document.createElement("script");
                    if(script.src){
                      newScript.src = script.src;
                      newScript.onload = resolve;
                      newScript.onerror = reject;
                    } else {
                      newScript.textContent = script.innerHTML;
                       resolve();
                    }
                    if(script.type === 'module') newScript.type = 'module';
                    document.body.appendChild(newScript);
                  });
                };
                
                for(const script of [...scripts, ...bodyScripts]) {
                    await loadScript(script);
                }

            } catch (error) {
                mainContent.innerHTML = `<p class="empty-state">Gagal memuat halaman: ${error.message}</p>`;
            }
        }
    }

    navItems.forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const page = item.dataset.page;
            // Prevent reloading the same page
            if(item.classList.contains('active')) return;
            
            navItems.forEach(nav => nav.classList.remove('active'));
            item.classList.add('active');
            
            loadPage(page);
        });
    });

  </script>
</body>
</html>
