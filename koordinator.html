<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Koordinator Panel</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="content-wrapper">
    <nav class="sidebar">
      <div class="sidebar-header">
        <h3>Input Perjalanan Baru</h3>
      </div>
      <div class="sidebar-form-container">
        <form id="tripForm">
          <div class="form-group">
            <label for="driverSelect">Pilih Sopir</label>
            <select id="driverSelect" required>
              <option value="">Memuat daftar sopir...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="nopol">No. Polisi</label>
            <select id="nopol" required>
              <option value="">Memuat nopol...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="asal">Asal</label>
            <select id="asal" required>
              <option value="">Memuat rute...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="tujuan">Tujuan</label>
            <select id="tujuan" required>
              <option value="">Memuat rute...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="muatan">Muatan</label>
            <input id="muatan" type="text" required>
          </div>
          <div class="form-group">
            <label for="tanggal">Tanggal Keberangkatan</label>
            <input id="tanggal" type="date" required>
          </div>
          <button type="submit">Kirim Data Perjalanan</button>
          <p id="statusMsg" class="form-status"></p>
        </form>
      </div>
      <div class="sidebar-footer">
        <button id="logoutBtn" class="logout-button">Logout</button>
      </div>
    </nav>

    <main class="main-content">
      <header class="main-header">
        <h1>Status Perjalanan Saya</h1>
        <p>Pantau semua perjalanan yang telah Anda buat di sini.</p>
      </header>
      
      <div class="page active">
        <section class="card">
          <h2 class="card-header">Daftar Perjalanan Dibuat</h2>
          <div class="card-body">
            <div class="table-responsive">
              <table>
                <thead>
                  <tr>
                    <th>Rute</th>
                    <th>Sopir</th>
                    <th>No. Polisi</th>
                    <th>Tanggal</th>
                    <th>Status</th>
                    <th>Aksi Cetak</th>
                  </tr>
                </thead>
                <tbody id="tripList">
                  <tr><td colspan="6">Memuat data...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script type="module">
    import { 
      auth, 
      onAuthStateChanged, 
      signOut, 
      db, 
      ref, 
      get, 
      push, 
      set, 
      onValue, 
      query, 
      orderByChild, 
      equalTo,
      update,
      onDisconnect
    } from './firebase.js';
    import { badge, fmtDate, el } from './utils.js';

    const tripForm = document.getElementById('tripForm');
    const tripList = document.getElementById('tripList');
    const driverSelect = document.getElementById('driverSelect');
    const logoutBtn = document.getElementById('logoutBtn');
    const statusMsg = document.getElementById('statusMsg');
    const asalSelect = document.getElementById('asal');
    const tujuanSelect = document.getElementById('tujuan');
    const nopolSelect = document.getElementById('nopol');
    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = 'index.html';
      currentUser = user;
      const userRef = ref(db, 'users/' + currentUser.uid);

      const snap = await get(userRef);
      if (!snap.exists() || snap.val().role !== 'koordinator') {
        alert('Akses ditolak. Hanya untuk koordinator.');
        return window.location.href = 'index.html';
      }
      
      await update(userRef, { lastLogin: Date.now(), online: true });
      onDisconnect(ref(db, `users/${user.uid}/online`)).set(false);

      loadMyTrips();
      loadDrivers(); 
      loadRoutes();
      loadVehicles();
    });

    async function loadVehicles() {
      try {
        const vehiclesRef = ref(db, 'vehicles');
        const snapshot = await get(vehiclesRef);
        
        nopolSelect.innerHTML = '<option value="">-- Pilih Nopol --</option>';

        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const vehicle = child.val();
            const optionText = `${vehicle.nopol} (${vehicle.type})`;
            const option = el('option', optionText, { value: vehicle.nopol });
            nopolSelect.appendChild(option);
          });
        } else {
          nopolSelect.innerHTML = '<option value="">Belum ada nopol</option>';
        }
      } catch (error) {
        console.error("Gagal memuat nopol:", error);
        nopolSelect.innerHTML = '<option value="">Error</option>';
      }
    }

    async function loadRoutes() {
      try {
        const routesRef = ref(db, 'routes');
        const snapshot = await get(routesRef);
        
        asalSelect.innerHTML = '<option value="">-- Pilih Asal --</option>';
        tujuanSelect.innerHTML = '<option value="">-- Pilih Tujuan --</option>';

        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const route = child.val();
            const optionText = `${route.code} - ${route.address}`;
            const option = el('option', optionText, { value: route.address });
            const option2 = option.cloneNode(true);
            asalSelect.appendChild(option);
            tujuanSelect.appendChild(option2);
          });
        } else {
          asalSelect.innerHTML = '<option value="">Belum ada rute</option>';
          tujuanSelect.innerHTML = '<option value="">Belum ada rute</option>';
        }
      } catch (error) {
        console.error("Gagal memuat rute:", error);
        asalSelect.innerHTML = '<option value="">Error</option>';
        tujuanSelect.innerHTML = '<option value="">Error</option>';
      }
    }

    async function loadDrivers() {
        try {
            const usersRef = ref(db, 'users');
            const q = query(usersRef, orderByChild('role'), equalTo('driver'));
            const snapshot = await get(q);
            
            driverSelect.innerHTML = '<option value="">-- Pilih Sopir --</option>';
            
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const driver = child.val();
                    const option = el('option', driver.name, { value: child.key });
                    driverSelect.appendChild(option);
                });
            } else {
                driverSelect.innerHTML = '<option value="">Tidak ada sopir</option>';
            }
        } catch (error) {
            console.error("Gagal memuat daftar sopir:", error);
            driverSelect.innerHTML = '<option value="">Error</option>';
        }
    }

    tripForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusMsg.textContent = 'Mengirim...';
      if (!currentUser) return alert('Anda belum login.');

      const selectedDriverOption = driverSelect.options[driverSelect.selectedIndex];
      const driverId = selectedDriverOption.value;
      const driverName = selectedDriverOption.text;

      if (!driverId) {
        alert('Silakan pilih sopir terlebih dahulu.');
        return;
      }

      const data = {
        koorId: currentUser.uid,
        driverId: driverId,
        driverName: driverName,
        nopol: document.getElementById('nopol').value,
        asal: document.getElementById('asal').value,
        tujuan: document.getElementById('tujuan').value,
        muatan: document.getElementById('muatan').value,
        tanggal: document.getElementById('tanggal').value,
        status: 'submitted',
        createdAt: Date.now()
      };

      try {
        await set(push(ref(db, 'trips')), data);
        tripForm.reset();
        statusMsg.textContent = '✔️ Data berhasil dikirim.';
        setTimeout(() => statusMsg.textContent = '', 3000);
      } catch(err) {
        statusMsg.style.color = 'var(--danger)';
        statusMsg.textContent = 'Gagal mengirim data: ' + err.message;
      }
    });
    
    function loadMyTrips() {
      const tripsRef = ref(db, 'trips');
      const q = query(tripsRef, orderByChild('koorId'), equalTo(currentUser.uid));

      onValue(q, (snapshot) => {
        tripList.innerHTML = '';
        if (!snapshot.exists()) {
            tripList.innerHTML = '<tr><td colspan="6" class="empty-state">Belum ada data perjalanan yang Anda buat.</td></tr>';
            return;
        }

        snapshot.forEach(childSnapshot => {
          const tripData = childSnapshot.val();
          const tr = el('tr');

          const actionsCell = el('td');
          const actionsContainer = el('div', '', { class: 'trip-actions' });
          actionsContainer.style.justifyContent = 'flex-start';

          if (tripData.status === 'approved') {
            const sjButton = el('button', 'Surat Jalan', { class: 'btn-sm info' });
            const invButton = el('button', 'Invoice', { class: 'btn-sm info' });
            sjButton.onclick = () => window.open('surat-jalan.html?id=' + childSnapshot.key);
            invButton.onclick = () => window.open('invoice.html?id=' + childSnapshot.key);
            actionsContainer.append(sjButton, invButton);
          } else {
            actionsContainer.textContent = '-';
          }
          actionsCell.appendChild(actionsContainer);

          const statusCell = el('td');
          statusCell.appendChild(badge(tripData.status));
          
          tr.innerHTML = `
            <td data-label="Rute"><strong>${tripData.asal} → ${tripData.tujuan}</strong></td>
            <td data-label="Sopir">${tripData.driverName || '-'}</td>
            <td data-label="No. Polisi">${tripData.nopol}</td>
            <td data-label="Tanggal">${fmtDate(tripData.tanggal)}</td>
          `;
          tr.appendChild(statusCell);
          tr.appendChild(actionsCell);
          
          tripList.appendChild(tr);
        });
      });
    }

    logoutBtn.addEventListener('click', async () => {
        if (currentUser) {
            await update(ref(db, 'users/' + currentUser.uid), { online: false });
        }
        signOut(auth).catch(err => console.error("Logout Gagal:", err));
    });

  </script>
</body>
</html>
