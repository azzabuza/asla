<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 8px 12px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #f4f4f4;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
        <h1>Panel Admin</h1>
        <button id="logoutBtn" class="logout-button">Logout</button>
    </div>

    <h2>Monitoring Perjalanan</h2>
    <ul id="tripList"><li>Memuat data...</li></ul>

    <h2>Tambah User Baru</h2>
    <form id="addUserForm">
      <label for="newUserName">Nama</label>
      <input type="text" id="newUserName" required>

      <label for="newUserEmail">Email</label>
      <input type="email" id="newUserEmail" required>

      <label for="newUserPassword">Password</label>
      <input type="password" id="newUserPassword" required>

      <label for="newUserRole">Role</label>
      <select id="newUserRole" required>
        <option value="koordinator">Koordinator</option>
        <option value="driver">Driver</option>
      </select>

      <button type="submit">Tambah User</button>
    </form>
    <p id="addUserStatus" style="margin-top:10px;"></p>

    <h2>Daftar Semua User</h2>

    <div style="margin-bottom:10px;">
      <label>Filter Role: </label>
      <select id="filterRole">
        <option value="all">Semua</option>
        <option value="admin">Admin</option>
        <option value="koordinator">Koordinator</option>
        <option value="driver">Driver</option>
      </select>

      <label style="margin-left:20px;">Cari Nama: </label>
      <input type="text" id="searchName" placeholder="Ketik nama user..." />
    </div>

    <table>
      <thead>
        <tr>
          <th>UID</th>
          <th>Nama</th>
          <th>Role</th>
          <th>Last Login</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="userList">
        <tr><td colspan="5">Memuat data...</td></tr>
      </tbody>
    </table>

    <h2>Kinerja Role</h2>
    <div id="roleStats">Memuat statistik...</div>
  </div>

  <script type="module">
    import { 
      auth, 
      onAuthStateChanged, 
      signOut,
      db, 
      ref, 
      onValue, 
      update, 
      get, 
      set,
      onDisconnect,
      // Impor tambahan untuk solusi admin
      firebaseConfig,
      initializeApp,
      deleteApp,
      getAuth,
      createUserWithEmailAndPassword
    } from './firebase.js';
    import { badge, fmtDate, el } from './utils.js';

    const tripList = document.getElementById('tripList');
    const userList = document.getElementById('userList');
    const roleStats = document.getElementById('roleStats');
    const filterRole = document.getElementById('filterRole');
    const searchName = document.getElementById('searchName');
    const logoutBtn = document.getElementById('logoutBtn');
    const addUserForm = document.getElementById('addUserForm');
    const addUserStatus = document.getElementById('addUserStatus');

    let currentUser = null;
    let allUsers = {};
    
    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = 'index.html';
      currentUser = user;
      const userRef = ref(db, 'users/' + user.uid);

      try {
        const snap = await get(userRef);
        if (!snap.exists() || snap.val().role !== 'admin') {
          alert('Akses ditolak. Hanya untuk admin.');
          return window.location.href = 'index.html';
        }
        
        await update(userRef, { lastLogin: Date.now(), online: true });
        const userStatusRef = ref(db, 'users/' + user.uid + '/online');
        onDisconnect(userStatusRef).set(false);

        loadAllTrips();
        loadAllUsers();
        loadRoleStats();
      } catch (e) {
        console.error("‚ùå Error cek admin:", e);
      }
    });

    // ==========================================================
    // BAGIAN YANG DIPERBARUI UNTUK MENAMBAH USER DENGAN AMAN
    // ==========================================================
    addUserForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        addUserStatus.textContent = 'Menambahkan user...';
        addUserStatus.style.color = 'blue';

        const name = document.getElementById('newUserName').value;
        const email = document.getElementById('newUserEmail').value;
        const password = document.getElementById('newUserPassword').value;
        const role = document.getElementById('newUserRole').value;

        const tempAppName = 'temp-user-creation-app-' + Date.now();
        let tempApp;

        try {
            // 1. Inisialisasi aplikasi Firebase sementara
            tempApp = initializeApp(firebaseConfig, tempAppName);
            const tempAuth = getAuth(tempApp);

            // 2. Buat user menggunakan koneksi sementara (tidak akan logout admin)
            const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
            const newUser = userCredential.user;

            // 3. Simpan data user ke database menggunakan koneksi utama
            await set(ref(db, 'users/' + newUser.uid), {
                name: name,
                role: role,
                online: false,
                lastLogin: null
            });

            addUserStatus.style.color = 'green';
            addUserStatus.textContent = `‚úîÔ∏è User ${name} (${role}) berhasil ditambahkan.`;
            addUserForm.reset();

        } catch (error) {
            console.error("‚ùå Gagal menambah user:", error);
            addUserStatus.style.color = 'red';
            if (error.code === 'auth/email-already-in-use') {
                addUserStatus.textContent = 'Gagal: Email ini sudah terdaftar.';
            } else if (error.code === 'auth/weak-password') {
                addUserStatus.textContent = 'Gagal: Password terlalu lemah (minimal 6 karakter).';
            } else {
                addUserStatus.textContent = 'Gagal menambah user: ' + error.message;
            }
        } finally {
            // 4. Hapus aplikasi sementara untuk membersihkan memori
            if (tempApp) {
                await deleteApp(tempApp);
            }
        }
    });

    function loadAllTrips() {
      const tripsRef = ref(db, 'trips');
      onValue(tripsRef, (snapshot) => {
        tripList.innerHTML = '';
        if (!snapshot.exists()) {
          tripList.innerHTML = '<li>Belum ada data perjalanan.</li>';
          return;
        }
        snapshot.forEach(child => {
          const tripId = child.key;
          const trip = child.val();
          const li = el('li');
          li.innerHTML = `
            <strong>${trip.asal} ‚Üí ${trip.tujuan}</strong> (${fmtDate(trip.tanggal)})<br>
            Sopir: ${trip.driverName || 'Belum Ditugaskan'} | Nopol: ${trip.nopol}<br>
            Status: `;
          li.appendChild(badge(trip.status));
          if (trip.status === 'submitted') {
            const approveBtn = el('button', 'Setujui');
            const rejectBtn = el('button', 'Tolak', { class: 'danger' });
            approveBtn.addEventListener('click', () => update(ref(db, 'trips/' + tripId), { status: 'approved', approvedAt: Date.now(), approvedBy: currentUser.uid }));
            rejectBtn.addEventListener('click', () => update(ref(db, 'trips/' + tripId), { status: 'rejected', rejectedAt: Date.now(), rejectedBy: currentUser.uid }));
            li.append(approveBtn, rejectBtn);
          }
          tripList.appendChild(li);
        });
      }, (error) => {
        console.error("‚ùå Error load trips:", error);
        tripList.innerHTML = '<li>Error memuat data perjalanan.</li>';
      });
    }

    function loadAllUsers() {
      const usersRef = ref(db, 'users');
      onValue(usersRef, (snapshot) => {
        allUsers = snapshot.val() || {};
        renderUsers();
      }, (error) => {
        console.error("‚ùå Error load users:", error);
        userList.innerHTML = '<tr><td colspan="5">Error memuat data user.</td></tr>';
      });
      filterRole.addEventListener('change', renderUsers);
      searchName.addEventListener('input', renderUsers);
    }

    function renderUsers() {
      userList.innerHTML = '';
      const selectedRole = filterRole.value;
      const keyword = searchName.value.toLowerCase();
      let found = false;
      Object.entries(allUsers).forEach(([uid, u]) => {
        if ((selectedRole === 'all' || u.role === selectedRole) &&
            (!keyword || (u.name || '').toLowerCase().includes(keyword))) {
          found = true;
          const tr = el('tr');
          tr.innerHTML = `
            <td>${uid}</td>
            <td>${u.name || '-'}</td>
            <td>${u.role || '-'}</td>
            <td>${u.lastLogin ? new Date(u.lastLogin).toLocaleString('id-ID') : '-'}</td>
            <td style="color:${u.online ? 'green' : 'gray'}">${u.online ? 'üü¢ Online' : '‚ö™ Offline'}</td>`;
          userList.appendChild(tr);
        }
      });
      if (!found) {
        userList.innerHTML = '<tr><td colspan="5">Tidak ada user ditemukan.</td></tr>';
      }
    }

    function loadRoleStats() {
      onValue(ref(db, 'trips'), (snapshot) => {
        if (!snapshot.exists()) {
          roleStats.textContent = "Belum ada data perjalanan.";
          return;
        }
        let stats = { koordinator: {}, driver: {}, admin: 0 };
        snapshot.forEach(child => {
          const t = child.val();
          if (t.koorId) stats.koordinator[t.koorId] = (stats.koordinator[t.koorId] || 0) + 1;
          if (t.driverId) stats.driver[t.driverId] = (stats.driver[t.driverId] || 0) + 1;
          if (t.approvedBy) stats.admin++;
        });
        roleStats.innerHTML = `
          <p>üìä Total kontribusi (berdasarkan jumlah aksi):</p>
          <ul>
            <li>Admin (approve perjalanan): ${stats.admin}</li>
            <li>Koordinator (buat perjalanan): ${Object.keys(stats.koordinator).length} user</li>
            <li>Driver (menjalankan perjalanan): ${Object.keys(stats.driver).length} user</li>
          </ul>`;
      });
    }
    
    logoutBtn.addEventListener('click', async () => {
        if (currentUser) {
            await update(ref(db, 'users/' + currentUser.uid), { online: false });
        }
        signOut(auth).catch(err => console.error("Logout Gagal:", err));
    });
  </script>
</body>
</html>
