<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>Admin Panel</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
  
<body>
  <div class="content-wrapper">
    <nav class="sidebar">
      <div class="sidebar-wrapper">
        <div class="sidebar-header">
          <h2>Administrator</h2>
        </div>
        <div class="sidebar-account">
          <p id="userName">Memuat...</p>
          <small id="userEmail">Memuat...</small>
        </div>
        <div class="sidebar-menu">
          <div class="sidebar-menu-header">
            <h4><i class="fa-solid fa-circle-info"></i> Informasi</h4>
          </div>
          <ul>
            <li><a href="#dashboard" class="nav-link active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li><a href="#monitoring" class="nav-link"><i class="fas fa-truck"></i> Informasi Perjalanan</a></li>
            <li><a href="#finance" class="nav-link"><i class="fas fa-wallet"></i> Informasi Keuangan</a></li>
          </ul>
          <div class="sidebar-menu-header">
            <h4><i class="fa-solid fa-briefcase"></i> Manajemen</h4>
          </div>
          <ul>
            <li><a href="#users" class="nav-link"><i class="fas fa-users"></i> Manajemen Pengguna</a></li>
            <li id="deletion-requests-menu" style="display: none;"><a href="#deletion-requests" class="nav-link"><i class="fas fa-trash-alt"></i> Permintaan Hapus</a></li>
            <li><a href="#routes" class="nav-link"><i class="fas fa-route"></i> Manajemen Rute</a></li>
            <li><a href="#vehicles" class="nav-link"><i class="fas fa-car"></i> Manajemen Kendaraan</a></li>
          </ul>
          <div class="sidebar-menu-header">
            <h4><i class="fa-solid fa-bars-progress"></i> Tambah</h4>
          </div>
          <ul>
            <li><a href="#addusers" class="nav-link"><i class="fas fa-user-plus"></i> Tambah Pengguna</a></li>
            <li><a href="#addrutes" class="nav-link"><i class="fa-solid fa-map-location-dot"></i> Tambah Rute</a></li>
            <li><a href="#addvehicles" class="nav-link"><i class="fas fa-car-side"></i> Tambah Kendaraan</a></li>
          </ul>
          <div class="sidebar-menu-header">
            <h4><i class="fa-solid fa-book"></i> Dokumentasi</h4>
          </div>
          <ul>
            <li><a href="#performance" class="nav-link"><i class="fas fa-chart-line"></i> Kinerja Role</a></li>
            <li><a href="#documentation" class="nav-link"><i class="fas fa-file-alt"></i> Dokumentasi Laporan</a></li>
          </ul>
          <div class="sidebar-menu-header">
            <h4><i class="fa-solid fa-gear"></i> Sistem</h4>
          </div>
          <ul>
            <li id="lockdown-menu-item" style="display: none;"><a href="#lockdown" class="nav-link"><i class="fas fa-lock"></i> Protokol Lockdown</a></li>
            <li id="backup-menu-item" style="display: none;"><a href="#backup" class="nav-link"><i class="fas fa-database"></i> Pencadangan Data</a></li>
            <li><a href="#tampilan" class="nav-link"><i class="fas fa-palette"></i> Tampilan</a></li>
          </ul>
          <div class="sidebar-menu-header">
            <h4><i class="fa-solid fa-thumbs-up"></i> Sosial</h4>
          </div>
          <ul>
            <li><a href="forum.html"><i class="fa-solid fa-comments"></i> Forum Diskusi</a></li>
          </ul>
        </div>
        <div class="sidebar-footer">
          <button id="logoutBtn" class="logout-button"><i class="fa-solid fa-right-from-bracket"></i> Keluar</button>
          <p>V.4.0.0 (Stable)</p>
        </div>
      </div>
    </nav>

    <main class="main-content">
      <div class="main-wrapper">
        <header class="main-header">
          <button class="hamburger-menu" id="hamburger-menu" aria-label="Toggle sidebar" style="padding: 1rem; width: 4rem;">
            <i class="fas fa-bars"></i>
          </button>
          <div class="main-header-content">
            <h1 id="pageTitle"><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
            <p id="pageSubtitle">Ringkasan umum dan statistik sistem.</p>
          </div>
          <div class="main-header-menu">
            <ul>
              <li><a href="forum.html"><i class="fa-solid fa-comments"></i> Forum Diskusi</a></li>
              <li><a href="#"><i class="fa-solid fa-user"></i> Tim IT</a></li>
              <li><a href="#"><i class="fa-solid fa-face-smile"></i> Pusat Bantuan</a></li>
            </ul>
          </div>
        </header>
        <div class="content-container">
          <div id="page-dashboard" class="page active">
            <div class="dashboard-grid">
              <div class="stat-card">
                <h3>Total Perjalanan</h3>
                <p id="totalTrips">0</p>
              </div>
              <div class="stat-card">
                <h3>Perjalanan Bulan Ini</h3>
                <p id="tripsThisMonth">0</p>
              </div>
              <div class="stat-card">
                <h3>Perjalanan Bulan Lalu</h3>
                <p id="tripsLastMonth">0</p>
              </div>
              <div class="stat-card">
                <h3>Pengguna Online</h3>
                <p id="onlineUsers">0</p>
              </div>
              <div class="stat-card">
                <h3>Total Pengguna</h3>
                <p id="totalUsers">0</p>
              </div>
              <div class="stat-card">
                <h3>Total Rute</h3>
                <p id="totalRoutes">0</p>
              </div>
              <div class="stat-card">
                <h3>Total Kendaraan</h3>
                <p id="totalVehicles">0</p>
              </div>
              <div class="stat-card">
                <h3>Kendaraan Aktif Hari Ini</h3>
                <p id="activeVehiclesToday">0</p>
              </div>
            </div>
            <div class="card" style="margin-top: 1rem;">
              <h2 class="card-header">Aktivitas Perjalanan Terkini</h2>
              <div class="card-body">
                <div class="table-responsive">
                  <table id="recentActivityTable">
                    <thead>
                      <tr>
                        <th>Deskripsi</th>
                        <th>Uang Jalan</th>
                        <th>Tanggal</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody id="recentActivityList">
                      <tr><td colspan="4">Memuat aktivitas...</td></tr>
                    </tbody>
                  </table>
                </div>
                <div id="activity-pagination-controls" style="display: none; margin-top: 1rem; text-align: center; gap: 1rem;">
                  <button id="prevActivityBtn"><i class="fa-solid fa-arrow-left"></i> Sebelumnya</button>
                  <span id="activityPageInfo" style="color: var(--light-lavender); font-size: 1.5rem; font-weight: 500; margin: 0 1rem; padding: 0;"></span>
                  <button id="nextActivityBtn"><i class="fa-solid fa-arrow-right"></i> Berikutnya</button>
                </div>
              </div>
            </div>
          </div>

          <div id="page-monitoring" class="page">
            <section class="card">
              <h2 class="card-header">Daftar Perjalanan</h2>
              <div class="card-body">
                <div class="table-controls">
                  <div class="form-group">
                    <label>Filter Status</label>
                    <select id="filterTripStatus">
                      <option value="all">Semua</option>
                      <option value="submitted">Menunggu</option>
                      <option value="approved">Disetujui</option>
                      <option value="delivering">Dalam Perjalanan</option>
                      <option value="arriving_soon">Hampir Sampai</option>
                      <option value="rejected">Ditolak</option>
                      <option value="arrived">Selesai</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Cari Supir / Rute</label>
                    <input type="text" id="searchTrip" placeholder="Ketikkan sesuatu"/>
                  </div>
                </div>
                <div class="table-responsive">
                  <table id="tripTable">
                    <thead>
                      <tr>
                        <th>Trip ID</th>
                        <th>Rute</th>
                        <th>Supir</th>
                        <th>No. Kendaraan</th>
                        <th>Muatan</th>
                        <th>Uang Jalan</th>
                        <th>Tanggal</th>
                        <th>Status</th>
                        <th>Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="tripList">
                      <tr><td colspan="9">Memuat data...</td></tr>
                    </tbody>
                  </table>
                </div>
                <div id="pagination-controls" style="display: none; margin-top: 1rem; text-align: center; gap: 1rem;">
                  <button id="prevBtn"><i class="fa-solid fa-arrow-left"></i> Sebelumnya</button>
                  <span id="pageInfo" style="color: var(--light-lavender); font-size: 1.5rem; font-weight: 500; margin: 0 1rem; padding: 0;"></span>
                  <button id="nextBtn"><i class="fa-solid fa-arrow-right"></i> Berikutnya</button>
                </div>
              </div>
            </section>
          </div>

          <div id="page-finance" class="page">
            <section class="card">
              <h2 class="card-header">Data Keuangan Perjalanan</h2>
              <div class="card-body">
                <div class="table-controls" style="grid-template-columns: 1fr;">
                  <div class="form-group">
                    <label>Cari Supir / Rute / Trip ID</label>
                    <input type="text" id="searchFinance" placeholder="Ketikkan sesuatu..." />
                  </div>
                </div>
                <div class="stat-card" style="margin-bottom: 1rem; text-align: left; padding: 1.5rem;">
                  <h3>Total Pengeluaran</h3>
                  <p id="totalUangJalan" style="font-size: 2.5rem;">Rp 0</p>
                </div>
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr>
                        <th>Trip ID</th>
                        <th>Rute</th>
                        <th>Supir</th>
                        <th>Tanggal</th>
                        <th>Uang Jalan</th>
                      </tr>
                    </thead>
                    <tbody id="financeList">
                      <tr><td colspan="5">Memuat data keuangan...</td></tr>
                    </tbody>
                  </table>
                </div>
                <div id="finance-pagination-controls" style="display: none; margin-top: 1.5rem; text-align: center; gap: 1rem;">
                  <button id="prevFinanceBtn"><i class="fa-solid fa-arrow-left"></i> Sebelumnya</button>
                  <span id="financePageInfo" style="color: var(--light-lavender); font-size: 1.5rem; font-weight: 500; margin: 0 1rem; padding: 0;"></span>
                  <button id="nextFinanceBtn"><i class="fa-solid fa-arrow-right"></i> Berikutnya</button>
                </div>
              </div>
            </section>
          </div>

          <div id="page-users" class="page">
            <section class="card">
              <h2 class="card-header">Daftar Semua Pengguna</h2>
              <div class="card-body">
                <div class="table-controls">
                  <div class="form-group">
                    <label>Filter Role</label>
                    <select id="filterRole">
                      <option value="all">Semua</option>
                      <option value="admin">Admin</option>
                      <option value="coordinator">Koordinator</option>
                      <option value="driver">Supir</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Cari Nama</label>
                    <input type="text" id="searchName" placeholder="Ketikkan nama" />
                  </div>
                </div>
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr>
                        <th>Nama</th>
                        <th>Role</th>
                        <th>NIK</th>
                        <th>Jenis Kelamin</th>
                        <th>Status Karyawan</th>
                        <th>Login Terakhir</th>
                        <th>Status</th>
                        <th>Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="userList">
                      <tr>
                        <td colspan="8">Memuat data...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div id="user-pagination-controls" style="display: none; margin-top: 1rem; text-align: center; gap: 1rem;">
                  <button id="prevUserBtn"><i class="fa-solid fa-arrow-left"></i> Sebelumnya</button>
                  <span id="userPageInfo" style="color: var(--light-lavender); font-size: 1.5rem; font-weight: 500; margin: 0 1rem; padding: 0;"></span>
                  <button id="nextUserBtn"><i class="fa-solid fa-arrow-right"></i> Berikutnya</button>
                </div>
              </div>
            </section>
          </div>
          
          <div id="page-deletion-requests" class="page">
            <section class="card">
              <h2 class="card-header">Permintaan Penghapusan Aset & Pengguna</h2>
              <div class="card-body">
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr>
                        <th>Tipe</th>
                        <th>Detail Item</th>
                        <th>Diminta oleh</th>
                        <th>Tanggal</th>
                        <th>Status</th>
                        <th>Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="deletionRequestList">
                      <tr><td colspan="6">Memuat permintaan...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </section>
          </div>

          <div id="page-routes" class="page">
            <section class="card">
              <h2 class="card-header">Daftar Rute Tersimpan</h2>
              <div class="card-body">
                <div class="table-controls" style="grid-template-columns: 1fr;">
                  <div class="form-group">
                    <label>Cari Kode / Alamat Rute</label>
                    <input type="text" id="searchRoute" placeholder="Ketikkan alamat" />
                  </div>
                </div>
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr>
                        <th>Kode</th>
                        <th>Rute</th>
                        <th>Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="routeList">
                      <tr><td colspan="3">Memuat data...</td></tr>
                    </tbody>
                  </table>
                </div>
                <div id="route-pagination-controls" style="display: none; margin-top: 1rem; text-align: center; gap: 1rem;">
                  <button id="prevRouteBtn"><i class="fa-solid fa-arrow-left"></i> Sebelumnya</button>
                  <span id="routePageInfo" style="color: var(--light-lavender); font-size: 1.5rem; font-weight: 500; margin: 0 1rem; padding: 0;"></span>
                  <button id="nextRouteBtn"><i class="fa-solid fa-arrow-right"></i> Berikutnya</button>
                </div>
              </div>
            </section>
          </div>

          <div id="page-vehicles" class="page">
            <section class="card">
              <h2 class="card-header">Daftar Kendaraan Tersimpan</h2>
              <div class="card-body">
                <div class="table-controls" style="grid-template-columns: 1fr;">
                  <div class="form-group">
                    <label>Cari No. Kendaraan / Unit</label>
                    <input type="text" id="searchVehicle" placeholder="Ketikkan kendaraan" />
                  </div>
                </div>
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr>
                        <th>No. Kendaraan</th>
                        <th>Unit</th>
                        <th>Kepemilikan</th>
                        <th>Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="vehicleList">
                      <tr><td colspan="4">Memuat data...</td></tr>
                    </tbody>
                  </table>
                </div>
                <div id="vehicle-pagination-controls" style="display: none; margin-top: 1rem; text-align: center; gap: 1rem;">
                  <button id="prevVehicleBtn"><i class="fa-solid fa-arrow-left"></i> Sebelumnya</button>
                  <span id="vehiclePageInfo" style="color: var(--light-lavender); font-size: 1.5rem; font-weight: 500; margin: 0 1rem; padding: 0;"></span>
                  <button id="nextVehicleBtn"><i class="fa-solid fa-arrow-right"></i> Berikutnya</button>
                </div>
              </div>
            </section>
          </div>
          
          <div id="page-addusers" class="page">
            <section class="card">
              <h2 class="card-header">Tambah Pengguna Baru</h2>
              <div class="card-body">
                <form id="addUserForm">
                  <div class="form-group">
                    <label for="newUserName">Nama</label>
                    <input type="text" id="newUserName" placeholder="Ketikkan nama" autocomplete="off" required>
                  </div>
                  <div class="form-group">
                    <label for="newUserEmail">Email</label>
                    <input type="email" id="newUserEmail" placeholder="Ketikkan email" autocomplete="off" required>
                  </div>
                  <div class="form-group">
                    <label for="newUserPassword">Password</label>
                    <input type="password" id="newUserPassword" placeholder="Ketikkan password" autocomplete="new-password" required>
                  </div>
                  <div class="form-group">
                    <label for="newUserNik">Nomor Identitas (NIK)</label>
                    <input type="number" id="newUserNik" placeholder="Ketikkan nomor NIK" autocomplete="off" required>
                  </div>
                  <div class="form-group">
                    <label for="newUserGender">Jenis Kelamin</label>
                    <select id="newUserGender" required>
                      <option value="">-- Pilih Jenis --</option>
                      <option value="Laki-laki">Laki-laki</option>
                      <option value="Perempuan">Perempuan</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="newUserStatus">Status Karyawan</label>
                    <select id="newUserStatus" required>
                      <option value="">-- Pilih Status --</option>
                      <option value="Tetap">Tetap</option>
                      <option value="Kontrak">Kontrak</option>
                      <option value="Freelance">Freelance</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="newUserRole">Role</label>
                    <select id="newUserRole" required>
                      <option value="">-- Pilih Role --</option>
                      <option value="coordinator">Koordinator</option>
                      <option value="driver">Supir</option>
                    </select>
                  </div>
                  <button type="submit"><i class="fa-solid fa-user-plus"></i> Tambah User</button>
                </form>
                <p id="addUserStatus" class="form-status"></p>
              </div>
            </section>
          </div>
          <div id="page-addrutes" class="page">
            <section class="card">
              <h2 class="card-header">Tambah Rute Baru</h2>
              <div class="card-body">
                <form id="addRouteForm">
                  <div class="form-group">
                    <label for="routeCode">Kode Rute</label>
                    <input type="text" id="routeCode" placeholder="Ketikkan kode" required>
                  </div>
                  <div class="form-group">
                    <label for="routeAddress">Alamat/Lokasi</label>
                    <input type="text" id="routeAddress" placeholder="Ketikkan alamat" required>
                  </div>
                  <button type="submit"><i class="fa-solid fa-map-location-dot"></i> Tambah Rute</button>
                </form>
                <p id="addRouteStatus" class="form-status"></p>
              </div>
            </section>
          </div>
          <div id="page-addvehicles" class="page">
            <section class="card">
              <h2 class="card-header">Tambah Kendaraan Baru</h2>
              <div class="card-body">
                <form id="addVehicleForm">
                  <div class="form-group">
                    <label for="vehicleNumberInput">No. Kendaraan</label>
                    <input type="text" id="vehicleNumberInput" placeholder="Ketikkan nomor polisi" required>
                  </div>
                  <div class="form-group">
                    <label for="vehicleUnit">Unit</label>
                    <input type="text" id="vehicleUnit" placeholder="Ketikkan kendaraan" required>
                  </div>
                  <div class="form-group">
                    <label for="vehicleOwnership">Kepemilikan</label>
                    <select id="vehicleOwnership" required>
                      <option value="">-- Pilih Kepemilikan --</option>
                      <option value="Perusahaan">Perusahaan</option>
                      <option value="Sewa">Sewa</option>
                    </select>
                  </div>
                  <button type="submit"><i class="fa-solid fa-car"></i> Tambah Kendaraan</button>
                </form>
                <p id="addVehicleStatus" class="form-status"></p>
              </div>
            </section>
          </div>
          <div id="page-performance" class="page">
            <section class="card">
              <h2 class="card-header">Aktivitas Terbaru Berdasarkan Role</h2>
              <div id="roleStats" class="card-body">Memuat statistik...</div>
            </section>
          </div>

          <div id="page-documentation" class="page">
            <section class="card">
              <h2 class="card-header">Buat Laporan</h2>
              <div class="card-body">
                <div class="form-group">
                  <label for="reportType">Pilih Jenis Data</label>
                  <select id="reportType">
                    <option value="trips">Laporan Perjalanan</option>
                    <option value="users">Laporan Pengguna</option>
                    <option value="routes">Laporan Rute</option>
                    <option value="vehicles">Laporan Kendaraan</option>
                  </select>
                </div>
                <div id="dateFilterContainer" class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                  <div>
                    <label for="startDate">Dari Tanggal</label>
                    <input type="date" id="startDate">
                  </div>
                  <div>
                    <label for="endDate">Sampai Tanggal</label>
                    <input type="date" id="endDate">
                  </div>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                  <button id="exportPdfBtn"><i class="fa-solid fa-file-pdf"></i> Unduh PDF</button>
                  <button id="exportExcelBtn"><i class="fa-solid fa-file-excel"></i> Unduh Excel</button>
                </div>
              </div>
            </section>
          </div>

          <div id="page-tampilan" class="page">
            <section class="card">
              <h2 class="card-header">Tema Tampilan</h2>
              <div class="card-body">
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin: 0;">
                  <label for="themeToggle" style="margin: 0;">Mode Terang</label>
                  <label class="switch">
                    <input type="checkbox" id="themeToggle">
                    <span class="slider"></span>
                  </label>
                </div>
              </div>
            </section>
            <section class="card">
              <h2 class="card-header">Font Tampilan</h2>
              <div class="card-body">
                <div class="form-group" style="margin: 0;">
                  <label for="fontSelector">Pilih Font</label>
                  <select id="fontSelector">
                    <option value="'Poppins', sans-serif">Poppins (Default)</option>
                    <option value="'Roboto', sans-serif">Roboto</option>
                  </select>
                </div>
              </div>
            </section>
          </div>

          <div id="page-lockdown" class="page">
            <section class="card">
              <h2 class="card-header">Mode Lockdown Pengguna</h2>
              <div class="card-body">
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                  <label for="massLockdownSwitch" style="margin: 0;">Lockdown Semua Pengguna</label>
                  <label class="switch">
                    <input type="checkbox" id="massLockdownSwitch">
                    <span class="slider"></span>
                  </label>
                </div>
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr>
                        <th>Nama Pengguna</th>
                        <th>Role</th>
                        <th>Status Pengguna</th>
                      </tr>
                    </thead>
                    <tbody id="lockdownUserList">
                      <tr><td colspan="3">Memuat data pengguna...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </section>
          </div>
          
          <div id="page-backup" class="page">
            <section class="card">
              <h2 class="card-header">Pencadangan Data</h2>
              <div class="card-body">
                <p style="color: var(--light-lavender); font-size: 1.5rem; margin-bottom: 1rem;">Unduh salinan semua data sistem (pengguna, perjalanan, rute, kendaraan) dalam satu file JSON. Simpan file ini di tempat yang aman.</p>
                <button id="downloadBackupBtn"><i class="fas fa-download"></i> Unduh Semua Data (.json)</button>
              </div>
            </section>
            <section class="card">
              <h2 class="card-header" style="color: var(--red);">Pemulihan Data</h2>
              <div class="card-body">
                <p style="color: var(--light-lavender); font-size: 1.5rem; margin-bottom: 1rem;">
                  <strong style="color: var(--orange);">PERINGATAN:</strong> Aksi ini akan <strong style="text-decoration: underline;">menimpa seluruh data</strong> yang ada di database dengan data dari file yang Anda unggah. Aksi ini tidak dapat dibatalkan. Lanjutkan hanya jika Anda benar-benar yakin.
                </p>
                <div class="form-group">
                  <label for="restoreFileInput">Pilih File Pencadangan (.json)</label>
                  <input type="file" id="restoreFileInput" accept=".json">
                </div>
                <button id="restoreBackupBtn" class="logout-button" style="width: 100%;"><i class="fas fa-upload"></i> Unggah dan Pulihkan Data</button>
                <p id="restoreStatus" class="form-status"></p>
              </div>
            </section>
          </div>
        </div>
        <footer class="main-footer">
          <p><strong style="color: var(--orange);">PERINGATAN:</strong> Hati-hati dalam mengeksekusi data.</p>
        </footer>
      </div>
    </main>
    
  </div>

  <div id="invoiceModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeInvoiceModal"><i class="fa-solid fa-xmark"></i></span>
      <h2 style="margin: 0 0 2rem 0">Internal Invoice Otomatis</h2>
      <div class="form-group">
        <label for="recipientName">Penerima</label>
        <input type="text" id="recipientName" placeholder="Ketikkan nama" autocomplete="off" required>
      </div>
      <div class="form-group">
        <label for="recipientAddress">Alamat</label>
        <textarea id="recipientAddress" rows="3" style="resize: none;" placeholder="Ketikkan alamat" autocomplete="off" required></textarea>
      </div>
      <button id="printInvoiceBtn" style="width: 100%;"><i class="fa-solid fa-file-arrow-down"></i> Unduh Invoice</button>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase-client.js';
    import { badge, fmtDate, el, idr } from './utils.js';

    document.addEventListener('DOMContentLoaded', () => {
        const hamburger = document.getElementById('hamburger-menu');
        const sidebar = document.querySelector('.sidebar');
        const mainContent = document.querySelector('.main-content');
        hamburger.addEventListener('click', (event) => {
            event.stopPropagation();
            sidebar.classList.toggle('active');
        });
        mainContent.addEventListener('click', () => {
            if (window.innerWidth <= 1024 && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });
    });

    const pageContent = {
        dashboard: { title: '<i class="fas fa-tachometer-alt"></i> Dashboard', subtitle: 'Ringkasan umum dan statistik sistem.' },
        monitoring: { title: '<i class="fas fa-truck"></i> Informasi Perjalanan', subtitle: 'Pusat kelola dan pemantauan seluruh data perjalanan.' },
        users: { title: '<i class="fas fa-users"></i> Manajemen Pengguna', subtitle: 'Kelola semua data pengguna dalam sistem.' },
        'deletion-requests': { title: '<i class="fas fa-trash-alt"></i> Permintaan Hapus', subtitle: 'Tinjau dan kelola semua permintaan penghapusan.' },
        routes: { title: '<i class="fas fa-route"></i> Manajemen Rute', subtitle: 'Kelola daftar rute yang tersedia.' },
        vehicles: { title: '<i class="fas fa-car"></i> Manajemen Kendaraan', subtitle: 'Kelola daftar kendaraan operasional.' },
        finance: { title: '<i class="fas fa-wallet"></i> Informasi Keuangan', subtitle: 'Lacak semua transaksi uang jalan dari perjalanan.' },
        addusers: { title: '<i class="fas fa-user-plus"></i> Tambah Pengguna', subtitle: 'Buat akun baru untuk pengguna.' },
        addrutes: { title: '<i class="fas fa-plus-circle"></i> Tambah Rute', subtitle: 'Tambahkan rute baru ke dalam sistem.' },
        addvehicles: { title: '<i class="fas fa-car-side"></i> Tambah Kendaraan', subtitle: 'Tambahkan kendaraan baru ke dalam sistem.' },
        performance: { title: '<i class="fas fa-chart-line"></i> Kinerja Role', subtitle: 'Lihat ringkasan aktivitas berdasarkan peran.' },
        documentation: { title: '<i class="fas fa-file-alt"></i> Dokumentasi Laporan', subtitle: 'Buat dan unduh laporan dari data sistem.' },
        tampilan: { title: '<i class="fas fa-palette"></i> Tampilan', subtitle: 'Sesuaikan tampilan antarmuka sistem.' },
        lockdown: { title: '<i class="fas fa-lock"></i> Lockdown', subtitle: 'Nonaktifkan sementara pengguna bermasalah.' },
        backup: { title: '<i class="fas fa-database"></i> Backup & Restore', subtitle: 'Kelola pencadangan dan pemulihan data sistem.' }
    };

    const elements = {
        pageTitle: document.getElementById('pageTitle'),
        pageSubtitle: document.getElementById('pageSubtitle'),
        navLinks: document.querySelectorAll('.nav-link'),
        pages: document.querySelectorAll('.page'),
        userName: document.getElementById('userName'),
        userEmail: document.getElementById('userEmail'),
        tripList: document.getElementById('tripList'),
        userList: document.getElementById('userList'),
        roleStats: document.getElementById('roleStats'),
        filterRole: document.getElementById('filterRole'),
        searchName: document.getElementById('searchName'),
        filterTripStatus: document.getElementById('filterTripStatus'),
        searchTrip: document.getElementById('searchTrip'),
        searchRoute: document.getElementById('searchRoute'),
        searchVehicle: document.getElementById('searchVehicle'),
        searchFinance: document.getElementById('searchFinance'),
        logoutBtn: document.getElementById('logoutBtn'),
        addUserForm: document.getElementById('addUserForm'),
        addUserStatus: document.getElementById('addUserStatus'),
        newUserRole: document.getElementById('newUserRole'),
        addRouteForm: document.getElementById('addRouteForm'),
        addRouteStatus: document.getElementById('addRouteStatus'),
        routeList: document.getElementById('routeList'),
        addVehicleForm: document.getElementById('addVehicleForm'),
        addVehicleStatus: document.getElementById('addVehicleStatus'),
        vehicleList: document.getElementById('vehicleList'),
        financeList: document.getElementById('financeList'),
        paginationControls: document.getElementById('pagination-controls'),
        prevBtn: document.getElementById('prevBtn'),
        nextBtn: document.getElementById('nextBtn'),
        pageInfo: document.getElementById('pageInfo'),
        userPaginationControls: document.getElementById('user-pagination-controls'),
        prevUserBtn: document.getElementById('prevUserBtn'),
        nextUserBtn: document.getElementById('nextUserBtn'),
        userPageInfo: document.getElementById('userPageInfo'),
        routePaginationControls: document.getElementById('route-pagination-controls'),
        prevRouteBtn: document.getElementById('prevRouteBtn'),
        nextRouteBtn: document.getElementById('nextRouteBtn'),
        routePageInfo: document.getElementById('routePageInfo'),
        vehiclePaginationControls: document.getElementById('vehicle-pagination-controls'),
        prevVehicleBtn: document.getElementById('prevVehicleBtn'),
        nextVehicleBtn: document.getElementById('nextVehicleBtn'),
        vehiclePageInfo: document.getElementById('vehiclePageInfo'),
        financePaginationControls: document.getElementById('finance-pagination-controls'),
        prevFinanceBtn: document.getElementById('prevFinanceBtn'),
        nextFinanceBtn: document.getElementById('nextFinanceBtn'),
        financePageInfo: document.getElementById('financePageInfo'),
        totalTrips: document.getElementById('totalTrips'),
        tripsThisMonth: document.getElementById('tripsThisMonth'),
        tripsLastMonth: document.getElementById('tripsLastMonth'),
        totalUsers: document.getElementById('totalUsers'),
        onlineUsers: document.getElementById('onlineUsers'),
        totalRoutes: document.getElementById('totalRoutes'),
        totalVehicles: document.getElementById('totalVehicles'),
        activeVehiclesToday: document.getElementById('activeVehiclesToday'),
        recentActivityList: document.getElementById('recentActivityList'),
        activityPaginationControls: document.getElementById('activity-pagination-controls'),
        prevActivityBtn: document.getElementById('prevActivityBtn'),
        nextActivityBtn: document.getElementById('nextActivityBtn'),
        activityPageInfo: document.getElementById('activityPageInfo'),
        reportType: document.getElementById('reportType'),
        dateFilterContainer: document.getElementById('dateFilterContainer'),
        startDate: document.getElementById('startDate'),
        endDate: document.getElementById('endDate'),
        exportPdfBtn: document.getElementById('exportPdfBtn'),
        exportExcelBtn: document.getElementById('exportExcelBtn'),
        themeToggle: document.getElementById('themeToggle'),
        fontSelector: document.getElementById('fontSelector'),
        lockdownMenuItem: document.getElementById('lockdown-menu-item'),
        lockdownUserList: document.getElementById('lockdownUserList'),
        massLockdownSwitch: document.getElementById('massLockdownSwitch'),
        backupMenuItem: document.getElementById('backup-menu-item'),
        downloadBackupBtn: document.getElementById('downloadBackupBtn'),
        restoreBackupBtn: document.getElementById('restoreBackupBtn'),
        restoreFileInput: document.getElementById('restoreFileInput'),
        restoreStatus: document.getElementById('restoreStatus'),
        invoiceModal: document.getElementById('invoiceModal'),
        closeInvoiceModal: document.getElementById('closeInvoiceModal'),
        printInvoiceBtn: document.getElementById('printInvoiceBtn'),
        recipientName: document.getElementById('recipientName'),
        recipientAddress: document.getElementById('recipientAddress'),
        totalUangJalan: document.getElementById('totalUangJalan'),
        deletionRequestsMenu: document.getElementById('deletion-requests-menu'),
        deletionRequestList: document.getElementById('deletionRequestList'),
    };

    let currentUser = null;
    let currentUserData = null;
    let allUsers = [];
    let allTrips = [];
    let allRoutes = [];
    let allVehicles = [];
    let allDeletionRequests = [];
    let routeCodeMap = {};
    let currentTripForInvoice = null;
    let currentPage = 1;
    let currentUserPage = 1;
    let currentRoutePage = 1;
    let currentVehiclePage = 1;
    let currentFinancePage = 1;
    let currentActivityPage = 1;
    const activityRowsPerPage = 5;
    const rowsPerPage = 20;

    function refreshAllViews() {
        displayTrips(currentPage);
        displayUsers(currentUserPage);
        displayRoutes(currentRoutePage);
        displayVehicles(currentVehiclePage);
        displayFinance(currentFinancePage);
        displayRecentActivity(currentActivityPage);
        loadDashboardStats();
        loadRoleStats();
        displayLockdownUsers();
        if (currentUserData.role === 'super admin') {
            displayDeletionRequests();
        }
    }

    function setupNavigation() {
        elements.navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                elements.pages.forEach(page => page.classList.remove('active'));
                elements.navLinks.forEach(nav => nav.classList.remove('active'));
                document.getElementById(`page-${targetId}`).classList.add('active');
                link.classList.add('active');
                elements.pageTitle.innerHTML = pageContent[targetId].title;
                elements.pageSubtitle.textContent = pageContent[targetId].subtitle;
                
                if (window.innerWidth <= 1024) {
                    document.querySelector('.sidebar').classList.remove('active');
                }
            });
        });

        elements.closeInvoiceModal.onclick = () => {
            elements.invoiceModal.style.display = 'none';
        }

        window.onclick = (event) => {
          if (event.target == elements.invoiceModal) {
            elements.invoiceModal.style.display = "none";
          }
        }
        
        elements.printInvoiceBtn.addEventListener('click', () => {
            const recipientName = elements.recipientName.value;
            const recipientAddress = elements.recipientAddress.value;
            if (!recipientName.trim() || !recipientAddress.trim()) {
                alert('Nama dan Alamat Penerima tidak boleh kosong.');
                return;
            }
            if(currentTripForInvoice) {
                generateInvoicePDF(currentTripForInvoice.id, currentTripForInvoice, recipientName, recipientAddress);
                elements.invoiceModal.style.display = 'none';
            }
        });
    }
    setupNavigation();
    
    function applyTheme(theme) {
      document.body.classList.toggle('light-mode', theme === 'light');
    }

    function applyFont(font) {
      document.body.style.fontFamily = font;
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        const savedFont = localStorage.getItem('font') || "'Poppins', sans-serif";

        applyTheme(savedTheme);
        applyFont(savedFont);

        elements.themeToggle.checked = (savedTheme === 'light');
        elements.fontSelector.value = savedFont;

        elements.themeToggle.addEventListener('change', (e) => {
            const theme = e.target.checked ? 'light' : 'dark';
            localStorage.setItem('theme', theme);
            applyTheme(theme);
        });

        elements.fontSelector.addEventListener('change', (e) => {
            const font = e.target.value;
            localStorage.setItem('font', font);
            applyFont(font);
        });
    });

    async function checkUserSession() {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.href = 'login.html'; return; }
        currentUser = session.user;

        const { data, error } = await supabase.from('users').select('*').eq('id', currentUser.id).single();
        if (error || !data) {
            alert('Gagal memuat data pengguna. Sesi Anda mungkin tidak valid.');
            await supabase.auth.signOut(); window.location.href = 'login.html'; return;
        }

        currentUserData = data;
        if (!['admin', 'super admin'].includes(currentUserData.role)) {
            alert('Anda tidak memiliki akses ke halaman ini.');
            await supabase.auth.signOut(); window.location.href = 'login.html'; return;
        }

        if (currentUserData.locked) {
            alert('Akun Anda telah dinonaktifkan oleh Super Admin.');
            await supabase.auth.signOut(); window.location.href = 'login.html'; return;
        }

        elements.userName.textContent = currentUserData.name || 'Admin';
        elements.userEmail.textContent = currentUser.email;

        if (currentUserData.role === 'super admin') {
            ['lockdown-menu-item', 'backup-menu-item', 'deletion-requests-menu'].forEach(id => {
                document.getElementById(id).style.display = 'block';
            });
            if (!elements.newUserRole.querySelector('option[value="admin"]')) {
              elements.newUserRole.appendChild(el('option', 'Admin', { value: 'admin' }));
            }
        }
    }

    async function loadInitialData() {
        const [routesRes, vehiclesRes, usersRes, tripsRes, requestsRes] = await Promise.all([
            supabase.from('routes').select('*'),
            supabase.from('vehicles').select('*'),
            supabase.from('users').select('*'),
            supabase.from('trips').select('*').order('created_at', { ascending: false }),
            currentUserData.role === 'super admin' ? supabase.from('deletion_requests').select(`*, requester:requested_by ( name )`) : Promise.resolve({ data: [] })
        ]);

        allRoutes = routesRes.data || [];
        allVehicles = vehiclesRes.data || [];
        allUsers = usersRes.data || [];
        allTrips = tripsRes.data || [];
        allDeletionRequests = (requestsRes.data || []).sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
        routeCodeMap = Object.fromEntries(allRoutes.map(route => [route.address, route.code]));
        
        refreshAllViews();
        
        ['change', 'input'].forEach(evt => {
            elements.filterRole.addEventListener(evt, () => displayUsers(1));
            elements.searchName.addEventListener(evt, () => displayUsers(1));
            elements.filterTripStatus.addEventListener(evt, () => displayTrips(1));
            elements.searchTrip.addEventListener(evt, () => displayTrips(1));
            elements.searchRoute.addEventListener(evt, () => displayRoutes(1));
            elements.searchVehicle.addEventListener(evt, () => displayVehicles(1));
            elements.searchFinance.addEventListener(evt, () => displayFinance(1));
        });
    }
    
    // =========================================================================
    // REALTIME SETUP (STABLE VERSION 2)
    // =========================================================================
    async function reFetchData(tableName) {
        console.log(`[Realtime] ðŸ”„ Mengambil data baru untuk tabel: ${tableName}`);
        switch(tableName) {
            case 'users':
                const { data: users } = await supabase.from('users').select('*');
                if (users) { allUsers = users; refreshAllViews(); }
                break;
            case 'trips':
                const { data: trips } = await supabase.from('trips').select('*').order('created_at', { ascending: false });
                if (trips) { allTrips = trips; refreshAllViews(); }
                break;
            case 'routes':
                const { data: routes } = await supabase.from('routes').select('*');
                if (routes) {
                    allRoutes = routes;
                    routeCodeMap = Object.fromEntries(allRoutes.map(route => [route.address, route.code]));
                    refreshAllViews();
                }
                break;
            case 'vehicles':
                const { data: vehicles } = await supabase.from('vehicles').select('*');
                if (vehicles) { allVehicles = vehicles; refreshAllViews(); }
                break;
            case 'deletion_requests':
                if (currentUserData.role !== 'super admin') return;
                const { data: requests } = await supabase.from('deletion_requests').select(`*, requester:requested_by ( name )`);
                if (requests) {
                    allDeletionRequests = requests.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
                    displayDeletionRequests();
                }
                break;
        }
    }
    
    function setupRealtimeListeners() {
        console.log("ðŸš€ Menyiapkan listener realtime yang stabil...");
        const tables = ['users', 'trips', 'routes', 'vehicles'];
        if (currentUserData.role === 'super admin') {
            tables.push('deletion_requests');
        }

        tables.forEach(table => {
            supabase.channel(`public:${table}`)
              .on('postgres_changes', { event: '*', schema: 'public', table: table }, () => reFetchData(table))
              .subscribe((status) => {
                  if (status === 'SUBSCRIBED') {
                      console.log(`âœ… Berhasil subscribe ke tabel: ${table}`);
                  }
              });
        });
    }

    function displayRecentActivity(page) {
        elements.recentActivityList.innerHTML = '';
        currentActivityPage = page;
        const start = (page - 1) * activityRowsPerPage;
        const paginatedActivities = allTrips.slice(start, start + activityRowsPerPage);
        elements.activityPaginationControls.style.display = allTrips.length > activityRowsPerPage ? 'flex' : 'none';
        
        if (paginatedActivities.length === 0) {
            elements.recentActivityList.innerHTML = '<tr><td colspan="4" class="empty-state">Belum ada aktivitas perjalanan.</td></tr>';
        } else {
            paginatedActivities.forEach(trip => {
                const tr = el('tr');
                let actionText = "melakukan perjalanan";
                switch(trip.status) {
                    case 'submitted': actionText = "dibuatkan perjalanan"; break;
                    case 'approved': actionText = "diberi tugas perjalanan"; break;
                    case 'delivering': actionText = "memulai perjalanan"; break;
                    case 'arriving_soon': actionText = "hampir tiba di tujuan"; break;
                    case 'rejected': actionText = "dibatalkan perjalanannya"; break;
                    case 'arrived': actionText = "menyelesaikan rute"; break;
                }
                const asalCode = routeCodeMap[trip.asal] || trip.asal;
                const tujuanCodes = Array.isArray(trip.tujuan) ? trip.tujuan.map(t => routeCodeMap[t] || t).join(', ') : (routeCodeMap[trip.tujuan] || trip.tujuan);
                const ruteDisplay = `${asalCode}, ${tujuanCodes}`;
                const description = `<span style="color: var(--cyan); font-weight: 500;">${trip.driver_name || 'N/A'}</span> ${actionText} <span style="color: var(--green); font-weight: 500;">${ruteDisplay}</span>`;
                const statusCell = el('td', '', {'data-label': 'Status'});
                statusCell.appendChild(badge(trip.status));
                tr.innerHTML = `<td data-label="Deskripsi">${description}</td><td data-label="Uang Jalan">${idr(trip.uang_jalan)}</td><td data-label="Tanggal">${fmtDate(trip.tanggal)}</td>`;
                tr.appendChild(statusCell);
                elements.recentActivityList.appendChild(tr);
            });
        }
        const totalPages = Math.ceil(allTrips.length / activityRowsPerPage);
        elements.activityPageInfo.textContent = `Halaman ${page} dari ${totalPages || 1}`;
        elements.prevActivityBtn.disabled = page === 1;
        elements.nextActivityBtn.disabled = page >= totalPages;
    }
    elements.prevActivityBtn.addEventListener('click', () => displayRecentActivity(currentActivityPage - 1));
    elements.nextActivityBtn.addEventListener('click', () => displayRecentActivity(currentActivityPage + 1));
    
    function loadDashboardStats() {
        elements.totalTrips.textContent = allTrips.length;
        elements.totalRoutes.textContent = allRoutes.length;
        elements.totalVehicles.textContent = allVehicles.length;
        elements.totalUsers.textContent = allUsers.length;
        elements.onlineUsers.textContent = allUsers.filter(u => u.online).length;
        
        const now = new Date();
        const todayStr = now.toISOString().split('T')[0];
        const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);

        elements.tripsThisMonth.textContent = allTrips.filter(t => new Date(t.tanggal) >= currentMonthStart).length;
        elements.tripsLastMonth.textContent = allTrips.filter(t => new Date(t.tanggal) >= lastMonthStart && new Date(t.tanggal) <= lastMonthEnd).length;
        elements.activeVehiclesToday.textContent = new Set(allTrips.filter(t => t.tanggal === todayStr && ['approved', 'delivering', 'arriving_soon'].includes(t.status)).map(t => t.vehicle_number)).size;
    }

    function openInvoiceModal(trip) {
      currentTripForInvoice = trip;
      elements.invoiceModal.style.display = 'block';
    }

    async function generateQrCodeDataURL(tripId) {
        const tempQrContainer = document.createElement('div');
        const url = `${window.location.origin}${window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'))}/invoice-checking.html?id=${tripId}`;
        return new Promise(resolve => {
            new QRCode(tempQrContainer, { text: url, width: 128, height: 128, correctLevel: QRCode.CorrectLevel.H });
            setTimeout(() => { resolve(tempQrContainer.querySelector('canvas').toDataURL()); }, 100);
        });
    }

    async function generateInvoicePDF(tripId, tripData, recipientName, recipientAddress) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const qrCodeDataUrl = await generateQrCodeDataURL(tripId);
        doc.setFontSize(20); doc.setFont('helvetica', 'bold'); doc.text('PT MAJU MUNDUR SYANTIQ', 14, 22);
        doc.setFontSize(11); doc.setFont('helvetica', 'normal');
        const companyAddress = 'Dahromo 1, RT.02, Kel. Segoroyoso, Kec. Pleret, Kabupaten Bantul, Daerah Istimewa Yogyakarta 55791';
        const addressLines = doc.splitTextToSize(companyAddress, 100); 
        doc.text(addressLines, 14, 30);
        const addressHeight = (addressLines.length * 5);
        doc.text('Telepon: (021) 555-1234', 14, 30 + addressHeight);
        doc.setFontSize(22); doc.setFont('helvetica', 'bold'); doc.text('INVOICE', 200, 22, { align: 'right' });
        doc.setFontSize(11); doc.setFont('helvetica', 'normal');
        doc.text(`No. Invoice: ${tripId}`, 200, 32, { align: 'right' });
        doc.text(`Tanggal: ${fmtDate(new Date().toISOString().slice(0,10))}`, 200, 38, { align: 'right' });
        let startY = 36 + addressHeight + 10;
        doc.setFont('helvetica', 'bold'); doc.text('Tagihan Kepada:', 14, startY);
        doc.setFont('helvetica', 'normal'); doc.text(recipientName, 14, startY + 6); doc.text(recipientAddress.split('\n'), 14, startY + 12);
        const ruteDisplay = `${routeCodeMap[tripData.asal] || tripData.asal}, ${Array.isArray(tripData.tujuan) ? tripData.tujuan.map(t => routeCodeMap[t] || t).join(', ') : (routeCodeMap[tripData.tujuan] || tripData.tujuan)}`;
        const deskripsi = `Pengiriman ${tripData.muatan}`;
        doc.autoTable({
            startY: startY + 25,
            head: [['Trip ID', 'Deskripsi', 'Rute', 'Keberangkatan', 'Jumlah']],
            body: [[tripId, deskripsi, ruteDisplay, fmtDate(tripData.tanggal), idr(tripData.uang_jalan)]],
            theme: 'striped', headStyles: { fillColor: [22, 34, 53], fontSize: 10 }, bodyStyles: { fontSize: 10 },
            didDrawPage: function (data) {
                const tableEndY = data.cursor.y;
                doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                doc.text(`Supir: ${tripData.driver_name}`, 14, tableEndY + 10);
                doc.text(`Kendaraan: ${tripData.vehicle_number}`, 14, tableEndY + 15);
                const finalY = tableEndY + 25;
                doc.setFontSize(11); doc.setFont('helvetica', 'bold');
                doc.text('Total Tagihan:', 140, finalY, { align: 'left' });
                doc.text(idr(tripData.uang_jalan), 200, finalY, { align: 'right' });
                const pageHeight = doc.internal.pageSize.height;
                doc.addImage(qrCodeDataUrl, 'PNG', 14, pageHeight - 50, 40, 40);
                doc.setFontSize(8); doc.text('Scan untuk Verifikasi', 16, pageHeight - 8);
                doc.setFontSize(10); doc.setFont('helvetica', 'italic');
                doc.text('Terima kasih atas kepercayaan Anda.', 200, pageHeight - 20, { align: 'right' });
                doc.text('Pembayaran ke BCA 123456789 a/n PT Maju Mundur Syantiq.', 200, pageHeight - 14, { align: 'right' });
            }
        });
        doc.save(`Invoice-${tripId}.pdf`);
    }
    
    function displayTrips(page) {
      elements.tripList.innerHTML = '';
      currentPage = page;
      const searchTerm = elements.searchTrip.value.toLowerCase();
      const statusFilter = elements.filterTripStatus.value;
      const filteredTrips = allTrips.filter(trip => (statusFilter === 'all' || trip.status === statusFilter) && (!searchTerm || `${trip.id} ${trip.driver_name} ${trip.asal} ${Array.isArray(trip.tujuan) ? trip.tujuan.join(' ') : trip.tujuan}`.toLowerCase().includes(searchTerm)));
      const start = (currentPage - 1) * rowsPerPage;
      const paginatedTrips = filteredTrips.slice(start, start + rowsPerPage);
      
      if (paginatedTrips.length === 0 && filteredTrips.length > 0 && currentPage > 1) { currentPage = Math.ceil(filteredTrips.length / rowsPerPage); return displayTrips(currentPage); }
      
      elements.paginationControls.style.display = filteredTrips.length > rowsPerPage ? 'flex' : 'none';
      if (paginatedTrips.length === 0) {
        elements.tripList.innerHTML = '<tr><td colspan="9" class="empty-state">Tidak ada perjalanan ditemukan.</td></tr>';
      } else {
        paginatedTrips.forEach(trip => {
            const tr = el('tr');
            const ruteDisplay = `${routeCodeMap[trip.asal] || trip.asal}, ${Array.isArray(trip.tujuan) ? trip.tujuan.map(t => routeCodeMap[t] || t).join(', ') : (routeCodeMap[trip.tujuan] || trip.tujuan)}`;
            const actionsCell = el('td', '', {'data-label': 'Aksi'});
            const actionsContainer = el('div', '', { class: 'trip-actions', style: 'justify-content: flex-end;' });
            
            if (trip.status === 'submitted') {
                actionsContainer.append(el('button', 'Setujui', { class: 'btn-sm success', 'data-trip-id': trip.id, 'data-action': 'approve' }), el('button', 'Tolak', { class: 'btn-sm danger', 'data-trip-id': trip.id, 'data-action': 'reject' }));
            }
            if (['approved', 'delivering', 'arriving_soon', 'arrived'].includes(trip.status)) {
                const invButton = el('button', '<i class="fas fa-file-invoice"></i> Invoice', { class: 'btn-sm info' });
                invButton.onclick = () => openInvoiceModal(trip);
                actionsContainer.append(invButton);
            }
            if (currentUserData.role === 'super admin') {
                actionsContainer.appendChild(el('button', '<i class="fa-solid fa-trash"></i> Hapus', { class: 'btn-sm', 'data-trip-id': trip.id, 'data-trip-info': ruteDisplay, 'data-action': 'delete-trip' }));
            }
            actionsCell.appendChild(actionsContainer);
            tr.innerHTML = `<td data-label="Trip ID">${trip.id}</td><td data-label="Rute">${ruteDisplay}</td><td data-label="Supir">${trip.driver_name || 'N/A'}</td><td data-label="No. Kendaraan">${trip.vehicle_number || 'N/A'}</td><td data-label="Muatan">${trip.muatan || 'N/A'}</td><td data-label="Uang Jalan">${idr(trip.uang_jalan)}</td><td data-label="Tanggal">${fmtDate(trip.tanggal)}</td>`;
            tr.append(el('td', '', {'data-label': 'Status'}, [badge(trip.status)]), actionsCell);
            elements.tripList.appendChild(tr);
        });
      }
      const totalPages = Math.ceil(filteredTrips.length / rowsPerPage);
      elements.pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages || 1}`;
      elements.prevBtn.disabled = currentPage === 1;
      elements.nextBtn.disabled = currentPage >= totalPages;
    }

    async function updateTripStatus(tripId, status) {
        let additionalData = {};
        if (status === 'approved') additionalData = { approved_at: new Date().toISOString(), approved_by: currentUser.id, is_read_coor: false };
        if (status === 'rejected') additionalData = { rejected_at: new Date().toISOString(), rejected_by: currentUser.id, is_read_coor: false };
        const { error } = await supabase.from('trips').update({ status, ...additionalData }).eq('id', tripId);
        if (error) alert(`Gagal memperbarui status: ${error.message}`);
    }

    async function deleteTrip(tripId, tripInfo) {
        if (confirm(`Yakin ingin hapus perjalanan:\n${tripInfo}?`)) {
            const { error } = await supabase.from('trips').delete().eq('id', tripId);
            if (error) alert(`Gagal menghapus perjalanan: ${error.message}`);
            else alert('Perjalanan berhasil dihapus.');
        }
    }
    
    elements.prevBtn.addEventListener('click', () => { if (currentPage > 1) displayTrips(currentPage - 1); });
    elements.nextBtn.addEventListener('click', () => { 
        const totalPages = Math.ceil(allTrips.filter(t => (elements.filterTripStatus.value === 'all' || t.status === elements.filterTripStatus.value)).length / rowsPerPage); 
        if (currentPage < totalPages) displayTrips(currentPage + 1); 
    });

    elements.tripList.addEventListener('click', (e) => {
        const button = e.target.closest('button[data-action]');
        if (!button) return;
        const action = button.dataset.action;
        const tripId = parseInt(button.dataset.tripId);
        if (action === 'approve' || action === 'reject') updateTripStatus(tripId, action);
        else if (action === 'delete-trip') deleteTrip(tripId, button.dataset.tripInfo);
    });

    function displayUsers(page) {
      elements.userList.innerHTML = '';
      currentUserPage = page;
      const roleOrder = ['super admin', 'admin', 'coordinator', 'driver'];
      const searchTerm = elements.searchName.value.toLowerCase();
      const roleFilter = elements.filterRole.value;
      
      const filteredUsers = allUsers
        .filter(u => (roleFilter === 'all' || u.role === roleFilter) && (!searchTerm || (u.name || '').toLowerCase().includes(searchTerm)))
        .sort((a, b) => roleOrder.indexOf(a.role) - roleOrder.indexOf(b.role));

      const start = (currentUserPage - 1) * rowsPerPage;
      const paginatedUsers = filteredUsers.slice(start, start + rowsPerPage);
      
      if (paginatedUsers.length === 0 && filteredUsers.length > 0 && currentUserPage > 1) { currentUserPage = Math.ceil(filteredUsers.length / rowsPerPage); return displayUsers(currentUserPage); }
      
      elements.userPaginationControls.style.display = filteredUsers.length > rowsPerPage ? 'flex' : 'none';
      if (paginatedUsers.length === 0) {
        elements.userList.innerHTML = '<tr><td colspan="8">Tidak ada user ditemukan.</td></tr>';
      } else {
        paginatedUsers.forEach(u => {
          const tr = el('tr');
          const actionsCell = el('td', '', {'data-label': 'Aksi'});
          if (u.id !== currentUser.id && u.role !== 'super admin') {
              const itemInfo = u.name || `User ID ${u.id}`;
              if (currentUserData.role === 'super admin') {
                  actionsCell.appendChild(el('button', '<i class="fa-solid fa-trash"></i> Hapus', { class: 'btn-sm danger delete-btn', 'data-item-id': u.id, 'data-item-type': 'user', 'data-item-info': itemInfo }));
              } else if (currentUserData.role === 'admin') {
                  const existingRequest = allDeletionRequests.find(req => req.item_type === 'user' && req.item_id === u.id && req.status === 'pending');
                  if (existingRequest) {
                      actionsCell.appendChild(el('button', '<i class="fa-solid fa-clock"></i> Diminta', { class: 'btn-sm', disabled: true }));
                  } else {
                      actionsCell.appendChild(el('button', '<i class="fa-solid fa-user-slash"></i> Minta Hapus', { class: 'btn-sm warm request-deletion-btn', 'data-item-id': u.id, 'data-item-type': 'user', 'data-item-info': itemInfo }));
                  }
              }
          }
          tr.innerHTML = `<td data-label="Nama">${u.name || '-'}</td><td data-label="Role"><span class="role-badge role-${(u.role || '').replace(' ', '-')}">${u.role || '-'}</span></td><td data-label="NIK">${u.nik || '-'}</td><td data-label="Jenis Kelamin">${u.gender || '-'}</td><td data-label="Status Karyawan">${u.employee_status || '-'}</td><td data-label="Login Terakhir">${u.last_login ? new Date(u.last_login).toLocaleString('id-ID') : '-'}</td><td data-label="Status" class="${u.online ? 'status-online' : 'status-offline'}"><i class="fas fa-circle"></i> ${u.online ? 'Online' : 'Offline'}</td>`;
          tr.appendChild(actionsCell);
          elements.userList.appendChild(tr);
        });
      }
      const totalPages = Math.ceil(filteredUsers.length / rowsPerPage);
      elements.userPageInfo.textContent = `Halaman ${currentUserPage} dari ${totalPages || 1}`;
      elements.prevUserBtn.disabled = currentUserPage === 1;
      elements.nextUserBtn.disabled = currentUserPage >= totalPages;
    }
    elements.prevUserBtn.addEventListener('click', () => { if (currentUserPage > 1) displayUsers(currentUserPage - 1); });
    elements.nextUserBtn.addEventListener('click', () => { 
        const totalPages = Math.ceil(allUsers.filter(u => (elements.filterRole.value === 'all' || u.role === elements.filterRole.value)).length / rowsPerPage);
        if (currentUserPage < totalPages) displayUsers(currentUserPage + 1); 
    });
    
    async function createDeletionRequest(itemId, itemType, itemInfo) {
        if (!confirm(`Anda akan meminta Super Admin untuk menghapus ${itemType}: ${itemInfo}.\nLanjutkan?`)) return;
        const { error } = await supabase.from('deletion_requests').insert({ requested_by: currentUser.id, item_type: itemType, item_id: itemId, item_info: itemInfo });
        if (error) alert('Gagal mengirim permintaan: ' + error.message);
        else alert('Permintaan penghapusan telah dikirim.');
    }

    async function handleDeletionRequest(requestId, action, itemType, itemId, itemInfo) {
        const isDirectDelete = !requestId;
        if (action === 'approve') {
            if (!confirm(`Anda akan MENGHAPUS ${itemType} (${itemInfo}) ini secara permanen. Lanjutkan?`)) return;
            const { error: deleteError } = itemType === 'user'
                ? await supabase.functions.invoke('delete-user', { body: { uid: itemId } })
                : await supabase.from(itemType === 'route' ? 'routes' : 'vehicles').delete().eq('id', itemId);
            if (deleteError) { alert(`Gagal menghapus ${itemType}: ${deleteError.message}`); return; }
            if (isDirectDelete) { alert(`${itemType} berhasil dihapus.`); return; }
        }
        
        const newStatus = (action === 'approve') ? 'approved' : 'rejected';
        const { error } = await supabase.from('deletion_requests').update({ status: newStatus }).eq('id', requestId);
        if (error) alert('Gagal memperbarui status permintaan: ' + error.message);
        else alert(`Permintaan telah di-${newStatus}.`);
    }

    function displayDeletionRequests() {
        elements.deletionRequestList.innerHTML = '';
        if (allDeletionRequests.length === 0) {
            elements.deletionRequestList.innerHTML = '<tr><td colspan="6" class="empty-state">Tidak ada permintaan penghapusan.</td></tr>';
            return;
        }

        allDeletionRequests.forEach(req => {
            const tr = el('tr');
            let actionsHTML = '';
            if (req.status === 'pending') {
                actionsHTML = `<button class="btn-sm success" data-action="approve" data-req-id="${req.id}"><i class="fas fa-check"></i> Setujui</button> <button class="btn-sm danger" data-action="reject" data-req-id="${req.id}"><i class="fas fa-times"></i> Tolak</button>`;
            } else {
                actionsHTML = `<span class="status-${req.status}">${req.status}</span>`;
            }

            tr.innerHTML = `<td data-label="Tipe">${req.item_type}</td><td data-label="Detail Item">${req.item_info}</td><td data-label="Diminta oleh">${req.requester?.name || 'N/A'}</td><td data-label="Tanggal">${new Date(req.created_at).toLocaleString('id-ID')}</td><td data-label="Status">${badge(req.status)}</td><td data-label="Aksi">${actionsHTML}</td>`;
            Object.assign(tr.dataset, { itemType: req.item_type, itemId: req.item_id, itemInfo: req.item_info });
            elements.deletionRequestList.appendChild(tr);
        });
    }

    elements.deletionRequestList.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const tr = btn.closest('tr');
        handleDeletionRequest(btn.dataset.reqId, btn.dataset.action, tr.dataset.itemType, tr.dataset.itemId, tr.dataset.itemInfo);
    });
    
    // Event listener terpusat yang dikembalikan
    document.querySelector('.content-container').addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-item-id]');
        if (!btn) return;

        const { itemId, itemType, itemInfo } = btn.dataset;

        if (btn.classList.contains('request-deletion-btn')) {
            createDeletionRequest(itemId, itemType, itemInfo);
        } else if (btn.classList.contains('delete-btn')) {
            handleDeletionRequest(null, 'approve', itemType, itemId, itemInfo);
        }
    });

    function displayRoutes(page) {
      elements.routeList.innerHTML = '';
      currentRoutePage = page;
      const searchTerm = elements.searchRoute.value.toLowerCase();
      const filteredRoutes = allRoutes.filter(route => !searchTerm || `${route.code} ${route.address}`.toLowerCase().includes(searchTerm));
      const start = (currentRoutePage - 1) * rowsPerPage;
      const paginatedRoutes = filteredRoutes.slice(start, start + rowsPerPage);
      
      if (paginatedRoutes.length === 0 && filteredRoutes.length > 0 && currentRoutePage > 1) { currentRoutePage = Math.ceil(filteredRoutes.length / rowsPerPage); return displayRoutes(currentRoutePage); }
      
      elements.routePaginationControls.style.display = filteredRoutes.length > rowsPerPage ? 'flex' : 'none';
      if (paginatedRoutes.length === 0) {
        elements.routeList.innerHTML = '<tr><td colspan="3">Tidak ada rute ditemukan.</td></tr>';
      } else {
        paginatedRoutes.forEach(route => {
          const tr = el('tr');
          const actionsCell = el('td', '', {'data-label': 'Aksi'});
          const itemInfo = `${route.code} - ${route.address}`;
          if (currentUserData.role === 'super admin') {
              actionsCell.appendChild(el('button', '<i class="fa-solid fa-trash"></i> Hapus', { class: 'btn-sm danger delete-btn', 'data-item-id': route.id, 'data-item-type': 'route', 'data-item-info': itemInfo }));
          } else {
              const existingRequest = allDeletionRequests.find(req => req.item_type === 'route' && req.item_id == route.id && req.status === 'pending');
              if (existingRequest) {
                  actionsCell.appendChild(el('button', '<i class="fa-solid fa-clock"></i> Diminta', { class: 'btn-sm', disabled: true }));
              } else {
                  actionsCell.appendChild(el('button', '<i class="fa-solid fa-archive"></i> Minta Hapus', { class: 'btn-sm warm request-deletion-btn', 'data-item-id': route.id, 'data-item-type': 'route', 'data-item-info': itemInfo }));
              }
          }
          tr.innerHTML = `<td data-label="Kode">${route.code}</td><td data-label="Rute">${route.address}</td>`;
          tr.appendChild(actionsCell);
          elements.routeList.appendChild(tr);
        });
      }
      const totalPages = Math.ceil(filteredRoutes.length / rowsPerPage);
      elements.routePageInfo.textContent = `Halaman ${currentRoutePage} dari ${totalPages || 1}`;
      elements.prevRouteBtn.disabled = currentRoutePage === 1;
      elements.nextRouteBtn.disabled = currentRoutePage >= totalPages;
    }
    elements.prevRouteBtn.addEventListener('click', () => { if (currentRoutePage > 1) displayRoutes(currentRoutePage - 1); });
    elements.nextRouteBtn.addEventListener('click', () => { 
        const totalPages = Math.ceil(allRoutes.filter(r => !elements.searchRoute.value || `${r.code} ${r.address}`.toLowerCase().includes(elements.searchRoute.value.toLowerCase())).length / rowsPerPage); 
        if (currentRoutePage < totalPages) displayRoutes(currentRoutePage + 1); 
    });
    
    function displayVehicles(page) {
      elements.vehicleList.innerHTML = '';
      currentVehiclePage = page;
      const searchTerm = elements.searchVehicle.value.toLowerCase();
      const filteredVehicles = allVehicles.filter(v => !searchTerm || `${v.vehicle_number} ${v.unit}`.toLowerCase().includes(searchTerm));
      const start = (currentVehiclePage - 1) * rowsPerPage;
      const paginatedVehicles = filteredVehicles.slice(start, start + rowsPerPage);
      
      if (paginatedVehicles.length === 0 && filteredVehicles.length > 0 && currentVehiclePage > 1) { currentVehiclePage = Math.ceil(filteredVehicles.length / rowsPerPage); return displayVehicles(currentVehiclePage); }
      
      elements.vehiclePaginationControls.style.display = filteredVehicles.length > rowsPerPage ? 'flex' : 'none';
      if (paginatedVehicles.length === 0) {
        elements.vehicleList.innerHTML = '<tr><td colspan="4">Tidak ada kendaraan ditemukan.</td></tr>';
      } else {
        paginatedVehicles.forEach(vehicle => {
          const tr = el('tr');
          const actionsCell = el('td', '', {'data-label': 'Aksi'});
          const itemInfo = `${vehicle.vehicle_number} (${vehicle.unit})`;
          if (currentUserData.role === 'super admin') {
              actionsCell.appendChild(el('button', '<i class="fa-solid fa-trash"></i> Hapus', { class: 'btn-sm danger delete-btn', 'data-item-id': vehicle.id, 'data-item-type': 'vehicle', 'data-item-info': itemInfo }));
          } else {
              const existingRequest = allDeletionRequests.find(req => req.item_type === 'vehicle' && req.item_id == vehicle.id && req.status === 'pending');
              if (existingRequest) {
                  actionsCell.appendChild(el('button', '<i class="fa-solid fa-clock"></i> Diminta', { class: 'btn-sm', disabled: true }));
              } else {
                  actionsCell.appendChild(el('button', '<i class="fa-solid fa-archive"></i> Minta Hapus', { class: 'btn-sm warm request-deletion-btn', 'data-item-id': vehicle.id, 'data-item-type': 'vehicle', 'data-item-info': itemInfo }));
              }
          }
          tr.innerHTML = `<td data-label="No. Kendaraan">${vehicle.vehicle_number}</td><td data-label="Unit">${vehicle.unit || '-'}</td><td data-label="Kepemilikan">${vehicle.ownership || '-'}</td>`;
          tr.appendChild(actionsCell);
          elements.vehicleList.appendChild(tr);
        });
      }
      const totalPages = Math.ceil(filteredVehicles.length / rowsPerPage);
      elements.vehiclePageInfo.textContent = `Halaman ${currentVehiclePage} dari ${totalPages || 1}`;
      elements.prevVehicleBtn.disabled = currentVehiclePage === 1;
      elements.nextVehicleBtn.disabled = currentVehiclePage >= totalPages;
    }
    elements.prevVehicleBtn.addEventListener('click', () => { if (currentVehiclePage > 1) displayVehicles(currentVehiclePage - 1); });
    elements.nextVehicleBtn.addEventListener('click', () => { 
        const totalPages = Math.ceil(allVehicles.filter(v => !elements.searchVehicle.value || `${v.vehicle_number} ${v.unit}`.toLowerCase().includes(elements.searchVehicle.value.toLowerCase())).length / rowsPerPage); 
        if (currentVehiclePage < totalPages) displayVehicles(currentVehiclePage + 1);
    });

    function displayFinance(page) {
      elements.financeList.innerHTML = '';
      currentFinancePage = page;
      const searchTerm = elements.searchFinance.value.toLowerCase();
      const filteredTrips = allTrips.filter(trip => !searchTerm || `${trip.id} ${trip.driver_name} ${trip.asal} ${Array.isArray(trip.tujuan) ? trip.tujuan.join(' ') : trip.tujuan}`.toLowerCase().includes(searchTerm));
      const totalUangJalan = filteredTrips.reduce((sum, trip) => sum + (Number(trip.uang_jalan) || 0), 0);
      elements.totalUangJalan.textContent = idr(totalUangJalan);
      const start = (currentFinancePage - 1) * rowsPerPage;
      const paginatedTrips = filteredTrips.slice(start, start + rowsPerPage);
      
      elements.financePaginationControls.style.display = filteredTrips.length > rowsPerPage ? 'flex' : 'none';
      if (paginatedTrips.length === 0) {
        elements.financeList.innerHTML = '<tr><td colspan="5" class="empty-state">Tidak ada data keuangan ditemukan.</td></tr>';
      } else {
        paginatedTrips.forEach(trip => {
          const tr = el('tr');
          const ruteDisplay = `${routeCodeMap[trip.asal] || trip.asal}, ${Array.isArray(trip.tujuan) ? trip.tujuan.map(t => routeCodeMap[t] || t).join(', ') : (routeCodeMap[trip.tujuan] || trip.tujuan)}`;
          tr.innerHTML = `<td data-label="Trip ID">${trip.id}</td><td data-label="Rute">${ruteDisplay}</td><td data-label="Supir">${trip.driver_name || 'N/A'}</td><td data-label="Tanggal">${fmtDate(trip.tanggal)}</td><td data-label="Uang Jalan">${idr(trip.uang_jalan)}</td>`;
          elements.financeList.appendChild(tr);
        });
      }
      const totalPages = Math.ceil(filteredTrips.length / rowsPerPage);
      elements.financePageInfo.textContent = `Halaman ${currentFinancePage} dari ${totalPages || 1}`;
      elements.prevFinanceBtn.disabled = currentFinancePage === 1;
      elements.nextFinanceBtn.disabled = currentFinancePage >= totalPages;
    }
    elements.prevFinanceBtn.addEventListener('click', () => { if (currentFinancePage > 1) displayFinance(currentFinancePage - 1); });
    elements.nextFinanceBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(allTrips.filter(t => !elements.searchFinance.value || `${t.id} ${t.driver_name}`.toLowerCase().includes(elements.searchFinance.value.toLowerCase())).length / rowsPerPage);
        if (currentFinancePage < totalPages) displayFinance(currentFinancePage + 1);
    });

    elements.addVehicleForm.addEventListener('submit', async (e) => { 
        e.preventDefault(); 
        const { value: vehicleNumber } = document.getElementById('vehicleNumberInput');
        const { value: unit } = document.getElementById('vehicleUnit');
        const { value: ownership } = document.getElementById('vehicleOwnership');
        elements.addVehicleStatus.style.display = 'block'; elements.addVehicleStatus.textContent = 'Menambahkan...'; 
        const { error } = await supabase.from('vehicles').insert([{ vehicle_number: vehicleNumber.toUpperCase(), unit, ownership }]);
        if (error) elements.addVehicleStatus.textContent = 'Gagal: ' + error.message;
        else {
            elements.addVehicleStatus.textContent = 'âœ”ï¸ Kendaraan berhasil ditambahkan.'; 
            e.target.reset(); 
            setTimeout(() => { elements.addVehicleStatus.style.display = 'none'; }, 3000);
        }
    });

    elements.addRouteForm.addEventListener('submit', async (e) => { 
        e.preventDefault(); 
        const { value: code } = document.getElementById('routeCode');
        const { value: address } = document.getElementById('routeAddress');
        elements.addRouteStatus.style.display = 'block'; elements.addRouteStatus.textContent = 'Menambahkan...';
        const { error } = await supabase.from('routes').insert([{ code: code.toUpperCase(), address }]);
        if (error) elements.addRouteStatus.textContent = 'Gagal: ' + error.message; 
        else {
            elements.addRouteStatus.textContent = 'âœ”ï¸ Rute berhasil ditambahkan.'; 
            e.target.reset(); 
            setTimeout(() => { elements.addRouteStatus.style.display = 'none'; }, 3000); 
        }
    });

    elements.addUserForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        elements.addUserStatus.style.display = 'block'; 
        elements.addUserStatus.textContent = 'Menambahkan...';
        
        const { data, error } = await supabase.functions.invoke('create-user', { 
            body: { 
                email: document.getElementById('newUserEmail').value,
                password: document.getElementById('newUserPassword').value,
                name: document.getElementById('newUserName').value,
                role: document.getElementById('newUserRole').value,
                nik: document.getElementById('newUserNik').value,
                gender: document.getElementById('newUserGender').value,
                employeeStatus: document.getElementById('newUserStatus').value,
             } 
        });

        if (error || (data && data.error)) {
            elements.addUserStatus.textContent = 'Gagal: ' + (error?.message || data.error);
        } else {
            elements.addUserStatus.textContent = `âœ”ï¸ User ${data.name || 'baru'} berhasil ditambahkan.`;
            e.target.reset();
            setTimeout(() => { elements.addUserStatus.style.display = 'none'; }, 3000);
        }
    });
    
    function loadRoleStats() { 
        if (allUsers.length === 0) { elements.roleStats.textContent = "Tidak ada data untuk ditampilkan."; return; }
        const userMap = Object.fromEntries(allUsers.map(user => [user.id, user]));
        let activities = { admin: [], coordinator: [], driver: [] }; 
        allTrips.forEach(trip => { 
            const tripInfo = `${routeCodeMap[trip.asal] || trip.asal}, ${Array.isArray(trip.tujuan) ? trip.tujuan.map(t => routeCodeMap[t] || t).join(', ') : (routeCodeMap[trip.tujuan] || trip.tujuan)}`;
            if (trip.approved_by && trip.approved_at) activities.admin.push({ userId: trip.approved_by, time: trip.approved_at, action: `Menyetujui trip dari ${userMap[trip.coor_id]?.name || 'N/A'}` }); 
            if (trip.rejected_by && trip.rejected_at) activities.admin.push({ userId: trip.rejected_by, time: trip.rejected_at, action: `Menolak trip dari ${userMap[trip.coor_id]?.name || 'N/A'}` }); 
            if (trip.coor_id && trip.created_at) activities.coordinator.push({ userId: trip.coor_id, time: trip.created_at, action: `Membuat trip untuk ${trip.driver_name || 'N/A'}` }); 
            if (trip.driver_id && trip.arrived_at) activities.driver.push({ userId: trip.driver_id, time: trip.arrived_at, action: `Menyelesaikan trip ${tripInfo}` }); 
        }); 
        
        const createActivityTable = (role, title) => { 
            let tableHtml = `<h4>${title} (${activities[role].length} Total Aksi)</h4>`; 
            if (activities[role].length === 0) return tableHtml + `<p class="empty-state">Belum ada aktivitas.</p>`;
            const sortedActivities = activities[role].sort((a, b) => new Date(b.time) - new Date(a.time)).slice(0, 15); 
            tableHtml += `<div class="table-responsive"><table><thead><tr><th>Nama</th><th>Aksi</th><th>Waktu</th></tr></thead><tbody>`; 
            sortedActivities.forEach(act => { 
                tableHtml += `<tr><td data-label="Nama">${userMap[act.userId]?.name || 'User Dihapus'}</td><td data-label="Aksi">${act.action}</td><td data-label="Waktu">${new Date(act.time).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}</td></tr>`; 
            }); 
            return tableHtml + '</tbody></table></div>'; 
        }; 
        elements.roleStats.innerHTML = `${createActivityTable('admin', 'Aktivitas Admin')}<hr>${createActivityTable('coordinator', 'Aktivitas Koordinator')}<hr>${createActivityTable('driver', 'Aktivitas Supir')}`; 
    }
    
    function displayLockdownUsers() {
      elements.lockdownUserList.innerHTML = '';
      let allLocked = true;
      let eligibleUsers = 0;
      const sortedUsers = [...allUsers].sort((a, b) => ['super admin', 'admin', 'coordinator', 'driver'].indexOf(a.role) - ['super admin', 'admin', 'coordinator', 'driver'].indexOf(b.role));
      
      sortedUsers.forEach(user => {
        const tr = el('tr');
        const statusCell = el('td', '', {'data-label': 'Status Pengguna'});
        if (user.role === 'super admin') {
          statusCell.textContent = 'Tidak dapat dinonaktifkan';
        } else {
          eligibleUsers++;
          if (!user.locked) allLocked = false;
          const switchLabel = el('label', '', { class: 'switch' });
          const switchInput = el('input', '', { type: 'checkbox' });
          switchInput.checked = user.locked || false;
          switchInput.addEventListener('change', async (e) => {
            const { error } = await supabase.from('users').update({ locked: e.target.checked }).eq('id', user.id);
            if (error) { alert('Gagal mengubah status: ' + error.message); e.target.checked = !e.target.checked; }
          });
          switchLabel.append(switchInput, el('span', '', { class: 'slider' }));
          statusCell.appendChild(switchLabel);
        }
        tr.innerHTML = `<td data-label="Nama Pengguna">${user.name || 'N/A'}</td><td data-label="Role">${user.role || 'N/A'}</td>`;
        tr.appendChild(statusCell);
        elements.lockdownUserList.appendChild(tr);
      });
      elements.massLockdownSwitch.checked = eligibleUsers > 0 && allLocked;
    }

    elements.massLockdownSwitch.addEventListener('change', async (e) => {
      const lock = e.target.checked;
      if (confirm(`Anda yakin ingin ${lock ? 'menonaktifkan' : 'mengaktifkan'} semua pengguna (kecuali super admin)?`)) {
        const usersToUpdate = allUsers.filter(u => u.role !== 'super admin').map(u => u.id);
        if (usersToUpdate.length > 0) {
            const { error } = await supabase.from('users').update({ locked: lock }).in('id', usersToUpdate);
            if (error) alert('Gagal memperbarui status pengguna: ' + error.message);
            else alert('Status semua pengguna berhasil diperbarui.');
        }
      } else {
        e.target.checked = !lock;
      }
    });

    elements.logoutBtn.addEventListener('click', async () => { 
        await supabase.auth.signOut();
        window.location.href = 'login.html';
    });

    const { jsPDF } = window.jspdf;

    function exportToExcel(data, filename, title) {
        if (data.length === 0) { alert("Tidak ada data untuk diekspor."); return; }
        const worksheet = XLSX.utils.json_to_sheet(data, { origin: 'A2' });
        XLSX.utils.sheet_add_aoa(worksheet, [[title]], { origin: 'A1' });
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Laporan');
        XLSX.writeFile(workbook, `${filename}_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function exportToPDF(headers, body, filename, title, summary) {
        if (body.length === 0) { alert("Tidak ada data untuk diekspor."); return; }
        const doc = new jsPDF();
        doc.setFontSize(18); doc.setFont('helvetica', 'bold'); doc.text('PT MAJU MUNDUR SYANTIQ', 14, 22);
        doc.setFontSize(11); doc.setFont('helvetica', 'normal'); doc.text('Dahromo 1, RT.02, Segoroyoso, Pleret, Bantul, DIY 55791', 14, 30);
        doc.setLineWidth(0.5); doc.line(14, 35, 196, 35);
        doc.setFontSize(16); doc.setFont('helvetica', 'bold'); doc.text(title, 105, 45, { align: 'center' });
        doc.setFontSize(10); doc.setFont('helvetica', 'normal'); doc.text(summary, 14, 55);
        doc.autoTable({ 
            head: [headers], body: body, startY: 60, theme: 'grid',
            headStyles: { fillColor: [26, 34, 53] }, styles: { fontSize: 9 },
            didDrawPage: function (data) {
                doc.setFontSize(8);
                doc.text(`Halaman ${data.pageNumber} dari ${doc.internal.getNumberOfPages()}`, data.settings.margin.left, doc.internal.pageSize.height - 10);
                doc.text(`Dicetak pada: ${new Date().toLocaleString('id-ID')}`, doc.internal.pageSize.width - data.settings.margin.right, doc.internal.pageSize.height - 10, { align: 'right' });
            }
        });
        doc.save(`${filename}_${new Date().toISOString().slice(0,10)}.pdf`);
    }
    
    function handleExport(format) {
      const reportType = elements.reportType.value;
      let data, headers, filename, title, summary;
      const statusMap = { submitted: "Menunggu", approved: "Disetujui", delivering: "Dalam Perjalanan", arriving_soon: "Hampir Sampai", arrived: "Selesai", rejected: "Ditolak" };
      switch (reportType) {
        case 'trips':
          const startDate = elements.startDate.value, endDate = elements.endDate.value;
          if (!startDate || !endDate) { alert("Silakan pilih rentang tanggal terlebih dahulu."); return; }
          data = allTrips.filter(t => t.tanggal >= startDate && t.tanggal <= endDate).map(t => ({ 'Rute': `${routeCodeMap[t.asal] || t.asal}, ${Array.isArray(t.tujuan) ? t.tujuan.map(tujuan => routeCodeMap[tujuan] || tujuan).join(', ') : (routeCodeMap[t.tujuan] || t.tujuan)}`, 'Supir': t.driver_name || 'N/A', 'Kendaraan': t.vehicle_number || 'N/A', 'Muatan': t.muatan || 'N/A', 'Uang Jalan': idr(t.uang_jalan), 'Tanggal': fmtDate(t.tanggal), 'Status': statusMap[t.status] || t.status }));
          headers = ["Rute", "Supir", "Kendaraan", "Muatan", "Uang Jalan", "Tanggal", "Status"];
          filename = 'Laporan_Perjalanan'; title = `Laporan Perjalanan`; summary = `Periode: ${fmtDate(startDate)} - ${fmtDate(endDate)}\nTotal: ${data.length} perjalanan`;
          break;
        case 'users':
          data = allUsers.map(u => ({ 'Nama': u.name || '-', 'Role': u.role || '-', 'Login Terakhir': u.last_login ? new Date(u.last_login).toLocaleString('id-ID') : '-', 'Status': u.online ? 'Online' : 'Offline' }));
          headers = ["Nama", "Role", "Login Terakhir", "Status"];
          filename = 'Laporan_Pengguna'; title = 'Laporan Data Pengguna'; summary = `Total: ${data.length} pengguna`;
          break;
        case 'routes':
          data = allRoutes.map(r => ({ 'Kode': r.code, 'Alamat/Lokasi': r.address }));
          headers = ["Kode", "Alamat/Lokasi"];
          filename = 'Laporan_Rute'; title = 'Laporan Data Rute'; summary = `Total: ${data.length} rute`;
          break;
        case 'vehicles':
          data = allVehicles.map(v => ({ 'No. Kendaraan': v.vehicle_number, 'Unit': v.unit, 'Kepemilikan': v.ownership }));
          headers = ["No. Kendaraan", "Unit", "Kepemilikan"];
          filename = 'Laporan_Kendaraan'; title = 'Laporan Data Kendaraan'; summary = `Total: ${data.length} kendaraan`;
          break;
      }
      if (format === 'excel') exportToExcel(data, filename, title); 
      else if (format === 'pdf') exportToPDF(headers, data.map(Object.values), filename, title, summary);
    }
    
    async function handleBackup() {
        alert("Memulai proses backup...");
        try {
            const [users, trips, routes, vehicles] = await Promise.all([
                supabase.from('users').select('*'), supabase.from('trips').select('*'),
                supabase.from('routes').select('*'), supabase.from('vehicles').select('*')
            ]);
            const dataToBackup = { users: users.data, trips: trips.data, routes: routes.data, vehicles: vehicles.data };
            const blob = new Blob([JSON.stringify(dataToBackup, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `backup-sla-trucking-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
            alert('Backup berhasil diunduh!');
        } catch (error) {
            console.error("Gagal melakukan backup:", error);
            alert(`Gagal melakukan backup: ${error.message}.`);
        }
    }

    async function handleRestore() {
        const file = elements.restoreFileInput.files[0];
        if (!file) { alert('Silakan pilih file backup terlebih dahulu.'); return; }
        if (!confirm('PERINGATAN!\nAnda akan menimpa SEMUA data. Aksi ini tidak dapat dibatalkan.\nLanjutkan?')) return;
        if (!confirm('KONFIRMASI AKHIR!\nData lama akan hilang selamanya.\nLanjutkan pemulihan data?')) return;
        
        const reader = new FileReader();
        reader.onload = async (event) => {
            try {
                const data = JSON.parse(event.target.result);
                elements.restoreStatus.textContent = 'Memulihkan data... Harap tunggu.';
                if (!data.users || !data.trips || !data.routes || !data.vehicles) throw new Error("File backup tidak valid.");
                
                await supabase.from('trips').delete().neq('id', 0);
                await supabase.from('vehicles').delete().neq('id', 0);
                await supabase.from('routes').delete().neq('id', 0);
                
                await supabase.from('users').upsert(data.users);
                await supabase.from('trips').insert(data.trips);
                await supabase.from('vehicles').insert(data.vehicles);
                await supabase.from('routes').insert(data.routes);
                
                elements.restoreStatus.textContent = 'âœ”ï¸ Data berhasil dipulihkan. Halaman akan dimuat ulang.';
                alert('Data berhasil dipulihkan.');
                setTimeout(() => window.location.reload(), 2000);
            } catch (error) {
                elements.restoreStatus.textContent = `Gagal: ${error.message}`;
                alert(`Gagal memulihkan data: ${error.message}`);
            }
        };
        reader.readAsText(file);
    }

    elements.downloadBackupBtn.addEventListener('click', handleBackup);
    elements.restoreBackupBtn.addEventListener('click', handleRestore);
    elements.reportType.addEventListener('change', (e) => { elements.dateFilterContainer.style.display = (e.target.value === 'trips') ? 'grid' : 'none'; });
    elements.exportExcelBtn.addEventListener('click', () => handleExport('excel'));
    elements.exportPdfBtn.addEventListener('click', () => handleExport('pdf'));

    (async () => {
        await checkUserSession();
        await loadInitialData();
        setupRealtimeListeners();
    })();
  </script>
</body>
</html>
