<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>Forum & Chat</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="content-wrapper">
    <nav class="sidebar">
      <div class="sidebar-wrapper">
        <div class="sidebar-header">
          <h2>Deep Chat</h2>
        </div>
        <div class="sidebar-account">
          <p id="userName">Memuat...</p>
          <small id="userEmail">Memuat...</small>
        </div>
        <div id="chat-list-container" class="sidebar-menu">
          <div class="chat-list-header-wrapper">
            <h4 class="chat-list-header">Grup Chat</h4>
            <button id="createGroupBtn" class="btn-sm" style="display: none;"><i class="fas fa-plus"></i></button>
          </div>
          <div class="form-group" style="padding: 0 1.5rem;">
            <input type="text" id="searchGroup" placeholder="Cari grup..." style="padding: 0.8rem 1.2rem; font-size: 1.3rem;">
          </div>
          <ul id="group-list">
             </ul>
          <h4 class="chat-list-header">Personal Chat</h4>
          <div class="form-group" style="padding: 0 1.5rem;">
            <input type="text" id="searchUser" placeholder="Cari nama..." style="padding: 0.8rem 1.2rem; font-size: 1.3rem;">
          </div>
          <ul id="user-list">
            </ul>
        </div>
        <div class="sidebar-footer">
          <button id="logoutBtn" class="logout-button"><i class="fa-solid fa-right-from-bracket"></i> Keluar</button>
          <p>V.3.0.4</p>
        </div>
      </div>
    </nav>

    <main class="main-content">
      <div class="main-wrapper">
        <header class="main-header">
          <div class="main-header-content">
            <h1 id="chatTitle"><i class="fas fa-comments"></i> Selamat Datang di Forum</h1>
            <p id="chatSubtitle">Pilih grup atau pengguna untuk memulai percakapan.</p>
          </div>
          <div class="main-header-menu">
            <button id="manageMembersBtn" class="btn-sm info" style="display: none;"><i class="fas fa-users-cog"></i> Kelola Anggota</button>
            <button id="manageGroupBtn" class="btn-sm" style="display: none; margin-left: 1rem;"><i class="fas fa-edit"></i> Kelola Grup</button>
          </div>
        </header>
        <div class="content-container" id="chat-area">
          <div class="chat-messages" id="message-list">
             </div>
        </div>
        <div class="chat-input-area">
           <div id="replying-to-banner" class="reply-banner" style="display: none;">
              <div>
                  <p class="reply-banner-header">Membalas kepada <strong id="replying-to-user"></strong></p>
                  <p id="replying-to-text" class="reply-banner-text"></p>
              </div>
              <button id="cancel-reply-btn"><i class="fa-solid fa-xmark"></i></button>
           </div>
          <form id="messageForm" class="chat-form">
            <input type="text" id="messageInput" style="background-color: var(--light-gunmetal);" placeholder="Ketik pesan Anda..." autocomplete="off" disabled>
            <button type="submit" id="sendMessageBtn" disabled><i class="fas fa-paper-plane"></i></button>
          </form>
        </div>
      </div>
    </main>
  </div>

  <div id="reportModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeReportModal"><i class="fa-solid fa-xmark"></i></span>
      <h2>Laporkan Pesan</h2>
      <p style="font-size: 1.5rem; color: var(--slate-gray); margin: 1rem 0;">Anda akan melaporkan pesan berikut:</p>
      <p id="reportedMessageText" class="modal-quote"></p>
      <div class="form-group">
        <label for="reportReason">Alasan Pelaporan</label>
        <select id="reportReason">
          <option value="ancaman">Ancaman atau Kekerasan</option>
          <option value="sara">Ujaran Kebencian (SARA)</option>
          <option value="cabul">Konten Tidak Pantas/Cabul</option>
          <option value="spam">Spam atau Penipuan</option>
          <option value="lainnya">Lainnya</option>
        </select>
      </div>
      <button id="submitReportBtn" style="width: 100%;">Kirim Laporan</button>
    </div>
  </div>

  <div id="createGroupModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeCreateGroupModal"><i class="fa-solid fa-xmark"></i></span>
      <h2>Buat Grup Baru</h2>
      <form id="createGroupForm">
        <div class="form-group">
          <label for="groupNameInput">Nama Grup</label>
          <input type="text" id="groupNameInput" placeholder="Contoh: Koordinasi Proyek X" required>
        </div>
        <div class="form-group">
          <label for="groupDescriptionInput">Deskripsi Grup</label>
          <textarea id="groupDescriptionInput" placeholder="Jelaskan tujuan dari grup ini..." rows="3" style="resize: none;"></textarea>
        </div>
        <button type="submit" style="width: 100%;">Buat Grup</button>
      </form>
    </div>
  </div>

  <div id="manageMembersModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <span class="close-modal" id="closeManageMembersModal"><i class="fa-solid fa-xmark"></i></span>
      <h2 id="manageMembersTitle">Kelola Anggota</h2>
      <div class="members-management-container">
        <div class="members-list-container">
          <h4>Anggota Saat Ini</h4>
          <ul id="currentMembersList" class="modal-user-list"></ul>
        </div>
        <div class="members-list-container">
          <h4>Tambah Anggota Baru</h4>
          <ul id="addMembersList" class="modal-user-list"></ul>
        </div>
      </div>
    </div>
  </div>

  <div id="manageGroupModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeManageGroupModal"><i class="fa-solid fa-xmark"></i></span>
      <h2 id="manageGroupTitle">Kelola Grup</h2>
      <form id="manageGroupForm">
        <div class="form-group">
          <label for="groupNameEditInput">Nama Grup</label>
          <input type="text" id="groupNameEditInput" required>
        </div>
        <div class="form-group">
          <label for="groupDescriptionEditInput">Deskripsi Grup</label>
          <textarea id="groupDescriptionEditInput" rows="3" style="resize: none;"></textarea>
        </div>
        <button type="submit" style="width: 100%; margin-bottom: 1rem;">Simpan Perubahan</button>
      </form>
      <button id="deleteGroupBtn" class="logout-button" style="width: 100%; display: none;"><i class="fas fa-trash"></i> Hapus Grup Ini</button>
    </div>
  </div>


  <script type="module">
    import { auth, onAuthStateChanged, signOut, db, ref, onValue, update, get, set, push, serverTimestamp, query, orderByChild, equalTo } from './firebase.js';
    import { el } from './utils.js';

    let currentUser = null;
    let currentUserData = null;
    let allUsers = {};
    let activeChatId = null;
    let activeGroupData = null;
    let replyingTo = null;
    let messageToReport = null;
    let isInitialChatLoad = true; // Flag untuk menandai pemuatan awal
    
    const elements = {
        userName: document.getElementById('userName'),
        userEmail: document.getElementById('userEmail'),
        userList: document.getElementById('user-list'),
        groupList: document.getElementById('group-list'),
        searchGroup: document.getElementById('searchGroup'),
        searchUser: document.getElementById('searchUser'),
        chatTitle: document.getElementById('chatTitle'),
        chatSubtitle: document.getElementById('chatSubtitle'),
        messageList: document.getElementById('message-list'),
        messageForm: document.getElementById('messageForm'),
        messageInput: document.getElementById('messageInput'),
        sendMessageBtn: document.getElementById('sendMessageBtn'),
        logoutBtn: document.getElementById('logoutBtn'),
        replyingToBanner: document.getElementById('replying-to-banner'),
        replyingToUser: document.getElementById('replying-to-user'),
        replyingToText: document.getElementById('replying-to-text'),
        cancelReplyBtn: document.getElementById('cancel-reply-btn'),
        reportModal: document.getElementById('reportModal'),
        closeReportModal: document.getElementById('closeReportModal'),
        reportedMessageText: document.getElementById('reportedMessageText'),
        reportReason: document.getElementById('reportReason'),
        submitReportBtn: document.getElementById('submitReportBtn'),
        createGroupBtn: document.getElementById('createGroupBtn'),
        createGroupModal: document.getElementById('createGroupModal'),
        closeCreateGroupModal: document.getElementById('closeCreateGroupModal'),
        createGroupForm: document.getElementById('createGroupForm'),
        groupNameInput: document.getElementById('groupNameInput'),
        groupDescriptionInput: document.getElementById('groupDescriptionInput'),
        manageMembersBtn: document.getElementById('manageMembersBtn'),
        manageMembersModal: document.getElementById('manageMembersModal'),
        closeManageMembersModal: document.getElementById('closeManageMembersModal'),
        manageMembersTitle: document.getElementById('manageMembersTitle'),
        currentMembersList: document.getElementById('currentMembersList'),
        addMembersList: document.getElementById('addMembersList'),
        manageGroupBtn: document.getElementById('manageGroupBtn'),
        manageGroupModal: document.getElementById('manageGroupModal'),
        closeManageGroupModal: document.getElementById('closeManageGroupModal'),
        manageGroupTitle: document.getElementById('manageGroupTitle'),
        manageGroupForm: document.getElementById('manageGroupForm'),
        groupNameEditInput: document.getElementById('groupNameEditInput'),
        groupDescriptionEditInput: document.getElementById('groupDescriptionEditInput'),
        deleteGroupBtn: document.getElementById('deleteGroupBtn'),
    };

    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = 'index.html'; return; }
        currentUser = user;
        const userSnap = await get(ref(db, `users/${currentUser.uid}`));
        if (userSnap.exists()) {
            currentUserData = userSnap.val();
            elements.userName.textContent = currentUserData.name || 'Pengguna';
            elements.userEmail.textContent = currentUser.email;
            
            if (currentUserData.role === 'admin' || currentUserData.role === 'super admin') {
                elements.createGroupBtn.style.display = 'block';
            }
        }
        
        loadAllUsersAndThenChats();
        setupEventListeners();
    });
    
    // Fungsi untuk mengubah teks URL menjadi link aktif
    function linkify(text) {
        const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        // Ganti plain text dengan elemen sementara untuk mencegah double-escaping
        const tempElement = document.createElement('div');
        tempElement.textContent = text;
        
        return tempElement.innerHTML.replace(urlRegex, function(url) {
            let href = url;
            if (!href.match(/^(https?|ftp|file):\/\//)) {
                href = 'https://' + href;
            }
            return `<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
        });
    }

    // Fungsi untuk mengelola kelas 'active' pada link chat di sidebar
    function updateActiveLinkInSidebar() {
        document.querySelectorAll('#group-list a, #user-list a').forEach(link => {
            if (link.dataset.chatId === activeChatId) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });
    }

    function loadAllUsersAndThenChats() {
        onValue(ref(db, 'users'), (snapshot) => {
            if(snapshot.exists()) {
                allUsers = snapshot.val();
                loadChatLists();
            }
        });
    }

    function loadChatLists() {
        const groupsRef = ref(db, 'groups');
        onValue(groupsRef, (snapshot) => {
            const groupSearchTerm = elements.searchGroup.value.toLowerCase();
            elements.groupList.innerHTML = '';
            
            const generalGroup = { id: 'general', name: 'Diskusi Umum' };
            if (generalGroup.name.toLowerCase().includes(groupSearchTerm)) {
                const liGeneral = el('li');
                const aGeneral = el('a', `<i class="fas fa-users"></i> ${generalGroup.name}`, { href: '#', 'data-chat-id': 'general' });
                aGeneral.onclick = (e) => { e.preventDefault(); openChat(generalGroup.id, generalGroup.name, 'group', generalGroup); };
                liGeneral.appendChild(aGeneral);
                elements.groupList.appendChild(liGeneral);
            }

            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const group = { id: child.key, ...child.val() };
                    if (group.name.toLowerCase().includes(groupSearchTerm)) {
                        const isMember = group.members && group.members[currentUser.uid];
                        const isAdmin = currentUserData.role === 'admin' || currentUserData.role === 'super admin';
                        
                        const li = el('li');
                        const icon = isMember || isAdmin ? '<i class="fas fa-users"></i>' : '<i class="fas fa-lock"></i>';
                        const a = el('a', `${icon} ${group.name}`, { href: '#', 'data-chat-id': group.id });
                        a.onclick = (e) => { e.preventDefault(); openChat(group.id, group.name, 'group', group); };
                        li.appendChild(a);
                        elements.groupList.appendChild(li);
                    }
                });
            }
            
            if (isInitialChatLoad && elements.groupList.firstChild) {
                elements.groupList.firstChild.querySelector('a').click();
                isInitialChatLoad = false;
            } else {
                updateActiveLinkInSidebar();
            }
        });

        const userSearchTerm = elements.searchUser.value.toLowerCase();
        elements.userList.innerHTML = '';
        Object.entries(allUsers).forEach(([uid, userData]) => {
            if (uid === currentUser.uid) return;
            if ((userData.name || '').toLowerCase().includes(userSearchTerm)) {
                const chatId = [currentUser.uid, uid].sort().join('_');
                const li = el('li');
                const onlineIndicator = userData.online ? '<i class="fas fa-circle status-online" style="font-size: 0.8rem;"></i>' : '<i class="fas fa-circle status-offline" style="font-size: 0.8rem;"></i>';
                const a = el('a', `${onlineIndicator} ${userData.name || 'Tanpa Nama'}`, { href: '#', 'data-chat-id': chatId });
                a.onclick = (e) => {
                    e.preventDefault();
                    openChat(chatId, userData.name, 'personal', { otherUserId: uid });
                };
                li.appendChild(a);
                elements.userList.appendChild(li);
            }
        });
        updateActiveLinkInSidebar();
    }

    function openChat(chatId, chatName, type, metaData = null) {
        // Set ID chat yang aktif dan perbarui sidebar
        activeChatId = chatId;
        updateActiveLinkInSidebar();

        if (type === 'group' && metaData && metaData.id !== 'general') {
            const isAdmin = currentUserData.role === 'admin' || currentUserData.role === 'super admin';
            const isMember = metaData.members && metaData.members[currentUser.uid];
            if (!isAdmin && !isMember) {
                alert(`Maaf, sistem mendeteksi bahwa Anda bukan bagian dari grup ${chatName}`);
                return;
            }
        }
        
        activeGroupData = (type === 'group') ? metaData : null;

        if (type === 'personal') {
            const otherUserId = metaData.otherUserId;
            const otherUser = allUsers[otherUserId];
            const roleClass = (otherUser.role || '').replace(' ', '-');
            elements.chatTitle.innerHTML = `<i class="fas fa-user"></i> ${chatName} <span class="role-badge role-${roleClass}" style="font-size: 1.2rem; vertical-align: middle; margin-left: 1rem;">${otherUser.role}</span>`;
            elements.chatSubtitle.textContent = `Percakapan dengan ${chatName}`;
        } else {
            elements.chatTitle.innerHTML = `<i class="fas fa-users"></i> ${chatName}`;
            // Menampilkan deskripsi grup jika ada
            const groupDescription = metaData && metaData.description ? metaData.description : `Grup: ${chatName}`;
            elements.chatSubtitle.textContent = groupDescription;
        }

        elements.messageInput.disabled = false;
        elements.sendMessageBtn.disabled = false;
        elements.messageList.innerHTML = '<p class="empty-state">Memuat pesan...</p>';
        
        const isAdmin = currentUserData.role === 'admin' || currentUserData.role === 'super admin';
        const isCreator = metaData && metaData.createdBy === currentUser.uid;
        
        elements.manageMembersBtn.style.display = (type === 'group' && metaData && metaData.id !== 'general' && isAdmin) ? 'block' : 'none';
        elements.manageGroupBtn.style.display = (type === 'group' && metaData && metaData.id !== 'general' && (isAdmin || isCreator)) ? 'block' : 'none';

        const messagesRef = query(ref(db, `chats/${activeChatId}`), orderByChild('timestamp'));
        onValue(messagesRef, (snapshot) => {
            elements.messageList.innerHTML = '';
            if (!snapshot.exists()) {
                elements.messageList.innerHTML = '<p class="empty-state">Belum ada pesan. Mulai percakapan!</p>';
                return;
            }
            snapshot.forEach(child => {
                displayMessage(child.key, child.val());
            });
            elements.messageList.scrollTop = elements.messageList.scrollHeight;
        });
    }

    async function displayMessage(msgId, msgData) {
        const isMe = msgData.senderId === currentUser.uid;
        const msgWrapper = el('div', '', { class: `message-wrapper ${isMe ? 'sent' : 'received'}` });
        const msgBubble = el('div', '', { class: 'message-bubble' });

        if (msgData.deleted) {
            const text = el('p', msgData.text, { class: 'message-text' });
            text.style.fontStyle = 'italic';
            text.style.opacity = '0.7';
            const time = new Date(msgData.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            const footer = el('p', time, { class: 'message-footer' });
            msgBubble.append(text, footer);
            msgWrapper.append(msgBubble);
        } else {
            const senderInfo = allUsers[msgData.senderId] || { name: 'Pengguna Dihapus', role: '' };
            const senderName = isMe ? 'Anda' : senderInfo.name;
            const senderRole = msgData.senderRole || senderInfo.role;
            const roleClass = (senderRole || '').replace(' ', '-');
            
            const headerHTML = `${senderName} <span class="role-badge role-${roleClass}" style="font-size: 1rem; vertical-align: middle;">${senderRole}</span>`;
            const header = el('p', '', { class: 'message-header' });
            header.innerHTML = headerHTML;
            
            let repliedMsgHtml = '';
            if (msgData.replyingToId) {
                const repliedMsgSnap = await get(ref(db, `chats/${activeChatId}/${msgData.replyingToId}`));
                if (repliedMsgSnap.exists()) {
                    const repliedMsg = repliedMsgSnap.val();
                    if (!repliedMsg.deleted) {
                        repliedMsgHtml = `<div class="replied-message">
                            <p class="replied-header">${repliedMsg.senderName}</p>
                            <p class="replied-text">${repliedMsg.text}</p>
                        </div>`;
                    }
                }
            }

            const text = el('p', '', { class: 'message-text' });
            text.innerHTML = linkify(msgData.text); // Gunakan fungsi linkify di sini
            const time = new Date(msgData.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            const footer = el('p', time, { class: 'message-footer' });
            
            const actions = el('div', '', { class: 'message-actions' });
            const replyBtn = el('button', '<i class="fas fa-reply"></i>', { class: 'btn-sm' });
            replyBtn.onclick = () => setReplyingTo(msgId, msgData);
            
            const reportBtn = el('button', '<i class="fas fa-flag"></i>', { class: 'btn-sm danger' });
            reportBtn.onclick = () => openReportModal(msgId, msgData);
            
            actions.append(replyBtn, reportBtn);

            const isAdminOrSuperAdmin = currentUserData.role === 'admin' || currentUserData.role === 'super admin';
            if (isMe || isAdminOrSuperAdmin) {
                const deleteBtn = el('button', '<i class="fas fa-trash"></i>', { class: 'btn-sm danger' });
                deleteBtn.onclick = () => deleteMessage(msgId, msgData);
                actions.append(deleteBtn);
            }

            msgBubble.innerHTML = repliedMsgHtml;
            msgBubble.append(header, text, footer);
            msgWrapper.append(msgBubble, actions);
        }
        elements.messageList.appendChild(msgWrapper);
    }
    
    async function deleteMessage(msgId, msgData) {
        const isMe = msgData.senderId === currentUser.uid;
        const isAdminOrSuperAdmin = currentUserData.role === 'admin' || currentUserData.role === 'super admin';
        
        if (!isMe && !isAdminOrSuperAdmin) {
            alert('Anda tidak memiliki izin untuk menghapus pesan ini.');
            return;
        }

        const confirmationText = 'Apakah Anda yakin ingin menghapus pesan ini? Aksi ini tidak dapat dibatalkan.';
        if (!confirm(confirmationText)) {
            return;
        }

        let deletedText = '';
        if (isMe) {
            deletedText = `Pesan telah dihapus pengirim (${currentUserData.name})`;
        } else { 
            deletedText = `Pesan telah dihapus oleh ${currentUserData.role}.`;
        }

        const updates = {
            text: deletedText,
            deleted: true,
            deletedBy: currentUser.uid,
            replyingToId: null, 
        };

        try {
            await update(ref(db, `chats/${activeChatId}/${msgId}`), updates);
        } catch (error) {
            console.error("Error deleting message:", error);
            alert("Gagal menghapus pesan. Silakan coba lagi.");
        }
    }

    function setReplyingTo(msgId, msgData) {
        replyingTo = { id: msgId, senderName: msgData.senderName, text: msgData.text };
        elements.replyingToUser.textContent = msgData.senderName;
        elements.replyingToText.textContent = msgData.text;
        elements.replyingToBanner.style.display = 'flex';
        elements.messageInput.focus();
    }

    function cancelReply() {
        replyingTo = null;
        elements.replyingToBanner.style.display = 'none';
    }

    function openReportModal(msgId, msgData) {
        messageToReport = { id: msgId, ...msgData };
        elements.reportedMessageText.textContent = `"${msgData.text}" oleh ${msgData.senderName}`;
        elements.reportModal.style.display = 'block';
    }

    function closeReportModal() {
        elements.reportModal.style.display = 'none';
        messageToReport = null;
    }
    
    async function submitReport() {
        if (!messageToReport) return;
        const reportData = {
            messageId: messageToReport.id, chatId: activeChatId,
            reportedUserId: messageToReport.senderId, reporterUserId: currentUser.uid,
            messageText: messageToReport.text, reason: elements.reportReason.value,
            timestamp: serverTimestamp(), status: 'pending'
        };
        try {
            await push(ref(db, 'reports'), reportData);
            alert('Laporan Anda telah dikirim. Terima kasih.');
            closeReportModal();
        } catch(e) {
            alert('Gagal mengirim laporan. Coba lagi.');
            console.error(e);
        }
    }

    async function handleCreateGroup(e) {
        e.preventDefault();
        const groupName = elements.groupNameInput.value.trim();
        const groupDescription = elements.groupDescriptionInput.value.trim();
        if (!groupName) return;

        try {
            const newGroupRef = push(ref(db, 'groups'));
            await set(newGroupRef, {
                name: groupName,
                description: groupDescription,
                createdBy: currentUser.uid,
                createdAt: serverTimestamp(),
                members: { [currentUser.uid]: true }
            });
            elements.createGroupForm.reset();
            elements.createGroupModal.style.display = 'none';
        } catch (error) {
            console.error("Error creating group:", error);
            alert("Gagal membuat grup.");
        }
    }

    function openManageMembersModal() {
        if (!activeGroupData) return;
        elements.manageMembersTitle.textContent = `Kelola Anggota: ${activeGroupData.name}`;
        elements.currentMembersList.innerHTML = '';
        elements.addMembersList.innerHTML = '';

        const members = activeGroupData.members || {};
        
        Object.keys(allUsers).forEach(uid => {
            const user = allUsers[uid];
            const li = el('li', '', { class: 'modal-user-item' });
            li.textContent = user.name;

            if(members[uid]) {
                if (uid !== activeGroupData.createdBy) {
                    const removeBtn = el('button', 'Keluarkan', { class: 'btn-sm danger' });
                    removeBtn.onclick = () => removeMemberFromGroup(uid);
                    li.appendChild(removeBtn);
                } else {
                    const creatorBadge = el('span', 'Creator', { class: 'creator-badge' });
                    li.appendChild(creatorBadge);
                }
                elements.currentMembersList.appendChild(li);
            } else {
                const addBtn = el('button', 'Tambah', { class: 'btn-sm success' });
                addBtn.onclick = () => addMemberToGroup(uid);
                li.appendChild(addBtn);
                elements.addMembersList.appendChild(li);
            }
        });

        elements.manageMembersModal.style.display = 'block';
    }

    async function addMemberToGroup(userId) {
        if(!activeGroupData) return;
        const updates = {};
        updates[`/groups/${activeGroupData.id}/members/${userId}`] = true;
        await update(ref(db), updates);
        if (!activeGroupData.members) activeGroupData.members = {};
        activeGroupData.members[userId] = true;
        openManageMembersModal();
    }

    async function removeMemberFromGroup(userId) {
        if(!activeGroupData || userId === activeGroupData.createdBy) return;
        if(confirm(`Yakin ingin mengeluarkan ${allUsers[userId].name} dari grup?`)) {
            const updates = {};
            updates[`/groups/${activeGroupData.id}/members/${userId}`] = null;
            await update(ref(db), updates);
            delete activeGroupData.members[userId];
            openManageMembersModal();
        }
    }

    function openManageGroupModal() {
        if (!activeGroupData) return;
        elements.manageGroupTitle.textContent = `Kelola Grup: ${activeGroupData.name}`;
        elements.groupNameEditInput.value = activeGroupData.name || '';
        elements.groupDescriptionEditInput.value = activeGroupData.description || '';

        const isCreator = activeGroupData.createdBy === currentUser.uid;
        const isSuperAdmin = currentUserData.role === 'super admin';
        
        elements.deleteGroupBtn.style.display = (isCreator || isSuperAdmin) ? 'block' : 'none';
        
        elements.manageGroupModal.style.display = 'block';
    }

    async function handleUpdateGroup(e) {
        e.preventDefault();
        if (!activeGroupData) return;
        const newName = elements.groupNameEditInput.value.trim();
        const newDescription = elements.groupDescriptionEditInput.value.trim();
        if (!newName) {
            alert('Nama grup tidak boleh kosong.');
            return;
        }

        try {
            await update(ref(db, `groups/${activeGroupData.id}`), {
                name: newName,
                description: newDescription
            });
            alert('Informasi grup berhasil diperbarui.');
            elements.manageGroupModal.style.display = 'none';
        } catch (error) {
            console.error('Gagal memperbarui grup:', error);
            alert('Gagal memperbarui grup. Silakan coba lagi.');
        }
    }

    async function handleDeleteGroup() {
        if (!activeGroupData) return;
        const groupName = activeGroupData.name;
        
        if (!confirm(`PERINGATAN!\nAnda akan menghapus grup "${groupName}".\nSemua riwayat percakapan di dalam grup ini juga akan dihapus secara permanen.\n\nAksi ini tidak dapat dibatalkan. Lanjutkan?`)) {
            return;
        }

        if (!confirm(`KONFIRMASI AKHIR!\nAnda benar-benar yakin ingin menghapus grup "${groupName}"?`)) {
            return;
        }

        try {
            const updates = {};
            updates[`/groups/${activeGroupData.id}`] = null;
            updates[`/chats/${activeGroupData.id}`] = null;

            await update(ref(db), updates);
            alert(`Grup "${groupName}" telah berhasil dihapus.`);
            
            elements.manageGroupModal.style.display = 'none';
            document.querySelector('#group-list a[data-chat-id="general"]').click();

        } catch (error) {
            console.error('Gagal menghapus grup:', error);
            alert('Gagal menghapus grup. Silakan coba lagi.');
        }
    }

    function setupEventListeners() {
        elements.searchGroup.addEventListener('input', loadChatLists);
        elements.searchUser.addEventListener('input', loadChatLists);

        elements.messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const messageText = elements.messageInput.value.trim();
            if (!messageText || !activeChatId) return;

            const messageData = {
                senderId: currentUser.uid,
                senderName: currentUserData.name,
                senderRole: currentUserData.role,
                text: messageText,
                timestamp: serverTimestamp()
            };

            if (replyingTo) { messageData.replyingToId = replyingTo.id; }

            const newMessageRef = push(ref(db, `chats/${activeChatId}`));
            set(newMessageRef, messageData);
            
            elements.messageInput.value = '';
            cancelReply();
        });

        elements.logoutBtn.addEventListener('click', () => signOut(auth));
        elements.cancelReplyBtn.onclick = cancelReply;
        elements.closeReportModal.onclick = closeReportModal;
        elements.submitReportBtn.onclick = submitReport;

        elements.createGroupBtn.onclick = () => elements.createGroupModal.style.display = 'block';
        elements.closeCreateGroupModal.onclick = () => elements.createGroupModal.style.display = 'none';
        elements.createGroupForm.addEventListener('submit', handleCreateGroup);
        
        elements.manageMembersBtn.onclick = openManageMembersModal;
        elements.closeManageMembersModal.onclick = () => elements.manageMembersModal.style.display = 'none';

        elements.manageGroupBtn.onclick = openManageGroupModal;
        elements.closeManageGroupModal.onclick = () => elements.manageGroupModal.style.display = 'none';
        elements.manageGroupForm.addEventListener('submit', handleUpdateGroup);
        elements.deleteGroupBtn.onclick = handleDeleteGroup;

        window.onclick = (event) => {
            if (event.target == elements.reportModal) closeReportModal();
            if (event.target == elements.createGroupModal) elements.createGroupModal.style.display = 'none';
            if (event.target == elements.manageMembersModal) elements.manageMembersModal.style.display = 'none';
            if (event.target == elements.manageGroupModal) elements.manageGroupModal.style.display = 'none';
        };
    }
  </script>
</body>
</html>
