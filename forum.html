<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>Forum Diskusi</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="content-wrapper">
    <nav class="sidebar">
      <div class="sidebar-wrapper">
        <div class="sidebar-header">
          <h2>Forum Diskusi</h2>
        </div>
        <div class="sidebar-account">
          <p id="userName">Memuat...</p>
          <small id="userEmail">Memuat...</small>
        </div>
        <div id="chat-list-container" class="sidebar-menu">
          <div class="sidebar-chat-header">
            <h4 class="chat-list-header"><i class="fa-solid fa-people-group"></i> Grup Chat</h4>
            <button id="createGroupBtn" class="btn-sm" style="display: none;"><i class="fas fa-plus"></i></button>
          </div>
          <div class="form-group" style="margin: 0 0 1rem 0; padding: 0;">
            <input type="text" id="searchGroup" style="background: var(--gunmetal);" placeholder="Cari grup">
          </div>
          <ul id="group-list">
             </ul>
          <div class="sidebar-chat-header">
            <h4 class="chat-list-header"><i class="fa-solid fa-person"></i> Personal Chat</h4>
          </div>
          <div class="form-group" style="margin: 0 0 1rem 0; padding: 0;">
            <input type="text" id="searchUser" style="background: var(--gunmetal);" placeholder="Cari nama">
          </div>
          <ul id="user-list">
            </ul>
        </div>
        <div class="sidebar-footer">
          <button id="logoutBtn" class="logout-button"><i class="fa-solid fa-right-from-bracket"></i> Keluar</button>
          <p>V.3.0.4</p>
        </div>
      </div>
    </nav>

    <main class="main-content">
      <div class="main-wrapper">
        <header class="main-header">
          <button class="hamburger-menu" id="hamburger-menu" aria-label="Toggle sidebar" style="padding: 1rem; width: 4rem;">
                <i class="fas fa-bars"></i>
            </button>
          <div class="main-header-content">
            <h1 id="chatTitle"><i class="fas fa-comments"></i> Pilih Obrolan</h1>
                <p id="chatSubtitle">Pilih grup atau pengguna dari daftar di samping untuk memulai.</p>
          </div>
          <div class="main-header-menu">
            <ul>
              <li><button id="chatPermissionsBtn" class="btn-sm" style="display: none;"><i class="fas fa-shield-alt"></i> Izin Chat</button></li>
              <li><button id="manageMembersBtn" class="btn-sm info" style="display: none;"><i class="fas fa-users-cog"></i> Kelola Anggota</button></li>
              <li><button id="manageGroupBtn" class="btn-sm" style="display: none;"><i class="fas fa-edit"></i> Kelola Grup</button></li>
              <li><button id="guideBtn" class="btn-sm" style="display: none;"><i class="fas fa-info-circle"></i> Panduan Chat</button></li>
            </ul>
          </div>
        </header>
        <div class="content-container" id="chat-area">
          <div class="chat-messages" id="message-list">
             <p class="empty-state">Selamat datang di forum diskusi!</p>
          </div>
        </div>
        <div class="chat-input-area">
           <div id="replying-to-banner" class="reply-banner" style="display: none;">
              <div>
                  <p class="reply-banner-header">Membalas kepada <strong id="replying-to-user"></strong></p>
                  <p id="replying-to-text" class="reply-banner-text"></p>
              </div>
              <button id="cancel-reply-btn"><i class="fa-solid fa-xmark"></i></button>
           </div>
          <form id="messageForm" class="chat-form">
            <button type="button" id="mobileMenuBtn" class="mobile-menu-btn"><i class="fa-solid fa-gear"></i></button>
            <textarea id="messageInput" style="background-color: var(--light-gunmetal); height: 4.2rem; resize: none; overflow-y: auto;" placeholder="Ketik pesan" autocomplete="off" disabled></textarea>
            <button type="submit" id="sendMessageBtn" disabled><i class="fas fa-paper-plane"></i></button>
          </form>
        </div>
      </div>
    </main>
  </div>

  <div id="mobileMenuModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeMobileMenuModal"><i class="fa-solid fa-xmark"></i></span>
      <h2 style="margin: 0 0 2rem 0;">Menu Opsi</h2>
      <div class="modal-menu-list">
        <button id="modalChatPermissionsBtn" class="modal-menu-button" style="display: none;"><i class="fas fa-shield-alt"></i> Izin Chat</button>
        <button id="modalManageMembersBtn" class="modal-menu-button" style="display: none;"><i class="fas fa-users-cog"></i> Kelola Anggota</button>
        <button id="modalManageGroupBtn" class="modal-menu-button" style="display: none;"><i class="fas fa-edit"></i> Kelola Grup</button>
        <button id="modalGuideBtn" class="modal-menu-button" style="display: none;"><i class="fas fa-info-circle"></i> Panduan Chat</button>
      </div>
    </div>
  </div>


  <div id="guideModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeGuideModal"><i class="fa-solid fa-xmark"></i></span>
      <h2 style="margin: 0 0 2rem 0;">Panduan Format Chat</h2>
      <div class="card-body" style="font-size: 1.5rem; color: var(--slate-gray);">
        <ul style="list-style: none; padding: 0;">
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);"># Header1</code> Judul 1</li>
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);">## Header2</code> Judul 2</li>
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);">### Header3</code> Judul 3</li>
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);">*Teks tebal*</code> Teks tebal</li>
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);">_Teks miring_</code> Teks miring</li>
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);">~~Teks coret~~</code> Teks coret</li>
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);">`kode inline`</code> Teks inline</li>
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);">-- List nomor</code> Baris bernomor</li>
          <li style="margin-bottom: 0.5rem;"><code style="color: var(--cyan);">-* List poin</code> Baris berpoin</li>
        </ul>
      </div>
    </div>
  </div>

  <div id="reportModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeReportModal"><i class="fa-solid fa-xmark"></i></span>
      <h2 style="margin: 0 0 2rem 0;">Laporkan Pesan</h2>
      <p style="font-size: 1.5rem; color: var(--slate-gray); margin: 1rem 0;">Anda akan melaporkan pesan berikut:</p>
      <p id="reportedMessageText" class="modal-quote"></p>
      <div class="form-group">
        <label for="reportReason">Alasan Pelaporan</label>
        <select id="reportReason">
          <option value="ancaman">Ancaman atau Kekerasan</option>
          <option value="sara">Ujaran Kebencian (SARA)</option>
          <option value="cabul">Konten Tidak Pantas/Cabul</option>
          <option value="spam">Spam atau Penipuan</option>
          <option value="lainnya">Lainnya</option>
        </select>
      </div>
      <button id="submitReportBtn" style="width: 100%;">Kirim Laporan</button>
    </div>
  </div>

  <div id="createGroupModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeCreateGroupModal"><i class="fa-solid fa-xmark"></i></span>
      <h2 style="margin: 0 0 2rem 0;">Buat Grup Baru</h2>
      <form id="createGroupForm">
        <div class="form-group">
          <label for="groupNameInput">Nama Grup</label>
          <input type="text" id="groupNameInput" placeholder="Contoh: Koordinasi Proyek X" required>
        </div>
        <div class="form-group">
          <label for="groupDescriptionInput">Deskripsi Grup</label>
          <textarea id="groupDescriptionInput" placeholder="Jelaskan tujuan dari grup ini..." rows="3" style="resize: none;"></textarea>
        </div>
        <button type="submit" style="width: 100%;">Buat Grup</button>
      </form>
    </div>
  </div>

  <div id="manageMembersModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <span class="close-modal" id="closeManageMembersModal"><i class="fa-solid fa-xmark"></i></span>
      <h2 id="manageMembersTitle" style="margin: 0 0 2rem 0;">Kelola Anggota</h2>
      <div class="members-management-container">
        <div class="members-list-container">
          <h4>Anggota Saat Ini</h4>
          <ul id="currentMembersList" class="modal-user-list"></ul>
        </div>
        <div class="members-list-container">
          <h4>Tambah Anggota Baru</h4>
          <ul id="addMembersList" class="modal-user-list"></ul>
        </div>
      </div>
    </div>
  </div>

  <div id="manageGroupModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeManageGroupModal"><i class="fa-solid fa-xmark"></i></span>
      <h2 id="manageGroupTitle" style="margin: 0 0 2rem 0;">Kelola Grup</h2>
      <form id="manageGroupForm">
        <div class="form-group">
          <label for="groupNameEditInput">Nama Grup</label>
          <input type="text" id="groupNameEditInput" required>
        </div>
        <div class="form-group">
          <label for="groupDescriptionEditInput">Deskripsi Grup</label>
          <textarea id="groupDescriptionEditInput" rows="3" style="resize: none;"></textarea>
        </div>
        <button type="submit" style="width: 100%; margin-bottom: 1rem;">Simpan Perubahan</button>
      </form>
      <button id="deleteGroupBtn" class="logout-button" style="width: 100%; display: none;"><i class="fas fa-trash"></i> Hapus Grup Ini</button>
    </div>
  </div>

  <div id="chatPermissionsModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" id="closeChatPermissionsModal"><i class="fa-solid fa-xmark"></i></span>
        <h2 style="margin: 0 0 2rem 0;">Izin Mengirim Pesan</h2>
        <form id="permissionsForm">
            <div class="form-group">
                <div style="display: flex; flex-direction: column; gap: 1.5rem; font-size: 1.5rem; color: var(--light-lavender);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Semua Pengguna</span>
                        <label class="switch">
                            <input type="radio" name="permissionMode" value="all" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Hanya Admin & Super Admin</span>
                        <label class="switch">
                            <input type="radio" name="permissionMode" value="admins_only">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Pengguna Tertentu</span>
                        <label class="switch">
                            <input type="radio" name="permissionMode" value="selected_users">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            <div id="userPermissionsContainer" class="form-group" style="display: none; border-top: 1px solid var(--gunmetal); margin-top: 1rem; padding-top: 1rem;">
                <label>Pilih pengguna yang diizinkan</label>
                <ul id="userPermissionsList" class="modal-user-list" style="max-height: 200px; display: flex; flex-direction: column; gap: 1rem;"></ul>
            </div>
            <button type="submit" style="width: 100%; margin-top: 1rem;">Simpan Pengaturan</button>
        </form>
    </div>
  </div>

  <div id="editMessageModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" id="closeEditModal"><i class="fa-solid fa-xmark"></i></span>
      <h2 style="margin: 0 0 2rem 0;">Edit Pesan</h2>
      <form id="editMessageForm">
        <div class="form-group">
          <textarea id="editMessageInput" rows="5" required style="resize: none;"></textarea>
        </div>
        <button type="submit" style="width: 100%;">Simpan Perubahan</button>
      </form>
    </div>
  </div>


  <script type="module">
    import { supabase } from './supabase-client.js';
    import { el } from './utils.js';

    // --- Hamburger Menu Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        const hamburger = document.getElementById('hamburger-menu');
        const sidebar = document.querySelector('.sidebar');
        const mainContent = document.querySelector('.main-content');
        hamburger.addEventListener('click', (event) => {
            event.stopPropagation();
            sidebar.classList.toggle('active');
        });
        mainContent.addEventListener('click', () => {
            if (window.innerWidth <= 1024 && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });
    });

    let currentUser = null;
    let currentUserData = null;
    let allUsers = {};
    let allGroups = {};
    let activeChatId = null;
    let activeGroupData = null;
    let replyingTo = null;
    let messageToReport = null;
    let messageToEdit = null;
    let activeChatSubscription = null;
    
    const elements = {
        userName: document.getElementById('userName'),
        userEmail: document.getElementById('userEmail'),
        userList: document.getElementById('user-list'),
        groupList: document.getElementById('group-list'),
        searchGroup: document.getElementById('searchGroup'),
        searchUser: document.getElementById('searchUser'),
        chatTitle: document.getElementById('chatTitle'),
        chatSubtitle: document.getElementById('chatSubtitle'),
        messageList: document.getElementById('message-list'),
        messageForm: document.getElementById('messageForm'),
        messageInput: document.getElementById('messageInput'),
        sendMessageBtn: document.getElementById('sendMessageBtn'),
        logoutBtn: document.getElementById('logoutBtn'),
        replyingToBanner: document.getElementById('replying-to-banner'),
        replyingToUser: document.getElementById('replying-to-user'),
        replyingToText: document.getElementById('replying-to-text'),
        cancelReplyBtn: document.getElementById('cancel-reply-btn'),
        guideBtn: document.getElementById('guideBtn'),
        guideModal: document.getElementById('guideModal'),
        closeGuideModal: document.getElementById('closeGuideModal'),
        reportModal: document.getElementById('reportModal'),
        closeReportModal: document.getElementById('closeReportModal'),
        reportedMessageText: document.getElementById('reportedMessageText'),
        reportReason: document.getElementById('reportReason'),
        submitReportBtn: document.getElementById('submitReportBtn'),
        createGroupBtn: document.getElementById('createGroupBtn'),
        createGroupModal: document.getElementById('createGroupModal'),
        closeCreateGroupModal: document.getElementById('closeCreateGroupModal'),
        createGroupForm: document.getElementById('createGroupForm'),
        groupNameInput: document.getElementById('groupNameInput'),
        groupDescriptionInput: document.getElementById('groupDescriptionInput'),
        manageMembersBtn: document.getElementById('manageMembersBtn'),
        manageMembersModal: document.getElementById('manageMembersModal'),
        closeManageMembersModal: document.getElementById('closeManageMembersModal'),
        manageMembersTitle: document.getElementById('manageMembersTitle'),
        currentMembersList: document.getElementById('currentMembersList'),
        addMembersList: document.getElementById('addMembersList'),
        manageGroupBtn: document.getElementById('manageGroupBtn'),
        manageGroupModal: document.getElementById('manageGroupModal'),
        closeManageGroupModal: document.getElementById('closeManageGroupModal'),
        manageGroupTitle: document.getElementById('manageGroupTitle'),
        manageGroupForm: document.getElementById('manageGroupForm'),
        groupNameEditInput: document.getElementById('groupNameEditInput'),
        groupDescriptionEditInput: document.getElementById('groupDescriptionEditInput'),
        deleteGroupBtn: document.getElementById('deleteGroupBtn'),
        chatPermissionsBtn: document.getElementById('chatPermissionsBtn'),
        chatPermissionsModal: document.getElementById('chatPermissionsModal'),
        closeChatPermissionsModal: document.getElementById('closeChatPermissionsModal'),
        permissionsForm: document.getElementById('permissionsForm'),
        userPermissionsContainer: document.getElementById('userPermissionsContainer'),
        userPermissionsList: document.getElementById('userPermissionsList'),
        editMessageModal: document.getElementById('editMessageModal'),
        closeEditModal: document.getElementById('closeEditModal'),
        editMessageForm: document.getElementById('editMessageForm'),
        editMessageInput: document.getElementById('editMessageInput'),
        mobileMenuBtn: document.getElementById('mobileMenuBtn'),
        mobileMenuModal: document.getElementById('mobileMenuModal'),
        closeMobileMenuModal: document.getElementById('closeMobileMenuModal'),
        modalChatPermissionsBtn: document.getElementById('modalChatPermissionsBtn'),
        modalManageMembersBtn: document.getElementById('modalManageMembersBtn'),
        modalManageGroupBtn: document.getElementById('modalManageGroupBtn'),
        modalGuideBtn: document.getElementById('modalGuideBtn'),
    };

    // Theme and Font Logic
    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        const savedFont = localStorage.getItem('font') || "'Poppins', sans-serif";
        if (savedTheme === 'light') document.body.classList.add('light-mode');
        document.body.style.fontFamily = savedFont;
    });

    async function checkUserSession() {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
            window.location.href = 'index.html';
            return false;
        }
        currentUser = session.user;

        const { data, error } = await supabase.from('users').select('*').eq('id', currentUser.id).single();
        if (error || !data) {
            alert('Gagal memuat data pengguna.');
            await supabase.auth.signOut();
            window.location.href = 'index.html';
            return false;
        }

        currentUserData = data;
        if (currentUserData.locked) {
            alert('Akun Anda telah dinonaktifkan.');
            await supabase.auth.signOut();
            window.location.href = 'index.html';
            return false;
        }

        elements.userName.textContent = currentUserData.name || 'Pengguna';
        elements.userEmail.textContent = currentUser.email;

        if (['admin', 'super admin'].includes(currentUserData.role)) {
            elements.createGroupBtn.style.display = 'block';
        }

        await supabase.from('users').update({ online: true }).eq('id', currentUser.id);
        return true;
    }

    async function loadInitialData() {
        const { data: usersData, error: usersError } = await supabase.from('users').select('*');
        if (usersError) return console.error('Gagal memuat users:', usersError);
        allUsers = usersData.reduce((acc, user) => {
            acc[user.id] = user;
            return acc;
        }, {});

        const { data: groupsData, error: groupsError } = await supabase.from('groups').select('*');
        if (groupsError) return console.error('Gagal memuat groups:', groupsError);
        allGroups = groupsData.reduce((acc, group) => {
            acc[group.id] = group;
            return acc;
        }, {});
        
        renderChatLists();
        setupEventListeners();
        setupRealtimeSubscriptions();

        // Auto open general chat
        const generalChatLink = document.querySelector('#group-list a[data-chat-id="general"]');
        if (generalChatLink) {
            generalChatLink.click();
        }
    }
    
    function renderChatLists() {
        const groupSearchTerm = elements.searchGroup.value.toLowerCase();
        elements.groupList.innerHTML = '';
        const generalGroup = { id: 'general', name: 'Diskusi Umum', members: {} };
        if (generalGroup.name.toLowerCase().includes(groupSearchTerm)) {
            const li = el('li');
            const a = el('a', `<span><i class="fa-solid fa-user-group"></i> ${generalGroup.name}</span>`, { href: '#', 'data-chat-id': 'general' });
            a.onclick = (e) => { e.preventDefault(); openChat('general', generalGroup.name, 'group', generalGroup); };
            li.append(a);
            elements.groupList.append(li);
        }
        Object.values(allGroups).forEach(group => {
            if (group.name.toLowerCase().includes(groupSearchTerm)) {
                const isMember = group.members && group.members.includes(currentUser.id);
                const isAdmin = ['admin', 'super admin'].includes(currentUserData.role);
                const li = el('li');
                const icon = isMember || isAdmin ? '<i class="fa-solid fa-user-group"></i>' : '<i class="fas fa-lock"></i>';
                const a = el('a', `<span>${icon} ${group.name}</span>`, { href: '#', 'data-chat-id': group.id });
                a.onclick = (e) => { e.preventDefault(); openChat(group.id, group.name, 'group', group); };
                li.append(a);
                elements.groupList.append(li);
            }
        });

        const userSearchTerm = elements.searchUser.value.toLowerCase();
        elements.userList.innerHTML = '';
        Object.values(allUsers).forEach(userData => {
            if (userData.id === currentUser.id) return;
            if ((userData.name || '').toLowerCase().includes(userSearchTerm)) {
                const chatId = [currentUser.id, userData.id].sort().join('_');
                const li = el('li');
                const onlineIndicator = userData.online ? '<i class="fa-solid fa-user status-online"></i>' : '<i class="fa-solid fa-user status-offline"></i>';
                const a = el('a', `<span>${onlineIndicator} ${userData.name || 'Tanpa Nama'}</span>`, { href: '#', 'data-chat-id': chatId });
                a.onclick = (e) => { e.preventDefault(); openChat(chatId, userData.name, 'personal', { otherUserId: userData.id }); };
                li.append(a);
                elements.userList.append(li);
            }
        });

        updateActiveLinkInSidebar();
    }

    function linkify(text) {
        let html = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        html = html.replace(/^#+\s+(.*)/gm, (match, content) => `<h${Math.min(match.match(/^#+/)[0].length, 6)} style="margin: 0.5em 0;">${content.trim()}</h${Math.min(match.match(/^#+/)[0].length, 6)}>`);
        html = html.replace(/\*([^\*]+)\*/g, '<strong>$1</strong>').replace(/_([^_]+)_/g, '<i>$1</i>').replace(/~~([^~]+)~~/g, '<del>$1</del>').replace(/`([^`]+)`/g, '<code>$1</code>');
        const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        return html.replace(urlRegex, url => `<a href="${url.startsWith('www') ? 'https://' + url : url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
    }

    function updateActiveLinkInSidebar() {
        document.querySelectorAll('#group-list a, #user-list a').forEach(link => {
            link.classList.toggle('active', link.dataset.chatId === activeChatId);
        });
    }
    
    async function checkChatPermissions(permissions) {
        let canChat = false, reason = "Anda tidak diizinkan mengirim pesan di grup ini.";
        const mode = permissions?.mode || 'all';

        if (mode === 'all') canChat = true;
        else if (mode === 'admins_only' && ['admin', 'super admin'].includes(currentUserData.role)) canChat = true;
        else if (mode === 'selected_users' && permissions.allowed_users && permissions.allowed_users.includes(currentUser.id)) canChat = true;
        
        elements.messageInput.disabled = !canChat;
        elements.sendMessageBtn.disabled = !canChat;
        elements.messageInput.placeholder = canChat ? "Ketik pesan" : reason;
    }
    
    async function openChat(chatId, chatName, type, metaData = null) {
        if (activeChatSubscription) {
            await supabase.removeChannel(activeChatSubscription);
            activeChatSubscription = null;
        }

        activeChatId = chatId;
        updateActiveLinkInSidebar();
        
        elements.manageMembersBtn.style.display = 'none';
        elements.modalManageMembersBtn.style.display = 'none';
        elements.manageGroupBtn.style.display = 'none';
        elements.modalManageGroupBtn.style.display = 'none';
        elements.chatPermissionsBtn.style.display = 'none';
        elements.modalChatPermissionsBtn.style.display = 'none';
        elements.guideBtn.style.display = 'block';
        elements.modalGuideBtn.style.display = 'block';

        activeGroupData = (type === 'group') ? metaData : null;

        if (type === 'personal') {
            const otherUser = allUsers[metaData.otherUserId];
            const roleClass = (otherUser.role || '').replace(' ', '-');
            elements.chatTitle.innerHTML = `<i class="fas fa-user"></i> ${chatName} <span class="role-badge role-${roleClass}" style="font-size: 1.2rem;">${otherUser.role}</span>`;
            elements.chatSubtitle.textContent = `Percakapan dengan ${chatName}`;
        } else {
            elements.chatTitle.innerHTML = `<i class="fa-solid fa-user-group"></i> ${chatName}`;
            elements.chatSubtitle.textContent = metaData?.description || `Grup: ${chatName}`;
        }

        elements.messageList.innerHTML = '<p class="empty-state">Memuat pesan...</p>';
        
        const isSuperAdminOrAdmin = ['admin', 'super admin'].includes(currentUserData.role);
        const isCreator = metaData && metaData.created_by === currentUser.id;
        
        if (type === 'group' && chatId !== 'general') {
            elements.manageMembersBtn.style.display = isSuperAdminOrAdmin ? 'block' : 'none';
            elements.modalManageMembersBtn.style.display = isSuperAdminOrAdmin ? 'block' : 'none';
            elements.manageGroupBtn.style.display = (isSuperAdminOrAdmin || isCreator) ? 'block' : 'none';
            elements.modalManageGroupBtn.style.display = (isSuperAdminOrAdmin || isCreator) ? 'block' : 'none';
        }
        if (chatId === 'general' && isSuperAdminOrAdmin) {
            elements.chatPermissionsBtn.style.display = 'block';
            elements.modalChatPermissionsBtn.style.display = 'block';
        }
        
        if (chatId === 'general') {
            const { data } = await supabase.from('chat_settings').select('permissions').eq('group_id', 'general').single();
            checkChatPermissions(data?.permissions);
        } else {
            checkChatPermissions({ mode: 'all' });
        }
        
        // Initial message load
        loadAndRenderMessages(chatId);

        // Subscribe to future messages
        activeChatSubscription = supabase.channel(`public:messages:chat_id=eq.${chatId}`)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}` }, payload => {
                console.log('Perubahan pesan:', payload);
                loadAndRenderMessages(chatId); // Reload all messages on any change
            })
            .subscribe();

        const sidebar = document.querySelector('.sidebar');
        if (sidebar.classList.contains('active')) sidebar.classList.remove('active');
    }

    async function loadAndRenderMessages(chatId) {
        const { data: messages, error } = await supabase
            .from('messages')
            .select('*, sender:sender_id(*)')
            .eq('chat_id', chatId)
            .order('created_at', { ascending: true });

        if(error) return console.error("Gagal memuat pesan:", error);
        
        const shouldScroll = elements.messageList.scrollTop + elements.messageList.clientHeight >= elements.messageList.scrollHeight - 30;
        elements.messageList.innerHTML = '';

        if (messages.length > 0) {
            for (const msg of messages) {
                const msgElement = await createMessageElement(msg);
                if (msgElement) elements.messageList.appendChild(msgElement);
            }
        } else {
            elements.messageList.innerHTML = `<p class="empty-state">Belum ada pesan. Mulai percakapan!</p>`;
        }
        if (shouldScroll) elements.messageList.scrollTop = elements.messageList.scrollHeight;
    }

    async function createMessageElement(msgData) {
        if (!msgData) return null;

        const isMe = msgData.sender_id === currentUser.id;
        const msgWrapper = el('div', '', { class: `message-wrapper ${isMe ? 'sent' : 'received'}`, id: `msg-${msgData.id}` });
        const msgBubble = el('div', '', { class: 'message-bubble' });
        
        const senderInfo = msgData.sender || { name: 'Pengguna Dihapus', role: '' };
        const senderName = isMe ? 'Anda' : senderInfo.name;
        const roleClass = (senderInfo.role || '').replace(' ', '-');
        
        const header = el('p', '', { class: 'message-header' });
        header.innerHTML = `${senderName} <span class="role-badge role-${roleClass}" style="font-size: 1rem;">${senderInfo.role}</span>`;
        msgBubble.append(header);

        if (msgData.replying_to_id) {
            const { data: repliedMsg } = await supabase.from('messages').select('text, sender:sender_id(name)').eq('id', msgData.replying_to_id).single();
            if (repliedMsg) {
                const repliedMessageDiv = el('div', '', {class: 'replied-message'});
                repliedMessageDiv.innerHTML = `<p class="replied-header">${repliedMsg.sender.name}</p><p class="replied-text">${repliedMsg.text}</p>`;
                msgBubble.append(repliedMessageDiv);
            }
        }
        
        const text = el('div', '', { class: 'message-text', innerHTML: linkify(msgData.text) });
        const time = new Date(msgData.created_at).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        const editedIndicator = msgData.is_edited ? '<span style="font-size: 1rem; opacity: 0.7;">(diedit)</span>' : '';
        const footer = el('p', '', { class: 'message-footer', innerHTML: `${time} ${editedIndicator}` });
        
        const actions = el('div', '', { class: 'message-actions' });
        const replyBtn = el('button', '<i class="fas fa-reply"></i>', { class: 'btn-sm' });
        replyBtn.onclick = () => setReplyingTo(msgData.id, msgData);
        
        const reportBtn = el('button', '<i class="fas fa-flag"></i>', { class: 'btn-sm warm' });
        reportBtn.onclick = () => openReportModal(msgData.id, msgData);
        actions.append(replyBtn, reportBtn);

        const isAdminOrSuperAdmin = ['admin', 'super admin'].includes(currentUserData.role);
        if (isMe) {
            const editBtn = el('button', '<i class="fas fa-edit"></i>', { class: 'btn-sm info' });
            editBtn.onclick = () => openEditModal(msgData.id, msgData);
            actions.append(editBtn);
        }
        if (isMe || isAdminOrSuperAdmin) {
            const deleteBtn = el('button', '<i class="fas fa-trash"></i>', { class: 'btn-sm danger' });
            deleteBtn.onclick = () => deleteMessage(msgData.id);
            actions.append(deleteBtn);
        }

        msgBubble.append(text, footer, actions);
        msgWrapper.append(msgBubble);
        return msgWrapper;
    }
    
    async function deleteMessage(msgId) {
        if (!confirm('Yakin ingin menghapus pesan ini secara permanen?')) return;
        const { error } = await supabase.from('messages').delete().eq('id', msgId);
        if (error) alert("Gagal menghapus pesan: " + error.message);
    }

    function setReplyingTo(msgId, msgData) {
        const replyToName = msgData.sender_id === currentUser.id ? 'Anda' : msgData.sender.name;
        replyingTo = { id: msgId, senderName: replyToName, text: msgData.text };
        elements.replyingToUser.textContent = replyToName;
        elements.replyingToText.textContent = msgData.text;
        elements.replyingToBanner.style.display = 'flex';
        elements.messageInput.focus();
    }

    function cancelReply() {
        replyingTo = null;
        elements.replyingToBanner.style.display = 'none';
    }

    function openReportModal(msgId, msgData) {
        messageToReport = { id: msgId, ...msgData };
        elements.reportedMessageText.textContent = `"${msgData.text}" oleh ${msgData.sender.name}`;
        elements.reportModal.style.display = 'block';
    }

    function closeReportModal() {
        elements.reportModal.style.display = 'none';
        messageToReport = null;
    }

    function openEditModal(msgId, msgData) {
        messageToEdit = { id: msgId, ...msgData };
        elements.editMessageInput.value = msgData.text;
        elements.editMessageModal.style.display = 'block';
        elements.editMessageInput.focus();
    }

    function closeEditModal() {
        elements.editMessageModal.style.display = 'none';
        messageToEdit = null;
    }

    async function handleUpdateMessage(e) {
        e.preventDefault();
        if (!messageToEdit) return;
        const newText = elements.editMessageInput.value.trim();
        if (!newText || newText === messageToEdit.text) return closeEditModal();

        const { error } = await supabase
            .from('messages')
            .update({ text: newText, is_edited: true })
            .eq('id', messageToEdit.id);

        if (error) alert("Gagal menyimpan perubahan: " + error.message);
        else closeEditModal();
    }
    
    async function submitReport() {
        if (!messageToReport) return;
        const { error } = await supabase.from('reports').insert([{
            message_id: messageToReport.id,
            chat_id: activeChatId,
            reported_user_id: messageToReport.sender_id,
            reporter_user_id: currentUser.id,
            message_text: messageToReport.text,
            reason: elements.reportReason.value,
            status: 'pending'
        }]);
        if(error) alert('Gagal mengirim laporan: ' + error.message);
        else {
            alert('Laporan Anda telah dikirim.');
            closeReportModal();
        }
    }

    async function handleCreateGroup(e) {
        e.preventDefault();
        const groupName = elements.groupNameInput.value.trim();
        const groupDescription = elements.groupDescriptionInput.value.trim();
        if (!groupName) return;

        const { error } = await supabase.from('groups').insert([{
            name: groupName,
            description: groupDescription,
            created_by: currentUser.id,
            members: [currentUser.id] // Creator is the first member
        }]);

        if (error) alert("Gagal membuat grup: " + error.message);
        else {
            elements.createGroupForm.reset();
            elements.createGroupModal.style.display = 'none';
        }
    }

    function openManageMembersModal() {
        if (!activeGroupData) return;
        elements.manageMembersTitle.textContent = `Kelola Anggota: ${activeGroupData.name}`;
        elements.currentMembersList.innerHTML = '';
        elements.addMembersList.innerHTML = '';

        const members = activeGroupData.members || [];
        Object.values(allUsers).forEach(user => {
            const li = el('li', '', { class: 'modal-user-item' });
            li.textContent = user.name;

            if(members.includes(user.id)) {
                if (user.id !== activeGroupData.created_by) {
                    const removeBtn = el('button', 'Keluarkan', { class: 'btn-sm danger' });
                    removeBtn.onclick = () => updateGroupMembers(user.id, 'remove');
                    li.appendChild(removeBtn);
                } else {
                    li.appendChild(el('span', 'Creator', { class: 'creator-badge' }));
                }
                elements.currentMembersList.appendChild(li);
            } else {
                const addBtn = el('button', 'Tambah', { class: 'btn-sm success' });
                addBtn.onclick = () => updateGroupMembers(user.id, 'add');
                li.appendChild(addBtn);
                elements.addMembersList.appendChild(li);
            }
        });

        elements.manageMembersModal.style.display = 'block';
    }

    async function updateGroupMembers(userId, action) {
        if (!activeGroupData) return;
        let updatedMembers = [...(activeGroupData.members || [])];
        
        if (action === 'add' && !updatedMembers.includes(userId)) {
            updatedMembers.push(userId);
        } else if (action === 'remove') {
            if (!confirm(`Yakin ingin mengeluarkan ${allUsers[userId].name} dari grup?`)) return;
            updatedMembers = updatedMembers.filter(id => id !== userId);
        }

        const { error } = await supabase.from('groups').update({ members: updatedMembers }).eq('id', activeGroupData.id);
        if (error) alert('Gagal memperbarui anggota: ' + error.message);
    }


    function openManageGroupModal() {
        if (!activeGroupData) return;
        elements.manageGroupTitle.textContent = `Kelola Grup: ${activeGroupData.name}`;
        elements.groupNameEditInput.value = activeGroupData.name || '';
        elements.groupDescriptionEditInput.value = activeGroupData.description || '';
        elements.deleteGroupBtn.style.display = (activeGroupData.created_by === currentUser.id || currentUserData.role === 'super admin') ? 'block' : 'none';
        elements.manageGroupModal.style.display = 'block';
    }

    async function handleUpdateGroup(e) {
        e.preventDefault();
        if (!activeGroupData) return;
        const newName = elements.groupNameEditInput.value.trim();
        const newDescription = elements.groupDescriptionEditInput.value.trim();
        if (!newName) return alert('Nama grup tidak boleh kosong.');

        const { error } = await supabase.from('groups').update({ name: newName, description: newDescription }).eq('id', activeGroupData.id);
        if (error) alert('Gagal memperbarui grup: ' + error.message);
        else {
            alert('Informasi grup berhasil diperbarui.');
            elements.manageGroupModal.style.display = 'none';
        }
    }

    async function handleDeleteGroup() {
        if (!activeGroupData || !confirm(`PERINGATAN!\nAnda akan menghapus grup "${activeGroupData.name}" beserta semua pesannya.\nAksi ini tidak dapat dibatalkan. Lanjutkan?`)) return;

        // Panggil serverless function untuk menghapus grup dan pesannya
        const { error } = await supabase.functions.invoke('delete-group', { body: { groupId: activeGroupData.id } });
        if (error) alert('Gagal menghapus grup: ' + error.message);
        else {
            alert(`Grup "${activeGroupData.name}" telah berhasil dihapus.`);
            elements.manageGroupModal.style.display = 'none';
            document.querySelector('#group-list a[data-chat-id="general"]').click();
        }
    }
    
    async function sendMessage() {
        const text = elements.messageInput.value.trim();
        if (!text || !activeChatId) return;

        const messageData = {
            chat_id: activeChatId,
            sender_id: currentUser.id,
            text: text,
            replying_to_id: replyingTo ? replyingTo.id : null
        };

        const { error } = await supabase.from('messages').insert([messageData]);
        if(error) {
            alert("Gagal mengirim pesan: " + error.message);
            return;
        }
        
        elements.messageInput.value = '';
        cancelReply();
    }

    async function openChatPermissionsModal() {
        const { data } = await supabase.from('chat_settings').select('permissions').eq('group_id', 'general').single();
        const permissions = data?.permissions || { mode: 'all' };
        
        elements.permissionsForm.querySelector(`[name="permissionMode"][value="${permissions.mode}"]`).checked = true;
        elements.userPermissionsList.innerHTML = '';
        
        Object.values(allUsers).forEach(user => {
            if (['super admin', 'admin'].includes(user.role)) return;
            const li = el('li', '', { class: 'modal-user-item' });
            const nameSpan = el('span', user.name);
            const switchLabel = el('label', '', { class: 'switch' });
            const checkbox = el('input', '', { type: 'checkbox', value: user.id });
            if (permissions.mode === 'selected_users' && permissions.allowed_users?.includes(user.id)) {
                checkbox.checked = true;
            }
            switchLabel.append(checkbox, el('span', '', {class: 'slider'}));
            li.append(nameSpan, switchLabel);
            elements.userPermissionsList.appendChild(li);
        });

        elements.userPermissionsContainer.style.display = (permissions.mode === 'selected_users') ? 'block' : 'none';
        elements.chatPermissionsModal.style.display = 'block';
    }

    async function handleSavePermissions(e) {
        e.preventDefault();
        const mode = elements.permissionsForm.querySelector('[name="permissionMode"]:checked').value;
        const newPermissions = { mode, allowed_users: null };

        if (mode === 'selected_users') {
            newPermissions.allowed_users = Array.from(elements.userPermissionsList.querySelectorAll('input:checked')).map(input => input.value);
        }
        
        const { error } = await supabase.from('chat_settings').upsert({ group_id: 'general', permissions: newPermissions }, { onConflict: 'group_id' });
        if (error) alert('Gagal menyimpan pengaturan: ' + error.message);
        else {
            alert('Pengaturan izin berhasil disimpan.');
            elements.chatPermissionsModal.style.display = 'none';
        }
    }

    function setupEventListeners() {
        elements.searchGroup.addEventListener('input', renderChatLists);
        elements.searchUser.addEventListener('input', renderChatLists);
        elements.messageForm.addEventListener('submit', (e) => { e.preventDefault(); sendMessage(); });
        elements.messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        elements.logoutBtn.addEventListener('click', async () => {
            await supabase.from('users').update({ online: false }).eq('id', currentUser.id);
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        });

        elements.cancelReplyBtn.onclick = cancelReply;
        elements.mobileMenuBtn.onclick = () => elements.mobileMenuModal.style.display = 'block';
        elements.closeMobileMenuModal.onclick = () => elements.mobileMenuModal.style.display = 'none';
        
        [elements.guideBtn, elements.modalGuideBtn].forEach(btn => btn.onclick = () => { elements.guideModal.style.display = 'block'; elements.mobileMenuModal.style.display = 'none'; });
        [elements.manageMembersBtn, elements.modalManageMembersBtn].forEach(btn => btn.onclick = () => { openManageMembersModal(); elements.mobileMenuModal.style.display = 'none'; });
        [elements.manageGroupBtn, elements.modalManageGroupBtn].forEach(btn => btn.onclick = () => { openManageGroupModal(); elements.mobileMenuModal.style.display = 'none'; });
        [elements.chatPermissionsBtn, elements.modalChatPermissionsBtn].forEach(btn => btn.onclick = () => { openChatPermissionsModal(); elements.mobileMenuModal.style.display = 'none'; });

        elements.closeGuideModal.onclick = () => elements.guideModal.style.display = 'none';
        elements.closeReportModal.onclick = closeReportModal;
        elements.submitReportBtn.onclick = submitReport;
        elements.createGroupBtn.onclick = () => elements.createGroupModal.style.display = 'block';
        elements.closeCreateGroupModal.onclick = () => elements.createGroupModal.style.display = 'none';
        elements.createGroupForm.addEventListener('submit', handleCreateGroup);
        elements.closeManageMembersModal.onclick = () => elements.manageMembersModal.style.display = 'none';
        elements.closeManageGroupModal.onclick = () => elements.manageGroupModal.style.display = 'none';
        elements.manageGroupForm.addEventListener('submit', handleUpdateGroup);
        elements.deleteGroupBtn.onclick = handleDeleteGroup;
        elements.closeChatPermissionsModal.onclick = () => elements.chatPermissionsModal.style.display = 'none';
        elements.permissionsForm.addEventListener('submit', handleSavePermissions);
        elements.closeEditModal.onclick = closeEditModal;
        elements.editMessageForm.addEventListener('submit', handleUpdateMessage);

        document.querySelectorAll('[name="permissionMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                elements.userPermissionsContainer.style.display = (e.target.value === 'selected_users') ? 'block' : 'none';
            });
        });

        window.onclick = (event) => {
            if (event.target == elements.guideModal) elements.guideModal.style.display = 'none';
            if (event.target == elements.reportModal) closeReportModal();
            if (event.target == elements.createGroupModal) elements.createGroupModal.style.display = 'none';
            if (event.target == elements.manageMembersModal) elements.manageMembersModal.style.display = 'none';
            if (event.target == elements.manageGroupModal) elements.manageGroupModal.style.display = 'none';
            if (event.target == elements.chatPermissionsModal) elements.chatPermissionsModal.style.display = 'none';
            if (event.target == elements.editMessageModal) closeEditModal();
            if (event.target == elements.mobileMenuModal) elements.mobileMenuModal.style.display = 'none';
        };
    }

    function setupRealtimeSubscriptions() {
        supabase.channel('public:users')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, payload => {
                const user = payload.new || payload.old;
                if (user && allUsers[user.id]) {
                    allUsers[user.id] = {...allUsers[user.id], ...user};
                    renderChatLists();
                }
            })
            .subscribe();

        supabase.channel('public:groups')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'groups' }, payload => {
                const group = payload.new;
                if(payload.eventType === 'DELETE') {
                    delete allGroups[payload.old.id];
                } else if (group) {
                    allGroups[group.id] = group;
                }
                renderChatLists();
                // If the currently open group is updated, refresh its view
                if(activeGroupData && group && activeGroupData.id === group.id) {
                    openChat(group.id, group.name, 'group', group);
                }
            })
            .subscribe();
    }
    
    // Inisialisasi halaman
    (async () => {
        const loggedIn = await checkUserSession();
        if (loggedIn) {
            await loadInitialData();
        }
    })();
  </script>
</body>
</html>
