<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Koordinator Panel</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="content-wrapper">
    <nav class="sidebar">
      <div class="sidebar-header">
        <h3>Koordinator</h3>
      </div>
      <ul class="sidebar-menu">
        <li><a href="#list" class="nav-link active">Daftar Perjalanan</a></li>
        <li><a href="#add" class="nav-link">Tambah Perjalanan</a></li>
        <li><a href="#performance" class="nav-link">Kinerja Supir</a></li>
      </ul>
      <div class="sidebar-footer">
        <button id="logoutBtn" class="logout-button">Keluar</button>
        <p style="text-align:center;margin:1.5rem 0 0 0;">DEMO Version</p>
      </div>
    </nav>

    <main class="main-content">
      <header class="main-header">
        <h1 id="pageTitle">Status Perjalanan Saya</h1>
        <p id="pageSubtitle">Pantau semua perjalanan yang telah Anda buat di sini.</p>
      </header>
      
      <div id="page-list" class="page active">
        <section class="card">
          <h2 class="card-header">Daftar Perjalanan Dibuat</h2>
          <div class="card-body">
            <div class="table-responsive">
              <table>
                <thead>
                  <tr>
                    <th>Rute</th>
                    <th>Supir</th>
                    <th>No. Polisi</th>
                    <th>Muatan</th>
                    <th>Tanggal</th>
                    <th>Status</th>
                    <th>Aksi Cetak</th>
                  </tr>
                </thead>
                <tbody id="tripList">
                  <tr><td colspan="7">Memuat data...</td></tr>
                </tbody>
              </table>
            </div>
            <div id="coor-pagination-controls" style="display:none; margin-top:1.5rem; text-align:center;">
              <button id="prevCoorBtn" class="btn-sm info">Sebelumnya</button>
              <span id="coorPageInfo" style="margin: 0 1rem; font-weight: 500;"></span>
              <button id="nextCoorBtn" class="btn-sm info">Berikutnya</button>
            </div>
          </div>
        </section>
      </div>

      <div id="page-add" class="page">
        <section class="card">
            <h2 class="card-header">Buat Data Perjalanan Baru</h2>
            <div class="card-body">
                <form id="tripForm">
                  <div class="form-group">
                    <label for="driverSelect">Pilih Supir</label>
                    <select id="driverSelect" required>
                      <option value="">Memuat daftar supir...</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="nopol">No. Polisi</label>
                    <select id="nopol" required>
                      <option value="">Memuat nopol...</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="asal">Asal</label>
                    <select id="asal" required>
                      <option value="">Memuat rute...</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="tujuan">Tujuan</label>
                    <select id="tujuan" required>
                      <option value="">Memuat rute...</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="muatan">Muatan</label>
                    <input id="muatan" type="text" required>
                  </div>
                  <div class="form-group">
                    <label for="tanggal">Tanggal Keberangkatan</label>
                    <input id="tanggal" type="date" required>
                  </div>
                  <button type="submit">Kirim Data Perjalanan</button>
                  <p id="statusMsg" class="form-status"></p>
                </form>
            </div>
        </section>
      </div>

      <div id="page-performance" class="page">
        <section class="card">
          <h2 class="card-header">Ringkasan Kinerja Supir</h2>
          <div class="card-body" id="driverPerformanceStats">
            <p>Memuat data kinerja...</p>
          </div>
        </section>
      </div>
      
    </main>
  </div>

  <script type="module">
    import { 
      auth, onAuthStateChanged, signOut, db, ref, get, push, set, onValue, 
      query, orderByChild, equalTo, update, onDisconnect
    } from './firebase.js';
    import { badge, fmtDate, el } from './utils.js';

    const pageContent = {
        list: { title: 'Status Perjalanan Saya', subtitle: 'Pantau semua perjalanan yang telah Anda buat di sini.' },
        add: { title: 'Tambah Perjalanan', subtitle: 'Buat data perjalanan baru untuk supir.' },
        performance: { title: 'Kinerja Supir', subtitle: 'Lihat ringkasan performa dari semua supir.' }
    };

    const elements = {
      pageTitle: document.getElementById('pageTitle'),
      pageSubtitle: document.getElementById('pageSubtitle'),
      navLinks: document.querySelectorAll('.nav-link'),
      pages: document.querySelectorAll('.page'),
      tripForm: document.getElementById('tripForm'),
      tripList: document.getElementById('tripList'),
      driverSelect: document.getElementById('driverSelect'),
      nopolSelect: document.getElementById('nopol'),
      asalSelect: document.getElementById('asal'),
      tujuanSelect: document.getElementById('tujuan'),
      logoutBtn: document.getElementById('logoutBtn'),
      statusMsg: document.getElementById('statusMsg'),
      coorPaginationControls: document.getElementById('coor-pagination-controls'),
      prevCoorBtn: document.getElementById('prevCoorBtn'),
      nextCoorBtn: document.getElementById('nextCoorBtn'),
      coorPageInfo: document.getElementById('coorPageInfo'),
      driverPerformanceStats: document.getElementById('driverPerformanceStats'),
    };
    
    let currentUser = null;
    let allMyTrips = [];
    let currentCoorPage = 1;
    const rowsPerPage = 10;

    function setupCoordinatorNavigation() {
        elements.navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);

                elements.pages.forEach(page => page.classList.remove('active'));
                elements.navLinks.forEach(nav => nav.classList.remove('active'));

                document.getElementById(`page-${targetId}`).classList.add('active');
                link.classList.add('active');
                
                elements.pageTitle.textContent = pageContent[targetId].title;
                elements.pageSubtitle.textContent = pageContent[targetId].subtitle;
            });
        });
    }
    setupCoordinatorNavigation();

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = 'index.html';
      currentUser = user;
      const userRef = ref(db, 'users/' + currentUser.uid);

      const snap = await get(userRef);
      if (!snap.exists() || snap.val().role !== 'coordinator') {
        alert('Akses ditolak. Hanya untuk koordinator.');
        return window.location.href = 'index.html';
      }
      
      await update(userRef, { lastLogin: Date.now(), online: true });
      onDisconnect(ref(db, `users/${user.uid}/online`)).set(false);

      loadMyTrips();
      loadDrivers(); 
      loadRoutes();
      loadVehicles();
    });

    async function loadVehicles() {
      try {
        const snapshot = await get(ref(db, 'vehicles'));
        elements.nopolSelect.innerHTML = '<option value="">-- Pilih Nopol --</option>';
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const vehicle = child.val();
            const option = el('option', `${vehicle.nopol} (${vehicle.type})`, { value: vehicle.nopol });
            elements.nopolSelect.appendChild(option);
          });
        }
      } catch (error) { console.error("Gagal memuat nopol:", error); }
    }

    async function loadRoutes() {
      try {
        const snapshot = await get(ref(db, 'routes'));
        elements.asalSelect.innerHTML = '<option value="">-- Pilih Asal --</option>';
        elements.tujuanSelect.innerHTML = '<option value="">-- Pilih Tujuan --</option>';
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const route = child.val();
            const option = el('option', `${route.code} - ${route.address}`, { value: route.address });
            elements.asalSelect.appendChild(option.cloneNode(true));
            elements.tujuanSelect.appendChild(option);
          });
        }
      } catch (error) { console.error("Gagal memuat rute:", error); }
    }

    async function loadDrivers() {
        try {
            const q = query(ref(db, 'users'), orderByChild('role'), equalTo('driver'));
            const snapshot = await get(q);
            elements.driverSelect.innerHTML = '<option value="">-- Pilih Supir --</option>';
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const driver = child.val();
                    const option = el('option', driver.name, { value: child.key });
                    elements.driverSelect.appendChild(option);
                });
            }
        } catch (error) { console.error("Gagal memuat daftar supir:", error); }
    }

    elements.tripForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      elements.statusMsg.textContent = 'Mengirim...';
      if (!currentUser) return alert('Anda belum login.');

      const selectedDriverOption = elements.driverSelect.options[elements.driverSelect.selectedIndex];
      const driverId = selectedDriverOption.value;
      const driverName = selectedDriverOption.text;
      if (!driverId) return alert('Silakan pilih supir terlebih dahulu.');

      const data = {
        coorId: currentUser.uid, driverId, driverName,
        nopol: document.getElementById('nopol').value,
        asal: document.getElementById('asal').value,
        tujuan: document.getElementById('tujuan').value,
        muatan: document.getElementById('muatan').value,
        tanggal: document.getElementById('tanggal').value,
        status: 'submitted', createdAt: Date.now()
      };

      try {
        const newTripRef = push(ref(db, 'trips'));
        await set(newTripRef, data);
        
        elements.tripForm.reset();
        elements.statusMsg.textContent = '✔️ Data berhasil dikirim.';
        setTimeout(() => {
            elements.statusMsg.textContent = '';
            document.querySelector('.nav-link[href="#list"]').click();
        }, 2000);
      } catch(err) {
        elements.statusMsg.style.color = 'var(--danger)';
        elements.statusMsg.textContent = 'Gagal mengirim data: ' + err.message;
      }
    });
    
    function loadDriverPerformance() {
        const performance = {};
        allMyTrips.forEach(({data: trip}) => {
            if (!trip.driverId) return;
            if (!performance[trip.driverId]) {
                performance[trip.driverId] = {
                    name: trip.driverName, total: 0, arrived: 0, approved: 0,
                    submitted: 0, rejected: 0
                };
            }
            performance[trip.driverId].total++;
            if (trip.status) performance[trip.driverId][trip.status]++;
        });

        let tableHTML = `<div class="table-responsive"><table><thead><tr>
                            <th>Nama Supir</th><th>Total</th><th>Selesai</th>
                            <th>Jalan</th><th>Menunggu</th><th>Ditolak</th>
                        </tr></thead><tbody>`;

        if (Object.keys(performance).length === 0) {
            tableHTML += '<tr><td colspan="6" class="empty-state">Belum ada data kinerja.</td></tr>';
        } else {
            Object.values(performance).forEach(d => {
                tableHTML += `<tr><td><strong>${d.name}</strong></td><td>${d.total}</td>
                    <td style="color:var(--success);">${d.arrived || 0}</td><td style="color:var(--info);">${d.approved || 0}</td>
                    <td style="color:var(--warning);">${d.submitted || 0}</td><td style="color:var(--danger);">${d.rejected || 0}</td></tr>`;
            });
        }
        elements.driverPerformanceStats.innerHTML = tableHTML + '</tbody></table></div>';
    }

    function displayMyTrips(page) {
      elements.tripList.innerHTML = '';
      currentCoorPage = page;
      
      const start = (page - 1) * rowsPerPage;
      const paginatedTrips = allMyTrips.slice(start, start + rowsPerPage);

      if (paginatedTrips.length === 0 && allMyTrips.length > 0) {
        return displayMyTrips(Math.ceil(allMyTrips.length / rowsPerPage));
      }

      elements.coorPaginationControls.style.display = allMyTrips.length > rowsPerPage ? 'block' : 'none';

      if (allMyTrips.length === 0) {
        elements.tripList.innerHTML = '<tr><td colspan="7" class="empty-state">Belum ada data perjalanan yang Anda buat.</td></tr>';
      } else {
        paginatedTrips.forEach(({id: tripId, data: tripData}) => {
          const tr = el('tr');
          const actionsCell = el('td', '', {'data-label': 'Aksi Cetak'});
          const actionsContainer = el('div', '', { class: 'trip-actions', style: 'justify-content:flex-start' });

          if (tripData.status === 'approved') {
            const sjButton = el('button', 'Surat Jalan', { class: 'btn-sm info' });
            const invButton = el('button', 'Invoice', { class: 'btn-sm info' });
            sjButton.onclick = () => window.open(`surat-jalan.html?id=${tripId}`);
            invButton.onclick = () => window.open(`invoice.html?id=${tripId}`);
            actionsContainer.append(sjButton, invButton);
          } else {
            actionsContainer.textContent = '-';
          }
          actionsCell.appendChild(actionsContainer);
          const statusCell = el('td', '', {'data-label': 'Status'});
          statusCell.appendChild(badge(tripData.status));
          
          tr.innerHTML = `<td data-label="Rute"><strong>${tripData.asal} → ${tripData.tujuan}</strong></td>
            <td data-label="Driver">${tripData.driverName||'-'}</td><td data-label="No. Polisi">${tripData.nopol}</td>
            <td data-label="Muatan">${tripData.muatan||'-'}</td><td data-label="Tanggal">${fmtDate(tripData.tanggal)}</td>`;
          tr.append(statusCell, actionsCell);
          elements.tripList.appendChild(tr);
        });
      }
      
      const totalPages = Math.ceil(allMyTrips.length / rowsPerPage);
      elements.coorPageInfo.textContent = `Halaman ${page} dari ${totalPages}`;
      elements.prevCoorBtn.disabled = page === 1;
      elements.nextCoorBtn.disabled = page === totalPages;
    }
    
    elements.prevCoorBtn.addEventListener('click', () => displayMyTrips(currentCoorPage - 1));
    elements.nextCoorBtn.addEventListener('click', () => displayMyTrips(currentCoorPage + 1));

    function loadMyTrips() {
      const tripsRef = ref(db, 'trips');
      onValue(tripsRef, (snapshot) => {
        allMyTrips = [];
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            if (child.val().coorId === currentUser.uid) {
              allMyTrips.push({ id: child.key, data: child.val() });
            }
          });
        }
        allMyTrips.reverse(); 
        displayMyTrips(1);
        loadDriverPerformance();
      });
    }

    elements.logoutBtn.addEventListener('click', async () => {
        if (currentUser) await update(ref(db, `users/${currentUser.uid}`), { online: false });
        signOut(auth).catch(err => console.error("Logout Gagal:", err));
    });
  </script>
</body>
</html>
