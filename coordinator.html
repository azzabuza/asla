<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>Koordinator Panel</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div class="content-wrapper">
    <nav class="header-panel">selamat datang</nav>
    <nav class="sidebar">
      <div class="sidebar-header">
        <h2>Koordinator</h2>
      </div>
      <div class="sidebar-account">
        <p id="userName">Memuat...</p>
        <small id="userEmail">Memuat...</small>
      </div>
      <ul class="sidebar-menu">
        <li><a href="#dashboard" class="nav-link active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <li><a href="#list" class="nav-link"><i class="fas fa-list-alt"></i> Daftar Perjalanan</a></li>
        <li><a href="#add" class="nav-link"><i class="fas fa-plus"></i> Tambah Perjalanan</a></li>
        <li><a href="#performance" class="nav-link"><i class="fas fa-chart-bar"></i> Kinerja Supir</a></li>
        <li><a href="#availability" class="nav-link"><i class="fas fa-users-cog"></i> Ketersediaan</a></li>
        <li><a href="#reports" class="nav-link"><i class="fas fa-file-download"></i> Laporan</a></li>
        <li><a href="#notifications" class="nav-link"><i class="fas fa-bell"></i> Notifikasi <span id="notificationCount" class="notification-badge" style="display:none;">0</span></a></li>
      </ul>
      <div class="sidebar-footer">
        <button id="logoutBtn" class="logout-button"><i class="fa-solid fa-right-from-bracket"></i> Keluar</button>
        <p>V.3.1.0 (BETA)</p>
      </div>
    </nav>

    <main class="main-content">
      <header class="main-header">
        <h1 id="pageTitle"><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
        <p id="pageSubtitle">Ringkasan aktivitas dan perjalanan Anda.</p>
      </header>
      
      <div id="page-dashboard" class="page active">
        <div class="dashboard-grid">
            <div class="stat-card">
                <h3>Total Perjalanan Dibuat</h3>
                <p id="totalMyTrips">0</p>
            </div>
            <div class="stat-card">
                <h3>Perjalanan Bulan Ini</h3>
                <p id="myTripsThisMonth">0</p>
            </div>
            <div class="stat-card">
                <h3>Perjalanan Bulan Lalu</h3>
                <p id="myTripsLastMonth">0</p>
            </div>
        </div>
        <div class="card" style="margin-top: 2rem;">
            <h2 class="card-header">Aktivitas Perjalanan Terkini</h2>
            <div class="card-body">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Deskripsi</th>
                                <th>Tanggal</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivityCoordinatorList">
                            <tr><td colspan="3">Memuat aktivitas...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="coor-activity-pagination-controls" style="display: flex; margin-top: 2rem; text-align: center; gap: 2rem;">
                    <button id="prevCoorActivityBtn">Sebelumnya</button>
                    <span id="coorActivityPageInfo" style="color: var(--light-lavender); font-size: 1.5rem; font-weight: 500; margin: 0 1rem; padding: 0;"></span>
                    <button id="nextCoorActivityBtn">Berikutnya</button>
                </div>
            </div>
        </div>
      </div>

      <div id="page-list" class="page">
        <section class="card">
          <h2 class="card-header">Daftar Perjalanan Dibuat</h2>
          <div class="card-body">
            <div class="table-controls">
                <div class="form-group">
                    <label>Filter Status</label>
                    <select id="filterMyTripStatus">
                        <option value="all">Semua</option>
                        <option value="submitted">Menunggu</option>
                        <option value="approved">Disetujui</option>
                        <option value="rejected">Ditolak</option>
                        <option value="arrived">Selesai</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cari Supir / Rute / Trip ID</label>
                    <input type="text" id="searchMyTrip" />
                </div>
            </div>
            <div class="table-responsive">
              <table>
                <thead>
                  <tr>
                    <th>Trip ID</th>
                    <th>Rute</th>
                    <th>Supir</th>
                    <th>No. Kendaraan</th>
                    <th>Tanggal</th>
                    <th>Status</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="tripList">
                  <tr><td colspan="7">Memuat data...</td></tr>
                </tbody>
              </table>
            </div>
            <div id="coor-pagination-controls" style="display:none; margin-top:1.5rem; text-align:center;">
              <button id="prevCoorBtn" class="btn-sm info">Sebelumnya</button>
              <span id="coorPageInfo" style="margin: 0 1rem; font-weight: 500;"></span>
              <button id="nextCoorBtn" class="btn-sm info">Berikutnya</button>
            </div>
          </div>
        </section>
      </div>

      <div id="page-add" class="page">
        <section class="card">
            <h2 class="card-header">Buat Data Perjalanan Baru</h2>
            <div class="card-body">
                <form id="tripForm">
                  <div class="form-group">
                    <label for="driverSelect">Supir</label>
                    <select id="driverSelect" required>
                      <option value="">Memuat daftar supir...</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="vehicleNumberSelect">Kendaraan</label>
                    <select id="vehicleNumberSelect" required>
                      <option value="">Memuat kendaraan...</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="asal">Asal</label>
                    <select id="asal" required>
                      <option value="">Memuat rute...</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="tujuan">Tujuan</label>
                    <select id="tujuan" required>
                      <option value="">Memuat rute...</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="muatan">Muatan</label>
                    <input id="muatan" type="text" required>
                  </div>
                  <div class="form-group">
                    <label for="tanggal">Tanggal Keberangkatan</label>
                    <input id="tanggal" type="date" required>
                  </div>
                  <button type="submit">Kirim Data Perjalanan</button>
                  <p id="statusMsg" class="form-status"></p>
                </form>
            </div>
        </section>
      </div>

      <div id="page-performance" class="page">
        <section class="card">
          <h2 class="card-header">Ringkasan Kinerja Supir</h2>
          <div class="card-body">
            <div class="table-controls" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>Cari Nama Supir</label>
                    <input type="text" id="searchDriverPerformance" />
                </div>
            </div>
            <div id="driverPerformanceStats">
                <p>Memuat data kinerja...</p>
            </div>
          </div>
        </section>
      </div>
      
      <div id="page-availability" class="page">
        <section class="card">
          <h2 class="card-header">Papan Pantau Ketersediaan</h2>
          <div class="card-body">
            <h4><i class="fas fa-user-tie"></i> Status Supir</h4>
            <div id="driverAvailability" class="availability-grid" style="margin-bottom: 2rem;">
              <p>Memuat status supir...</p>
            </div>
            <h4><i class="fas fa-truck"></i> Status Kendaraan</h4>
            <div id="vehicleAvailability" class="availability-grid">
              <p>Memuat status kendaraan...</p>
            </div>
          </div>
        </section>
      </div>

      <div id="page-reports" class="page">
        <section class="card">
          <h2 class="card-header">Unduh Laporan Sederhana</h2>
          <div class="card-body">
            <p style="font-size: 1.5rem; color: var(--light-lavender); margin-bottom: 2rem;">
              Anda dapat mengunduh data perjalanan yang telah Anda buat atau data kinerja supir dalam format PDF atau Excel.
            </p>
            <div class="form-group">
              <label for="reportType">Pilih Jenis Laporan</label>
              <select id="reportType">
                <option value="my_trips">Laporan Perjalanan Saya</option>
                <option value="driver_performance">Laporan Kinerja Supir</option>
              </select>
            </div>
            <div class="report-buttons">
              <button id="exportPdfBtn" class="btn-sm danger"><i class="fas fa-file-pdf"></i> Unduh PDF</button>
              <button id="exportExcelBtn" class="btn-sm success"><i class="fas fa-file-excel"></i> Unduh Excel</button>
            </div>
          </div>
        </section>
      </div>

      <div id="page-notifications" class="page">
        <section class="card">
          <h2 class="card-header">Pusat Notifikasi</h2>
          <div class="card-body">
            <div class="table-responsive">
              <table>
                <thead><tr><th>Waktu</th><th>Pesan</th><th>Status</th></tr></thead>
                <tbody id="notificationList">
                  <tr><td colspan="3">Memuat notifikasi...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
      
    </main>
  </div>

  <div id="mapModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2 id="mapModalTitle">Lokasi Perjalanan</h2>
      <div id="map-placeholder">
        <i class="fas fa-map-marked-alt fa-3x"></i>
        <p>Fitur pelacakan peta sedang dalam pengembangan.</p>
        <p>Di sini akan ditampilkan lokasi supir secara real-time.</p>
      </div>
    </div>
  </div>

  <div id="barcodeModal" class="modal">
    <div class="modal-content barcode-modal-content">
        <span class="close-modal" id="closeBarcodeModal">&times;</span>
        <h2>QR Code Trip ID</h2>
        <div class="barcode-container">
            <div id="qrcode"></div>
            <code id="qrcode-text"></code>
        </div>
        <div class="barcode-actions">
            <button id="downloadBarcodeBtn" class="btn-sm success"><i class="fas fa-download"></i> Unduh</button>
            <button id="printBarcodeBtn" class="btn-sm info"><i class="fas fa-print"></i> Print</button>
        </div>
    </div>
  </div>


  <script type="module">
    import { 
      auth, onAuthStateChanged, signOut, db, ref, get, push, set, onValue, 
      query, orderByChild, equalTo, update, onDisconnect
    } from './firebase.js';
    import { badge, fmtDate, el } from './utils.js';

    const pageContent = {
        dashboard: { title: '<i class="fas fa-tachometer-alt"></i> Dashboard', subtitle: 'Ringkasan aktivitas dan perjalanan Anda.' },
        list: { title: '<i class="fas fa-list-alt"></i> Status Perjalanan Saya', subtitle: 'Pantau semua perjalanan yang telah Anda buat di sini.' },
        add: { title: '<i class="fas fa-plus"></i> Tambah Perjalanan', subtitle: 'Buat data perjalanan baru untuk supir.' },
        performance: { title: '<i class="fas fa-chart-bar"></i> Kinerja Supir', subtitle: 'Lihat ringkasan performa dari semua supir.' },
        availability: { title: '<i class="fas fa-users-cog"></i> Ketersediaan', subtitle: 'Pantau status supir dan kendaraan secara real-time.' },
        reports: { title: '<i class="fas fa-file-download"></i> Laporan', subtitle: 'Unduh data perjalanan dan kinerja dalam format PDF atau Excel.' },
        notifications: { title: '<i class="fas fa-bell"></i> Notifikasi', subtitle: 'Lihat semua pembaruan penting terkait perjalanan Anda.' }
    };

    const elements = {
      pageTitle: document.getElementById('pageTitle'),
      pageSubtitle: document.getElementById('pageSubtitle'),
      navLinks: document.querySelectorAll('.nav-link'),
      pages: document.querySelectorAll('.page'),
      userName: document.getElementById('userName'),
      userEmail: document.getElementById('userEmail'),
      tripForm: document.getElementById('tripForm'),
      tripList: document.getElementById('tripList'),
      driverSelect: document.getElementById('driverSelect'),
      vehicleNumberSelect: document.getElementById('vehicleNumberSelect'),
      asalSelect: document.getElementById('asal'),
      tujuanSelect: document.getElementById('tujuan'),
      logoutBtn: document.getElementById('logoutBtn'),
      statusMsg: document.getElementById('statusMsg'),
      filterMyTripStatus: document.getElementById('filterMyTripStatus'),
      searchMyTrip: document.getElementById('searchMyTrip'),
      coorPaginationControls: document.getElementById('coor-pagination-controls'),
      prevCoorBtn: document.getElementById('prevCoorBtn'),
      nextCoorBtn: document.getElementById('nextCoorBtn'),
      coorPageInfo: document.getElementById('coorPageInfo'),
      searchDriverPerformance: document.getElementById('searchDriverPerformance'),
      driverPerformanceStats: document.getElementById('driverPerformanceStats'),
      totalMyTrips: document.getElementById('totalMyTrips'),
      myTripsThisMonth: document.getElementById('myTripsThisMonth'),
      myTripsLastMonth: document.getElementById('myTripsLastMonth'),
      recentActivityCoordinatorList: document.getElementById('recentActivityCoordinatorList'),
      coorActivityPaginationControls: document.getElementById('coor-activity-pagination-controls'),
      prevCoorActivityBtn: document.getElementById('prevCoorActivityBtn'),
      nextCoorActivityBtn: document.getElementById('nextCoorActivityBtn'),
      coorActivityPageInfo: document.getElementById('coorActivityPageInfo'),
      driverAvailability: document.getElementById('driverAvailability'),
      vehicleAvailability: document.getElementById('vehicleAvailability'),
      notificationCount: document.getElementById('notificationCount'),
      notificationList: document.getElementById('notificationList'),
      exportPdfBtn: document.getElementById('exportPdfBtn'),
      exportExcelBtn: document.getElementById('exportExcelBtn'),
      reportType: document.getElementById('reportType'),
      mapModal: document.getElementById('mapModal'),
      mapModalTitle: document.getElementById('mapModalTitle'),
      closeModal: document.querySelector('#mapModal .close-modal'),
      barcodeModal: document.getElementById('barcodeModal'),
      closeBarcodeModal: document.getElementById('closeBarcodeModal'),
      qrcodeContainer: document.getElementById('qrcode'),
      qrcodeText: document.getElementById('qrcode-text'),
      downloadBarcodeBtn: document.getElementById('downloadBarcodeBtn'),
      printBarcodeBtn: document.getElementById('printBarcodeBtn'),
    };
    
    document.getElementById('tanggal').min = new Date().toISOString().split("T")[0];
    
    let currentUser = null;
    let allMyTrips = [];
    let allDrivers = [];
    let allVehicles = [];
    let allUsers = {};
    let notifications = [];
    let qrcodeGenerator = null;
    let currentTripIdForBarcode = null;
    let currentCoorPage = 1;
    let currentCoorActivityPage = 1;
    const coorActivityRowsPerPage = 5;
    const rowsPerPage = 10;

    function generateTripId() {
        const now = new Date();
        const year = String(now.getFullYear()).slice(-2);
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const randomChars = Math.random().toString(36).substring(2, 6).toUpperCase();
        return `TRP-${year}${month}${day}-${randomChars}`;
    }

    function setupCoordinatorNavigation() {
        elements.navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                elements.pages.forEach(page => page.classList.remove('active'));
                elements.navLinks.forEach(nav => nav.classList.remove('active'));
                document.getElementById(`page-${targetId}`).classList.add('active');
                link.classList.add('active');
                elements.pageTitle.innerHTML = pageContent[targetId].title;
                elements.pageSubtitle.textContent = pageContent[targetId].subtitle;

                if(targetId === 'notifications') {
                  markNotificationsAsRead();
                }
            });
        });
    }
    setupCoordinatorNavigation();

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = 'index.html';
      currentUser = user;
      const userRef = ref(db, 'users/' + currentUser.uid);
      onValue(userRef, (snap) => {
        if (snap.exists()) {
            const userData = snap.val();
            if (userData.locked || userData.role !== 'coordinator') {
                alert('Akses Anda telah dinonaktifkan sementara. Anda akan dikeluarkan.');
                signOut(auth);
            }
        } else {
            alert('Akun Anda tidak lagi terdaftar. Anda akan dikeluarkan.');
            signOut(auth);
        }
      });
      const snap = await get(userRef);
      if (!snap.exists()) return;
      const userData = snap.val();
      elements.userName.textContent = userData.name || 'Koordinator';
      elements.userEmail.textContent = currentUser.email;
      await update(userRef, { lastLogin: Date.now(), online: true });
      onDisconnect(ref(db, `users/${user.uid}/online`)).set(false);
      
      loadAllUsers(); 
      loadMyTrips();
      loadDrivers(); 
      loadRoutes();
      loadVehicles();
      setupEventListeners();
    });

    function setupEventListeners() {
        elements.filterMyTripStatus.onchange = () => displayMyTrips(1);
        elements.searchMyTrip.oninput = () => displayMyTrips(1);
        elements.searchDriverPerformance.oninput = () => loadDriverPerformance();
        elements.exportPdfBtn.onclick = () => handleExport('pdf');
        elements.exportExcelBtn.onclick = () => handleExport('excel');
        
        elements.closeModal.onclick = () => elements.mapModal.style.display = 'none';
        elements.closeBarcodeModal.onclick = () => elements.barcodeModal.style.display = 'none';

        window.onclick = (event) => {
          if (event.target == elements.mapModal) elements.mapModal.style.display = "none";
          if (event.target == elements.barcodeModal) elements.barcodeModal.style.display = "none";
        }

        elements.downloadBarcodeBtn.onclick = () => {
            const canvas = elements.qrcodeContainer.querySelector('canvas');
            if (canvas) {
                const a = document.createElement("a");
                a.download = `${currentTripIdForBarcode}-qrcode.png`;
                a.href = canvas.toDataURL("image/png");
                a.click();
            }
        };

        elements.printBarcodeBtn.onclick = () => {
            const qrCodeImage = elements.qrcodeContainer.querySelector('img');
            const tripIdText = elements.qrcodeText.textContent;
            if (qrCodeImage) {
                const printWindow = window.open('', '', 'height=400,width=400');
                printWindow.document.write('<html><head><title>Print QR Code</title>');
                printWindow.document.write('<style>body { text-align: center; font-family: sans-serif; }</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write('<img src="' + qrCodeImage.src + '" style="width: 250px;">');
                printWindow.document.write('<h3>' + tripIdText + '</h3>');
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.focus();
                printWindow.onload = function() {
                    printWindow.print();
                    printWindow.close();
                };
            }
        };
    }

    async function loadAllUsers() {
      onValue(ref(db, 'users'), (snapshot) => {
          allUsers = snapshot.val() || {};
      });
    }

    async function loadVehicles() {
      try {
        onValue(ref(db, 'vehicles'), (snapshot) => {
          allVehicles = [];
          elements.vehicleNumberSelect.innerHTML = '<option value="">-- Pilih Kendaraan --</option>';
          if (snapshot.exists()) {
            snapshot.forEach(child => {
              const vehicle = { id: child.key, ...child.val() };
              allVehicles.push(vehicle);
              const optionText = `${vehicle.vehicleNumber} (${vehicle.unit || 'N/A'})`;
              const option = el('option', optionText, { value: vehicle.vehicleNumber });
              elements.vehicleNumberSelect.appendChild(option);
            });
          }
          displayAvailability();
        });
      } catch (error) { console.error("Gagal memuat kendaraan:", error); }
    }
    
    async function loadRoutes() {
      try {
        const snapshot = await get(ref(db, 'routes'));
        elements.asalSelect.innerHTML = '<option value="">-- Pilih Asal --</option>';
        elements.tujuanSelect.innerHTML = '<option value="">-- Pilih Tujuan --</option>';
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const route = child.val();
            const optionText = `${route.code} - ${route.address}`;
            const optionValue = route.address;
            const optionAsal = el('option', optionText, { value: optionValue });
            const optionTujuan = el('option', optionText, { value: optionValue });
            elements.asalSelect.appendChild(optionAsal);
            elements.tujuanSelect.appendChild(optionTujuan);
          });
        }
      } catch (error) { console.error("Gagal memuat rute:", error); }
    }

    async function loadDrivers() {
        try {
            onValue(ref(db, 'users'), (snapshot) => {
                allDrivers = [];
                elements.driverSelect.innerHTML = '<option value="">-- Pilih Supir --</option>';
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const user = { uid: child.key, ...child.val() };
                        if (user.role === 'driver' && !user.locked) {
                            allDrivers.push(user);
                            if (user.name) {
                                const option = el('option', user.name, { value: user.uid });
                                elements.driverSelect.appendChild(option);
                            }
                        }
                    });
                    if (allDrivers.length === 0) {
                        elements.driverSelect.innerHTML = '<option value="">Tidak ada supir aktif</option>';
                    }
                } else {
                    elements.driverSelect.innerHTML = '<option value="">Tidak ada data user</option>';
                }
                displayAvailability();
            });
        } catch (error) { 
            console.error("Gagal memuat daftar supir:", error); 
            elements.driverSelect.innerHTML = '<option value="">Gagal memuat supir</option>';
        }
    }

    elements.tripForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      elements.statusMsg.style.display = 'block';
      elements.statusMsg.textContent = 'Mengirim...';
      if (!currentUser) return alert('Anda belum login.');

      const selectedDriverOption = elements.driverSelect.options[elements.driverSelect.selectedIndex];
      const driverId = selectedDriverOption.value;
      const driverName = selectedDriverOption.text;
      if (!driverId) {
        alert('Silakan pilih supir terlebih dahulu.');
        elements.statusMsg.textContent = '';
        return;
      }
      
      const vehicleNumber = document.getElementById('vehicleNumberSelect').value;
      const activeTrips = allMyTrips.map(t => t.data);
      const isDriverBusy = activeTrips.some(t => t.driverId === driverId && t.status === 'approved');
      const isVehicleBusy = activeTrips.some(t => t.vehicleNumber === vehicleNumber && t.status === 'approved');

      if(isDriverBusy) {
          alert(`Supir ${driverName} sedang dalam perjalanan lain.`);
          elements.statusMsg.textContent = '';
          return;
      }
      if(isVehicleBusy) {
          alert(`Kendaraan ${vehicleNumber} sedang digunakan dalam perjalanan lain.`);
          elements.statusMsg.textContent = '';
          return;
      }

      const data = {
        coorId: currentUser.uid, 
        driverId, 
        driverName,
        vehicleNumber: vehicleNumber,
        asal: document.getElementById('asal').value,
        tujuan: document.getElementById('tujuan').value,
        muatan: document.getElementById('muatan').value,
        tanggal: document.getElementById('tanggal').value,
        status: 'submitted', 
        createdAt: Date.now(),
        approvedBy: null, approvedAt: null, rejectedBy: null,
        rejectedAt: null, arrivedAt: null, isRead_coor: false
      };
      
      for(const key in data) {
          if(!data[key] && key !== 'driverName' && key.indexOf('By') === -1 && key.indexOf('At') === -1 && key.indexOf('isRead') === -1) { 
              alert(`Kolom ${key} tidak boleh kosong.`);
              elements.statusMsg.textContent = '';
              return;
          }
      }

      try {
        const newTripId = generateTripId();
        const newTripRef = ref(db, 'trips/' + newTripId);
        await set(newTripRef, data);
        elements.tripForm.reset();
        elements.statusMsg.textContent = '✔️ Data berhasil dikirim.';
        setTimeout(() => {
            elements.statusMsg.textContent = '';
            elements.statusMsg.style.display = 'none';
            document.querySelector('.nav-link[href="#list"]').click();
        }, 2000);
      } catch(err) {
        elements.statusMsg.style.color = 'var(--danger)';
        elements.statusMsg.textContent = 'Gagal mengirim data: ' + err.message;
      }
    });

    function displayRecentCoordinatorActivity(page) {
        elements.recentActivityCoordinatorList.innerHTML = '';
        currentCoorActivityPage = page;
        const start = (page - 1) * coorActivityRowsPerPage;
        const paginatedActivities = allMyTrips.slice(start, start + coorActivityRowsPerPage);
        elements.coorActivityPaginationControls.style.display = allMyTrips.length >= 20 ? 'flex' : 'none';
        if (allMyTrips.length === 0) {
            elements.recentActivityCoordinatorList.innerHTML = '<tr><td colspan="3" class="empty-state">Belum ada aktivitas perjalanan.</td></tr>';
        } else {
            paginatedActivities.forEach(({data: trip}) => {
                const tr = el('tr');
                const description = `Perjalanan untuk <strong>${trip.driverName || 'N/A'}</strong> ke <strong>${trip.tujuan}</strong>`;
                const statusCell = el('td');
                statusCell.appendChild(badge(trip.status));
                tr.innerHTML = `<td data-label="Deskripsi">${description}</td><td data-label="Tanggal">${fmtDate(trip.tanggal)}</td>`;
                tr.appendChild(statusCell);
                elements.recentActivityCoordinatorList.appendChild(tr);
            });
        }
        const totalPages = Math.ceil(allMyTrips.length / coorActivityRowsPerPage);
        elements.coorActivityPageInfo.textContent = `Halaman ${page} dari ${totalPages}`;
        elements.prevCoorActivityBtn.disabled = page === 1;
        elements.nextCoorActivityBtn.disabled = page === totalPages;
    }
    elements.prevCoorActivityBtn.addEventListener('click', () => displayRecentCoordinatorActivity(currentCoorActivityPage - 1));
    elements.nextCoorActivityBtn.addEventListener('click', () => displayRecentCoordinatorActivity(currentCoorActivityPage + 1));

    function loadCoordinatorDashboardStats() {
        elements.totalMyTrips.textContent = allMyTrips.length;
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        let thisMonthCount = 0;
        let lastMonthCount = 0;
        allMyTrips.forEach(({data: trip}) => {
            const tripDate = new Date(trip.tanggal + "T00:00:00");
            const tripYear = tripDate.getFullYear();
            const tripMonth = tripDate.getMonth();
            if (tripYear === currentYear && tripMonth === currentMonth) {
                thisMonthCount++;
            }
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            if (tripYear === lastMonthYear && tripMonth === lastMonth) {
                lastMonthCount++;
            }
        });
        elements.myTripsThisMonth.textContent = thisMonthCount;
        elements.myTripsLastMonth.textContent = lastMonthCount;
        displayRecentCoordinatorActivity(1);
    }
    
    function loadDriverPerformance() {
        const performance = {};
        allMyTrips.forEach(({data: trip}) => {
            if (!trip.driverId) return;
            if (!performance[trip.driverId]) {
                performance[trip.driverId] = { name: trip.driverName, total: 0, arrived: 0, approved: 0, submitted: 0, rejected: 0 };
            }
            performance[trip.driverId].total++;
            if (trip.status) performance[trip.driverId][trip.status]++;
        });
        const searchTerm = elements.searchDriverPerformance.value.toLowerCase();
        const filteredPerformance = Object.values(performance).filter(d => !searchTerm || (d.name || '').toLowerCase().includes(searchTerm));
        let tableHTML = `<div class="table-responsive"><table><thead><tr><th>Nama Supir</th><th>Total</th><th>Selesai</th><th>Jalan</th><th>Menunggu</th><th>Ditolak</th></tr></thead><tbody>`;
        if (filteredPerformance.length === 0) {
            tableHTML += '<tr><td colspan="6" class="empty-state">Tidak ada data kinerja ditemukan.</td></tr>';
        } else {
            filteredPerformance.forEach(d => {
                tableHTML += `<tr><td>${d.name}</td><td>${d.total}</td><td style="color: var(--green);">${d.arrived || 0}</td><td style="color: var(--blue);">${d.approved || 0}</td><td style="color: var(--light-orange);">${d.submitted || 0}</td><td style="color: var(--red);">${d.rejected || 0}</td></tr>`;
            });
        }
        elements.driverPerformanceStats.innerHTML = tableHTML + '</tbody></table></div>';
    }

    function displayMyTrips(page) {
      elements.tripList.innerHTML = '';
      currentCoorPage = page;
      const searchTerm = elements.searchMyTrip.value.toLowerCase();
      const statusFilter = elements.filterMyTripStatus.value;
      const filteredTrips = allMyTrips.filter(({id, data: trip}) => {
          const statusMatch = statusFilter === 'all' || trip.status === statusFilter;
          const searchMatch = !searchTerm ||
              (id || '').toLowerCase().includes(searchTerm) ||
              (trip.driverName || '').toLowerCase().includes(searchTerm) ||
              (trip.asal || '').toLowerCase().includes(searchTerm) ||
              (trip.tujuan || '').toLowerCase().includes(searchTerm) ||
              (trip.vehicleNumber || '').toLowerCase().includes(searchTerm);
          return statusMatch && searchMatch;
      });
      const start = (page - 1) * rowsPerPage;
      const paginatedTrips = filteredTrips.slice(start, start + rowsPerPage);
      if (paginatedTrips.length === 0 && filteredTrips.length > 0) {
        return displayMyTrips(Math.ceil(filteredTrips.length / rowsPerPage));
      }
      elements.coorPaginationControls.style.display = filteredTrips.length > rowsPerPage ? 'block' : 'none';
      if (filteredTrips.length === 0) {
        elements.tripList.innerHTML = '<tr><td colspan="7" class="empty-state">Tidak ada data perjalanan ditemukan.</td></tr>';
      } else {
        paginatedTrips.forEach(({id: tripId, data: tripData}) => {
          const tr = el('tr');
          const actionsCell = el('td', '', {'data-label': 'Aksi'});
          const actionsContainer = el('div', '', { class: 'trip-actions', style: 'justify-content:flex-start; gap: 0.5rem;' });
          
          const barcodeButton = el('button', '<i class="fas fa-qrcode"></i>', { class: 'btn-sm' });
          barcodeButton.onclick = () => {
              currentTripIdForBarcode = tripId;
              elements.qrcodeContainer.innerHTML = '';
              new QRCode(elements.qrcodeContainer, {
                  text: tripId,
                  width: 256,
                  height: 256,
                  colorDark : "#000000",
                  colorLight : "#ffffff",
                  correctLevel : QRCode.CorrectLevel.H
              });
              elements.qrcodeText.textContent = tripId;
              elements.barcodeModal.style.display = 'block';
          };
          
          if (tripData.status === 'approved' || tripData.status === 'delivering' || tripData.status === 'arriving_soon' || tripData.status === 'arrived') {
            const sjButton = el('button', '<i class="fas fa-print"></i> SJ', { class: 'btn-sm info' });
            const invButton = el('button', '<i class="fas fa-file-invoice"></i> Inv', { class: 'btn-sm info' });
            const mapButton = el('button', '<i class="fas fa-map-marker-alt"></i> Lacak', { class: 'btn-sm success' });
            
            sjButton.onclick = () => window.open(`surat-jalan.html?id=${tripId}`);
            invButton.onclick = () => window.open(`invoice.html?id=${tripId}`);
            mapButton.onclick = () => {
              elements.mapModalTitle.textContent = `Lokasi Perjalanan: ${tripData.driverName}`;
              elements.mapModal.style.display = 'block';
            };
            actionsContainer.append(barcodeButton, sjButton, invButton, mapButton);
          } else {
            actionsContainer.append(barcodeButton);
          }
          actionsCell.appendChild(actionsContainer);
          const statusCell = el('td', '', {'data-label': 'Status'});
          statusCell.appendChild(badge(tripData.status));
          tr.innerHTML = `
            <td data-label="Trip ID"><code>${tripId}</code></td>
            <td data-label="Rute">${tripData.asal} → ${tripData.tujuan}</td>
            <td data-label="Driver">${tripData.driverName||'-'}</td>
            <td data-label="No. Kendaraan">${tripData.vehicleNumber}</td>
            <td data-label="Tanggal">${fmtDate(tripData.tanggal)}</td>
          `;
          tr.append(statusCell, actionsCell);
          elements.tripList.appendChild(tr);
        });
      }
      const totalPages = Math.ceil(filteredTrips.length / rowsPerPage);
      elements.coorPageInfo.textContent = `Halaman ${page} dari ${totalPages}`;
      elements.prevCoorBtn.disabled = page === 1;
      elements.nextCoorBtn.disabled = page === totalPages;
    }
    
    elements.prevCoorBtn.addEventListener('click', () => displayMyTrips(currentCoorPage - 1));
    elements.nextCoorBtn.addEventListener('click', () => {
        const searchTerm = elements.searchMyTrip.value.toLowerCase();
        const statusFilter = elements.filterMyTripStatus.value;
        const filteredTrips = allMyTrips.filter(({id, data: trip}) => {
            const statusMatch = statusFilter === 'all' || trip.status === statusFilter;
            const searchMatch = !searchTerm || (trip.driverName || '').toLowerCase().includes(searchTerm) || (trip.asal || '').toLowerCase().includes(searchTerm) || (trip.tujuan || '').toLowerCase().includes(searchTerm) || (trip.vehicleNumber || '').toLowerCase().includes(searchTerm);
            return statusMatch && searchMatch;
        });
        const totalPages = Math.ceil(filteredTrips.length / rowsPerPage);
        if(currentCoorPage < totalPages) {
            displayMyTrips(currentCoorPage + 1);
        }
    });

    function loadMyTrips() {
      const tripsRef = query(ref(db, 'trips'), orderByChild('coorId'), equalTo(currentUser.uid));
      onValue(tripsRef, (snapshot) => {
        const previousTrips = new Map(allMyTrips.map(trip => [trip.id, trip.data]));
        allMyTrips = [];
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            allMyTrips.push({ id: child.key, data: child.val() });
          });
        }
        // Sort by createdAt timestamp in descending order (newest first)
        allMyTrips.sort((a, b) => b.data.createdAt - a.data.createdAt);

        checkForNotifications(previousTrips, new Map(allMyTrips.map(trip => [trip.id, trip.data])));
        
        displayMyTrips(1);
        loadDriverPerformance();
        loadCoordinatorDashboardStats();
        displayAvailability();
      });
    }

    function displayAvailability() {
        elements.driverAvailability.innerHTML = '';
        elements.vehicleAvailability.innerHTML = '';
        const activeTrips = allMyTrips.map(t => t.data).filter(t => ['approved', 'delivering', 'arriving_soon'].includes(t.status));

        if(allDrivers.length === 0) {
            elements.driverAvailability.innerHTML = '<p class="empty-state">Tidak ada data supir.</p>';
        } else {
            allDrivers.forEach(driver => {
                const isBusy = activeTrips.some(trip => trip.driverId === driver.uid);
                const status = isBusy ? 'in-trip' : 'available';
                const statusText = isBusy ? 'Dalam Perjalanan' : 'Tersedia';
                const card = el('div', '', { class: 'resource-card' });
                card.innerHTML = `
                    <h4><span class="status-dot ${status}"></span>${driver.name}</h4>
                    <p>${statusText}</p>
                `;
                elements.driverAvailability.appendChild(card);
            });
        }

        if(allVehicles.length === 0) {
            elements.vehicleAvailability.innerHTML = '<p class="empty-state">Tidak ada data kendaraan.</p>';
        } else {
            allVehicles.forEach(vehicle => {
                const isBusy = activeTrips.some(trip => trip.vehicleNumber === vehicle.vehicleNumber);
                const status = isBusy ? 'in-trip' : 'available';
                const statusText = isBusy ? 'Digunakan' : 'Tersedia';
                const card = el('div', '', { class: 'resource-card' });
                card.innerHTML = `
                    <h4><span class="status-dot ${status}"></span>${vehicle.vehicleNumber}</h4>
                    <p>${vehicle.unit || 'N/A'}</p>
                    <p>${statusText}</p>
                `;
                elements.vehicleAvailability.appendChild(card);
            });
        }
    }

    function checkForNotifications(previousTrips, currentTrips) {
        currentTrips.forEach((trip, id) => {
            const oldTrip = previousTrips.get(id);
            if (oldTrip && oldTrip.status !== trip.status && !trip.isRead_coor) {
                let message = '';
                let timestamp = Date.now();
                const adminName = allUsers[trip.approvedBy || trip.rejectedBy]?.name || 'Admin';
                const driverName = trip.driverName || 'Supir';
                
                switch(trip.status) {
                    case 'approved':
                        message = `Perjalanan untuk <strong>${driverName}</strong> telah disetujui oleh <strong>${adminName}</strong>.`;
                        timestamp = trip.approvedAt;
                        break;
                    case 'rejected':
                        message = `Perjalanan untuk <strong>${driverName}</strong> ditolak oleh <strong>${adminName}</strong>.`;
                        timestamp = trip.rejectedAt;
                        break;
                    case 'delivering':
                        message = `<strong>${driverName}</strong> telah memulai perjalanan.`;
                        break;
                    case 'arriving_soon':
                        message = `<strong>${driverName}</strong> dilaporkan hampir sampai tujuan.`;
                        break;
                    case 'arrived':
                        message = `<strong>${driverName}</strong> telah tiba di tujuan.`;
                        timestamp = trip.arrivedAt;
                        break;
                }

                if (message) {
                    notifications.unshift({ id, message, timestamp, status: trip.status, isRead: false });
                }
            }
        });
        updateNotificationUI();
    }
    
    function updateNotificationUI() {
        const unreadCount = notifications.filter(n => !n.isRead).length;
        if(unreadCount > 0) {
            elements.notificationCount.textContent = unreadCount;
            elements.notificationCount.style.display = 'inline-block';
        } else {
            elements.notificationCount.style.display = 'none';
        }

        elements.notificationList.innerHTML = '';
        if(notifications.length === 0) {
            elements.notificationList.innerHTML = '<tr><td colspan="3" class="empty-state">Tidak ada notifikasi baru.</td></tr>';
        } else {
            notifications.slice(0, 50).forEach(n => { 
                const tr = el('tr', '', { style: n.isRead ? '' : 'font-weight: bold;' });
                const time = n.timestamp ? new Date(n.timestamp).toLocaleString('id-ID') : '-';
                const statusCell = el('td');
                statusCell.appendChild(badge(n.status));
                tr.innerHTML = `<td>${time}</td><td>${n.message}</td>`;
                tr.appendChild(statusCell);
                elements.notificationList.appendChild(tr);
            });
        }
    }

    function markNotificationsAsRead() {
        const unreadNotifs = notifications.filter(n => !n.isRead);
        if(unreadNotifs.length > 0) {
            const updates = {};
            unreadNotifs.forEach(n => {
                updates[`/trips/${n.id}/isRead_coor`] = true;
                n.isRead = true; 
            });
            update(ref(db), updates);
        }
        updateNotificationUI(); 
    }

    function handleExport(format) {
      const { jsPDF } = window.jspdf;
      const type = elements.reportType.value;
      
      let data, headers, filename, title;

      if (type === 'my_trips') {
          title = 'Laporan Perjalanan Saya';
          filename = 'laporan_perjalanan_saya';
          headers = ["Trip ID", "Rute", "Supir", "No. Kendaraan", "Muatan", "Tanggal", "Status"];
          data = allMyTrips.map(({id, data: t}) => ({
              'Trip ID': id, 'Rute': `${t.asal} → ${t.tujuan}`, 'Supir': t.driverName,
              'No. Kendaraan': t.vehicleNumber, 'Muatan': t.muatan,
              'Tanggal': t.tanggal, 'Status': t.status
          }));
      } else { 
          title = 'Laporan Kinerja Supir';
          filename = 'laporan_kinerja_supir';
          headers = ["Nama Supir", "Total", "Selesai", "Jalan", "Menunggu", "Ditolak"];
          const performance = {};
          allMyTrips.forEach(({data: trip}) => {
              if (trip.driverId) {
                  if (!performance[trip.driverId]) {
                      performance[trip.driverId] = { name: trip.driverName, total: 0, arrived: 0, approved: 0, submitted: 0, rejected: 0 };
                  }
                  performance[trip.driverId].total++;
                  if (trip.status) performance[trip.driverId][trip.status]++;
              }
          });
          data = Object.values(performance).map(d => ({
              'Nama Supir': d.name, 'Total': d.total, 'Selesai': d.arrived || 0,
              'Jalan': d.approved || 0, 'Menunggu': d.submitted || 0, 'Ditolak': d.rejected || 0
          }));
      }

      if (data.length === 0) {
          alert('Tidak ada data untuk diekspor.');
          return;
      }
      
      if (format === 'excel') {
          const worksheet = XLSX.utils.json_to_sheet(data);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, 'Laporan');
          XLSX.writeFile(workbook, `${filename}_${new Date().toISOString().slice(0,10)}.xlsx`);
      } else { 
          const doc = new jsPDF();
          doc.text(title, 14, 16);
          const body = data.map(Object.values);
          doc.autoTable({ head: [headers], body: body, startY: 20 });
          doc.save(`${filename}_${new Date().toISOString().slice(0,10)}.pdf`);
      }
    }

    elements.logoutBtn.addEventListener('click', async () => {
        if (currentUser) await update(ref(db, `users/${currentUser.uid}`), { online: false });
        signOut(auth).catch(err => console.error("Logout Gagal:", err));
    });
  </script>
</body>
</html>
