<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="login-page">
    <div class="login-container">
      <h2>Selamat Datang</h2>
      <form id="loginForm">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="email" placeholder="Ketikkan email" autocomplete="off" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="password" placeholder="Ketikkan password" autocomplete="off" required>
        </div>
        <button type="submit"><i class="fa-solid fa-right-from-bracket"></i> Masuk</button>
      </form>
      <p id="errorMsg" style="display: none; color: red; margin-top: 1rem;"></p>
    </div>
  </div>
  <script type="module">
    // Impor client Supabase yang sudah diinisialisasi
    import { supabase } from './supabase-client.js';

    const loginForm = document.getElementById('loginForm');
    const errorMsg = document.getElementById('errorMsg');

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMsg.textContent = '';
      errorMsg.style.display = 'none';

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      try {
        // 1. Coba login dengan Supabase Auth
        const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
          email: email,
          password: password,
        });

        if (authError) {
          throw authError;
        }

        const user = authData.user;
        if (!user) {
            throw new Error("Login gagal, pengguna tidak ditemukan.");
        }

        // 2. Ambil data profil pengguna dari tabel 'users'
        const { data: userData, error: userError } = await supabase
          .from('users')
          .select('*')
          .eq('id', user.id)
          .single();

        if (userError || !userData) {
          throw userError || new Error('Profil pengguna tidak ditemukan di database.');
        }

        // 3. Cek apakah akun dikunci
        if (userData.locked) {
          await supabase.auth.signOut(); // Logout pengguna jika akun dikunci
          throw new Error('Akun Anda telah dinonaktifkan sementara. Silakan hubungi administrator.');
        }

        // 4. Arahkan berdasarkan role
        const role = userData.role;
        console.log("Login sebagai:", role, "UID:", user.id);

        if (role === 'admin' || role === 'super admin') {
          window.location.href = 'admin.html';
        } else if (role === 'coordinator') {
          window.location.href = 'coordinator.html';
        } else if (role === 'driver') {
          window.location.href = 'driver.html';
        } else {
          await supabase.auth.signOut();
          throw new Error('Role tidak dikenal: ' + role);
        }

      } catch (err) {
        console.error('Login error:', err);
        errorMsg.textContent = 'Login gagal. ' + err.message;
        errorMsg.style.display = 'block';
      }
    });
  </script>
</body>
</html>
